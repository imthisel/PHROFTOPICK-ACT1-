<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>User Settings</title>
  <link rel="stylesheet" href="/css/base.css">
  <script src="/js/theme-loader.js" defer></script>
</head>
<body>
  <div id="header-placeholder"></div>

  <main class="container">
    <h1>User Settings</h1>
    <form id="profile-form" style="max-width:700px">
      <label>Display name
        <input id="fld-display" name="display_name" />
      </label>
      <label>College
        <input id="fld-college" name="college" />
      </label>
      <label>Course
        <input id="fld-course" name="course" />
      </label>
      <label>Batch
        <input id="fld-batch" name="batch" />
      </label>
      <label>Username
        <input id="fld-username" name="username" />
      </label>
      <label>Biography
        <textarea id="fld-bio" name="bio"></textarea>
      </label>
      <label>Photo URL (or leave blank to keep OAuth photo)
        <input id="fld-photo" name="photo_path" />
      </label>
      <button type="submit">Save</button>
    </form>
    <div id="save-result"></div>
  </main>

  <script>
    // load shared header (same method you already use)
    document.addEventListener('DOMContentLoaded', async () => {
      const headerContainer = document.getElementById('header-placeholder');
      const res = await fetch('/components/header.html');
      headerContainer.innerHTML = await res.text();
      initializeHeader && initializeHeader(); // run header init if present

      const token = localStorage.getItem('token');
      if (!token) return alert('You must be logged in');

      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const meRes = await fetch(`/api/me?school=${school}`, { headers: { 'Authorization': 'Bearer ' + token }});
      if (!meRes.ok) return alert('Failed to load profile');
      const data = await meRes.json();
      const u = data.user || {};

      document.getElementById('fld-display').value = u.display_name || '';
      document.getElementById('fld-college').value = u.college || '';
      document.getElementById('fld-course').value = u.course || '';
      document.getElementById('fld-batch').value = u.batch || '';
      document.getElementById('fld-username').value = u.username || '';
      document.getElementById('fld-bio').value = u.bio || '';
      document.getElementById('fld-photo').value = u.photo_path || '';

      document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
          display_name: document.getElementById('fld-display').value.trim(),
          college: document.getElementById('fld-college').value.trim(),
          course: document.getElementById('fld-course').value.trim(),
          batch: document.getElementById('fld-batch').value.trim(),
          username: document.getElementById('fld-username').value.trim(),
          bio: document.getElementById('fld-bio').value.trim(),
          photo_path: document.getElementById('fld-photo').value.trim() || null
        };
        const save = await fetch(`/api/me?school=${school}`, {
          method: 'POST',
          headers: {
            'Content-Type':'application/json',
            'Authorization':'Bearer ' + token
          },
          body: JSON.stringify(body)
        });
        const j = await save.json();
        if (!save.ok) return document.getElementById('save-result').textContent = 'Save failed: ' + (j.error || save.status);
        document.getElementById('save-result').textContent = 'Saved!';
        // update header display & avatar
        initializeHeader && initializeHeader();
      });
    });
  </script>
  <script src="/js/app.js"></script>
</body>
</html>
