<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>User Settings</title>
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes">
  <meta name="description" content="Manage your profile, preferences, and account settings securely.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="/settings">
  <meta property="og:title" content="User Settings — Phroftopick">
  <meta property="og:description" content="Update your profile and preferences for a personalized experience.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://phroftopick.com/settings">
  <meta property="og:image" content="/images/default-logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="User Settings — Phroftopick">
  <meta name="twitter:description" content="Update your profile and preferences for a personalized experience.">
  <meta name="twitter:image" content="/images/default-logo.png">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@600;700;800&display=swap" rel="stylesheet">
  <script>
    (function preloadLogo() {
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const logoMap = {
        dlsu: 'images/dlsu-logo.png',
        ateneo: 'images/ateneo-logo.png',
        benilde: 'images/benilde-logo.png',
        up: 'images/up-logo.png',
      };
      const selectedLogo = logoMap[school] || 'images/default-logo.png';
      const img = new Image();
      img.src = selectedLogo;
      window.__PRELOADED_LOGO = selectedLogo;
    })();
  </script>
  <link rel="stylesheet" href="/css/base.css">
  <link rel="stylesheet" href="/css/mobile-override.css">
  <script src="/js/theme-loader.js" defer></script>
  <style>
    .settings-hero { max-width:980px; margin:30px auto 10px; padding:18px 20px; border-radius:16px; background: linear-gradient(180deg, rgba(0,105,62,0.06), rgba(0,0,0,0.02)); border:1px solid rgba(0,0,0,0.06); }
    .settings-grid { max-width:980px; margin:16px auto 60px; display:grid; grid-template-columns: 0.9fr 1.1fr; gap:18px; }
    .settings-card { background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:20px; box-shadow:0 8px 24px rgba(0,0,0,0.06); }
    .settings-left { text-align:center; }
    .settings-left img { width:120px; height:120px; border-radius:50%; object-fit:cover; background:#f3f4f6; }
    .form-grid { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    .form-grid label { display:block; font-weight:600; margin-bottom:6px; color:#374151; }
    .form-grid input, .form-grid select, .form-grid textarea { width:100%; padding:12px 14px; border:1px solid #d1d5db; border-radius:10px; }
    .form-grid textarea { min-height:120px; }
    .actions { display:flex; gap:10px; align-items:center; margin-top:12px; }
    @media (max-width: 900px) { .settings-grid { grid-template-columns: 1fr; } }
    html.dark .settings-card { background:#14191c; border-color:#2a2f34; }
    html.dark .settings-hero { background: linear-gradient(180deg, rgba(0,105,62,0.12), rgba(255,255,255,0.02)); border-color:#2a2f34; }
    html.dark .form-grid input, html.dark .form-grid select, html.dark .form-grid textarea { background:#0f1214; color:#e6e6e6; border-color:#2a2f34; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>

  <main>
    <section class="settings-hero container">
      <h1 style="margin:0 0 6px;">User Settings</h1>
      <p style="margin:0;color:#555;max-width:840px;">Make sure your information is true to keep our community safe and make our reviews more authentic to students!</p>
    </section>

    <section class="settings-grid container">
      <aside class="settings-card settings-left">
        <img id="settings-avatar" src="" alt="Profile">
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px; align-items:center;">
          <input id="fld-photo-file" type="file" accept="image/*" style="display:none;">
          <button id="btn-upload-photo" type="button" class="auth-btn">Upload Photo</button>
        </div>
      </aside>

      <section class="settings-card">
        <form id="profile-form">
          <div class="form-grid">
            <div>
              <label>College *</label>
              <select id="fld-college" name="college">
                <option value="">Select what college you are currently enrolled at.</option>
                <option value="CCS">CCS</option>
                <option value="CLA">CLA</option>
                <option value="COB">COB</option>
                <option value="COS">COS</option>
              </select>
            </div>
            <div>
              <label>Course *</label>
              <input id="fld-course" name="course" placeholder="Computer Science">
            </div>
            <div>
              <label>Batch ID Number *</label>
              <input id="fld-batch" name="batch" placeholder="125">
            </div>
            <div>
              <label>Username</label>
              <div style="display:flex; gap:8px;">
                <input id="fld-username" name="username" placeholder="immanuel-angeles-a6" style="flex:1;">
                <button id="btn-check-username" type="button" class="auth-btn" style="white-space:nowrap;">Check</button>
              </div>
            </div>
            <div style="grid-column:1/-1;">
              <label>Display Name</label>
              <input id="fld-display" name="display_name" placeholder="Your full name from Google">
            </div>
            <div style="grid-column:1/-1;">
              <label>Biography</label>
              <textarea id="fld-bio" name="bio" placeholder="Type your biography here" rows="4"></textarea>
            </div>
          </div>

          <div class="settings-card" style="padding:16px; margin-top:16px;">
            <h3 style="margin-bottom:8px;">Platform Notifications</h3>
            <label style="display:flex; align-items:center; gap:10px;">
              <input id="notif-toggle" type="checkbox"> Enable notifications
            </label>
          </div>

          <div class="actions">
            <button type="submit" class="auth-btn">Save Changes</button>
            <button id="btn-reset" type="button">Reset</button>
            <span id="save-result" style="margin-left:12px;"></span>
          </div>
        </form>
      </section>
    </section>

  <section id="contact" class="settings-card container" style="max-width:980px;">
      <h3>Contact Us</h3>
      <p style="color:#555;">For inquiries, issues, or feedback, contact us at <a href="mailto:phroftopick@gmail.com">phroftopick@gmail.com</a>.</p>
    </section>
  </main>

  <script>
    // ---------- Header insertion + safe loader for /js/app.js ----------
    document.addEventListener('DOMContentLoaded', async () => {
      const headerContainer = document.getElementById('header-placeholder');
      if (!headerContainer) {
        console.warn('Header placeholder not found');
        return;
      }

      try {
        // 1) Insert header HTML
        const res = await fetch('/components/header.html');
        if (!res.ok) throw new Error('Failed to fetch header.html: ' + res.status);
        headerContainer.innerHTML = await res.text();

        // Let browser parse inserted nodes
        await new Promise(requestAnimationFrame);

        // 2) Dynamically load /js/app.js AFTER header exists
        await new Promise((resolve, reject) => {
          // avoid duplicate load
          if (document.querySelector('script[src="/js/app.js"]')) {
            return resolve();
          }
          const s = document.createElement('script');
          s.src = '/js/app.js';
          s.async = false; // keep execution order
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('Failed to load /js/app.js'));
          document.head.appendChild(s);
        });

        // 3) Call header helpers in safe order (if present)
        if (typeof window.updateSchoolLogo === 'function') {
          try { window.updateSchoolLogo(); } catch(e){ console.warn('updateSchoolLogo error',e); }
        }
        if (typeof window.initializeHeader === 'function') {
          await window.initializeHeader();
        }
        if (typeof window.updateAuthUI === 'function') {
          try { window.updateAuthUI(); } catch(e){ console.warn('updateAuthUI error',e); }
        }
        // updateAuthUI will be called after profile data loads or after we confirm no token
        // optional header search init if those exist in app.js
        if (typeof window.initializeHeaderSearch === 'function') {
          try { window.initializeHeaderSearch(); } catch(e){ console.warn('initializeHeaderSearch error',e); }
        }
        if (typeof window.enableAutocomplete === 'function') {
          try { window.enableAutocomplete('prof-search', 'header-suggestions'); } catch(e){ console.warn('enableAutocomplete error',e); }
        }

        console.log('Header injected and initialized (settings).');
      } catch (err) {
        console.error('Header load/init failed:', err);
      }

     // ---------- Profile load & save logic (robust version) ----------
let token = localStorage.getItem('token') || sessionStorage.getItem('token') || null;

// Support token coming via URL (helpful for some OAuth setups)
const urlToken = new URLSearchParams(window.location.search).get('token');
if (!token && urlToken) {
  // Persist URL token to localStorage for subsequent pages
  localStorage.setItem('token', urlToken);
  localStorage.setItem('user_display', decodeURIComponent(new URLSearchParams(window.location.search).get('display') || 'You'));
  token = urlToken;
}

const schoolSelected = localStorage.getItem('selectedSchool') || 'dlsu';
const schoolFromToken = (typeof window.tokenSchool === 'function') ? window.tokenSchool(token) : null;
const school = schoolFromToken || schoolSelected;

// If no token, show login prompt and don't make API calls
if (!token) {
  console.warn('No token found — user must sign in to access settings.');
  // Update auth UI to show logged-out state
  if (typeof window.updateAuthUI === 'function') {
    try { window.updateAuthUI(); } catch(e){ console.warn('updateAuthUI error',e); }
  }
  // Show a user-friendly message
  const settingsGrid = document.querySelector('.settings-grid');
  if (settingsGrid) {
    settingsGrid.innerHTML = `
      <div class="settings-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
        <h3 style="margin-bottom: 12px; color: #374151;">Sign In Required</h3>
        <p style="margin-bottom: 20px; color: #6b7280;">You need to be signed in to view and edit your profile settings.</p>
        <a href="/home" class="auth-btn" style="display: inline-block; text-decoration: none;">Go to Sign In</a>
      </div>
    `;
  }
  return; // Stop execution here
}

// If we have a token, try to load profile
try {
  const meRes = await fetch(`/api/me?school=${school}`, {
    headers: { 'Authorization': 'Bearer ' + token }
  });
  
  if (!meRes.ok) {
    // Handle 401 - invalid/expired token
    if (meRes.status === 401) {
      console.warn('Token is invalid or expired');
      // Clear invalid token
      // Attempt token renewal once
      try {
        const renew = await fetch(`/api/auth/renew?school=${school}`, { method:'POST', headers: { 'Authorization': 'Bearer ' + token } });
        const rj = await renew.json().catch(()=>({}));
        if (renew.ok && rj.token) {
          localStorage.setItem('token', rj.token);
          token = rj.token;
          const retry = await fetch(`/api/me?school=${school}`, { headers: { 'Authorization': 'Bearer ' + token } });
          if (retry.ok) {
            const data2 = await retry.json();
            const u2 = data2.user || {};
            document.getElementById('fld-display').value = u2.display_name || '';
            document.getElementById('fld-college').value = u2.college || '';
            document.getElementById('fld-course').value = u2.course || '';
            document.getElementById('fld-batch').value = u2.batch || '';
            document.getElementById('fld-username').value = u2.username || '';
            document.getElementById('fld-bio').value = u2.bio || '';
            if (typeof window.updateAuthUI === 'function') { try { window.updateAuthUI(); } catch(e){} }
            return;
          }
        }
      } catch (_) {}
      localStorage.removeItem('token');
      sessionStorage.removeItem('token');
      
      // Update auth UI
      if (typeof window.updateAuthUI === 'function') {
        try { window.updateAuthUI(); } catch(e){ console.warn('updateAuthUI error',e); }
      }
      
      // Show user-friendly message
      const settingsGrid = document.querySelector('.settings-grid');
      if (settingsGrid) {
        settingsGrid.innerHTML = `
          <div class="settings-card" style="grid-column: 1 / -1; text-align: center; padding: 40px;">
            <h3 style="margin-bottom: 12px; color: #374151;">Session Expired</h3>
            <p style="margin-bottom: 20px; color: #6b7280;">Your session has expired. Please sign in again to continue.</p>
            <a href="/home" class="auth-btn" style="display: inline-block; text-decoration: none;">Sign In Again</a>
          </div>
        `;
      }
      return;
    }
    
    // Handle other errors
    const txt = await meRes.text().catch(()=>null);
    throw new Error('Failed to load profile: ' + meRes.status + ' ' + (txt||''));
  }
  
  const data = await meRes.json();
  const u = data.user || {};

  document.getElementById('fld-display').value = u.display_name || '';
  document.getElementById('fld-college').value = u.college || '';
  document.getElementById('fld-course').value = u.course || '';
  document.getElementById('fld-batch').value = u.batch || '';
  document.getElementById('fld-username').value = u.username || '';
  document.getElementById('fld-bio').value = u.bio || '';
  
  // Update avatar
  const avatar = document.getElementById('settings-avatar');
  if (avatar) {
    const src = u.photo_path || localStorage.getItem('user_photo') || '';
    if (src) {
      avatar.src = src;
    } else {
      // Use a default avatar placeholder if no photo
      avatar.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 120 120"%3E%3Crect fill="%23e5e7eb" width="120" height="120"/%3E%3Ctext x="50%25" y="50%25" dominant-baseline="middle" text-anchor="middle" fill="%23999" font-size="48" font-family="sans-serif"%3E?%3C/text%3E%3C/svg%3E';
    }
  }
  
  // NOW update auth UI after successful profile load
  if (typeof window.updateAuthUI === 'function') {
    try { window.updateAuthUI(); } catch(e){ console.warn('updateAuthUI error',e); }
  }

} catch (err) {
  console.error('Error loading profile:', err);
  alert('Failed to load profile. Please try refreshing the page or contact support if the issue persists.');
  return;
}

      // Photo upload
      const photoBtn = document.getElementById('btn-upload-photo');
      const photoInput = document.getElementById('fld-photo-file');
      if (photoBtn && photoInput) {
        photoBtn.addEventListener('click', () => photoInput.click());
        photoInput.addEventListener('change', async () => {
          const file = photoInput.files && photoInput.files[0];
          if (!file) return;
          const original = photoBtn.textContent;
          photoBtn.disabled = true;
          photoBtn.textContent = 'Uploading...';
          try {
            const formData = new FormData();
            formData.append('photo', file);
            const up = await fetch(`/api/me/photo?school=${school}`, {
              method: 'POST',
              headers: { 'Authorization': 'Bearer ' + token },
              body: formData
            });
            const j = await up.json().catch(()=>({}));
            if (!up.ok) {
              alert('Upload failed: ' + (j.error || up.status));
            } else {
              const path = j.photo_path || '';
              if (path) {
                const avatar = document.getElementById('settings-avatar');
                if (avatar) avatar.src = path;
                try { localStorage.setItem('user_photo', path); } catch (_) {}
                if (typeof window.updateAuthUI === 'function') {
                  try { window.updateAuthUI(); } catch(_){}
                }
                if (typeof window.initializeHeader === 'function') {
                  try { await window.initializeHeader(); } catch(_){}
                }
              }
            }
          } catch (err) {
            alert('Upload failed');
          } finally {
            photoBtn.disabled = false;
            photoBtn.textContent = original;
          }
        });
      }

      // Save handler
      document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
          display_name: document.getElementById('fld-display').value.trim(),
          college: document.getElementById('fld-college').value.trim(),
          course: document.getElementById('fld-course').value.trim(),
          batch: document.getElementById('fld-batch').value.trim(),
          username: document.getElementById('fld-username').value.trim(),
          bio: document.getElementById('fld-bio').value.trim(),
          notifications_enabled: document.getElementById('notif-toggle').checked ? 1 : 0
        };
        try {
          const save = await fetch(`/api/me?school=${school}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(body)
          });
          const j = await save.json().catch(()=>({}));
          if (!save.ok) {
            document.getElementById('save-result').textContent = 'Save failed: ' + (j.error || save.status);
            return;
          }
          document.getElementById('save-result').textContent = 'Saved!';
          // update header visuals after successful save
          if (typeof window.updateAuthUI === 'function') {
            window.updateAuthUI();
          }
          if (typeof window.initializeHeader === 'function') {
            // refresh header (avatar/display)
            try { window.initializeHeader(); } catch(e){ console.warn('initializeHeader after save failed', e); }
          }
        } catch (err) {
          console.error('Save failed', err);
          document.getElementById('save-result').textContent = 'Save failed (network error)';
        }
      });

      // username check (format/slug validation; optional server check if available)
      const btnCheck = document.getElementById('btn-check-username');
      if (btnCheck) {
        btnCheck.addEventListener('click', async () => {
          const el = document.getElementById('fld-username');
          const v = (el.value || '').trim();
          if (!v || !/^[-a-z0-9]+$/i.test(v.replace(/\s+/g,'-').toLowerCase())) {
            alert('Username should contain letters, numbers, or dashes.');
            return;
          }
          try {
            const r = await fetch(`/api/username-available?school=${school}&u=${encodeURIComponent(v)}`);
            if (r.ok) {
              const j = await r.json().catch(()=>({}));
              if (j && typeof j.available !== 'undefined') {
                alert(j.available ? 'Username available!' : 'Username already taken.');
                return;
              }
            }
          } catch (_) {}
          alert('Looks good.');
        });
      }

      // reset
      const btnReset = document.getElementById('btn-reset');
      if (btnReset) {
        btnReset.addEventListener('click', () => window.location.reload());
      }
    });
  </script>

  <!-- Ensure app.js is available globally across pages (static include) -->
  <script src="/js/app.js"></script>
</body>
</html>
