<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>User Settings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="stylesheet" href="/css/base.css">
  <!-- optional: add your mobile override if you have one -->
  <!-- <link rel="stylesheet" href="/css/mobile-override.css"> -->
  <script src="/js/theme-loader.js" defer></script>
</head>
<body>
  <div id="header-placeholder"></div>

  <main class="container">
    <h1>User Settings</h1>

    <p style="max-width:820px; color:#555; margin-top:6px;">Make sure your information is true to keep our community safe and make our reviews more authentic to students!</p>

    <div class="card" style="max-width:840px; margin-top:18px; padding:24px;">
      <form id="profile-form">
        <div style="display:flex; gap:24px; align-items:flex-start; flex-wrap:wrap;">
          <div style="flex:0 0 120px; text-align:center;">
            <img id="settings-avatar" src="" alt="Profile" style="width:96px; height:96px; border-radius:50%; object-fit:cover; background:#f3f3f3;">
            <div style="margin-top:10px;">
              <label for="fld-photo" class="auth-btn" style="cursor:pointer; display:inline-block;">Update Photo</label>
              <input id="fld-photo" name="photo_path" type="text" placeholder="Photo URL" style="display:block; width:100%; margin-top:8px;">
            </div>
          </div>

          <div style="flex:1 1 420px; min-width:280px;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
              <label>College *
                <select id="fld-college" name="college">
                  <option value="">Select what college you are currently enrolled at.</option>
                  <option value="CCS">CCS</option>
                  <option value="CLA">CLA</option>
                  <option value="COB">COB</option>
                  <option value="COS">COS</option>
                </select>
              </label>

              <label>Course *
                <input id="fld-course" name="course" placeholder="Computer Science">
              </label>

              <label>Batch ID Number *
                <input id="fld-batch" name="batch" placeholder="125">
              </label>

              <label>Username
                <div style="display:flex; gap:8px;">
                  <input id="fld-username" name="username" placeholder="immanuel-angeles-a6" style="flex:1;">
                  <button id="btn-check-username" type="button" class="auth-btn" style="white-space:nowrap;">Check</button>
                </div>
              </label>

              <label style="grid-column:1/-1;">Display Name
                <input id="fld-display" name="display_name" placeholder="Your full name from Google">
              </label>

              <label style="grid-column:1/-1;">Biography
                <textarea id="fld-bio" name="bio" placeholder="Type your biography here" rows="4"></textarea>
              </label>
            </div>

            <div class="card" style="padding:16px; margin-top:16px;">
              <h3 style="margin-bottom:8px;">Platform Notifications</h3>
              <label style="display:flex; align-items:center; gap:10px;">
                <input id="notif-toggle" type="checkbox"> Enable notifications
              </label>
            </div>

            <div style="margin-top:16px; display:flex; gap:10px;">
              <button type="submit" class="auth-btn">Save Changes</button>
              <button id="btn-reset" type="button">Reset</button>
              <span id="save-result" style="margin-left:12px;"></span>
            </div>
          </div>
        </div>
      </form>
    </div>

    <div id="contact" class="card" style="max-width:840px; margin-top:18px; padding:20px;">
      <h3>Contact Us</h3>
      <p style="color:#555;">For inquiries, issues, or feedback, please reach out via your preferred channel.</p>
    </div>
  </main>

  <script>
    // ---------- Header insertion + safe loader for /js/app.js ----------
    document.addEventListener('DOMContentLoaded', async () => {
      const headerContainer = document.getElementById('header-placeholder');
      if (!headerContainer) {
        console.warn('Header placeholder not found');
        return;
      }

      try {
        // 1) Insert header HTML
        const res = await fetch('/components/header.html');
        if (!res.ok) throw new Error('Failed to fetch header.html: ' + res.status);
        headerContainer.innerHTML = await res.text();

        // Let browser parse inserted nodes
        await new Promise(requestAnimationFrame);

        // 2) Dynamically load /js/app.js AFTER header exists
        await new Promise((resolve, reject) => {
          // avoid duplicate load
          if (document.querySelector('script[src="/js/app.js"]')) {
            return resolve();
          }
          const s = document.createElement('script');
          s.src = '/js/app.js';
          s.async = false; // keep execution order
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('Failed to load /js/app.js'));
          document.head.appendChild(s);
        });

        // 3) Call header helpers in safe order (if present)
        if (typeof window.updateSchoolLogo === 'function') {
          try { window.updateSchoolLogo(); } catch(e){ console.warn('updateSchoolLogo error',e); }
        }
        if (typeof window.initializeHeader === 'function') {
          // initializeHeader may be async
          await window.initializeHeader();
        }
        if (typeof window.updateAuthUI === 'function') {
          try { window.updateAuthUI(); } catch(e){ console.warn('updateAuthUI error',e); }
        }
        // optional header search init if those exist in app.js
        if (typeof window.initializeHeaderSearch === 'function') {
          try { window.initializeHeaderSearch(); } catch(e){ console.warn('initializeHeaderSearch error',e); }
        }

        console.log('Header injected and initialized (settings).');
      } catch (err) {
        console.error('Header load/init failed:', err);
      }

     // ---------- Profile load & save logic (robust version) ----------
let token = localStorage.getItem('token') || sessionStorage.getItem('token') || null;

// Support token coming via URL (helpful for some OAuth setups)
const urlToken = new URLSearchParams(window.location.search).get('token');
if (!token && urlToken) {
  // Persist URL token to localStorage for subsequent pages
  localStorage.setItem('token', urlToken);
  localStorage.setItem('user_display', decodeURIComponent(new URLSearchParams(window.location.search).get('display') || 'You'));
  token = urlToken;
}

// If no token: send the user to the OAuth sign-in (instead of a blocking alert)
// If no token, do not redirect immediately (prevents mobile loop);
// allow header to render and user to re-auth explicitly if needed.
if (!token) {
  console.warn('No token found for settings — showing page without auto-redirect.');
}


      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      try {
        const meRes = await fetch(`/api/me?school=${school}`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!meRes.ok) {
          const txt = await meRes.text().catch(()=>null);
          throw new Error('Failed to load profile: ' + meRes.status + ' ' + (txt||''));
        }
        const data = await meRes.json();
        const u = data.user || {};

        document.getElementById('fld-display').value = u.display_name || '';
        document.getElementById('fld-college').value = u.college || '';
        document.getElementById('fld-course').value = u.course || '';
        document.getElementById('fld-batch').value = u.batch || '';
        document.getElementById('fld-username').value = u.username || '';
        document.getElementById('fld-bio').value = u.bio || '';
        document.getElementById('fld-photo').value = u.photo_path || '';
        const avatar = document.getElementById('settings-avatar');
        if (avatar) {
          const src = u.photo_path || localStorage.getItem('user_photo') || '';
          if (src) avatar.src = src;
        }

      } catch (err) {
        console.error(err);
        return alert('Failed to load profile — check console for details.');
      }

      // Save handler
      document.getElementById('profile-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
          display_name: document.getElementById('fld-display').value.trim(),
          college: document.getElementById('fld-college').value.trim(),
          course: document.getElementById('fld-course').value.trim(),
          batch: document.getElementById('fld-batch').value.trim(),
          username: document.getElementById('fld-username').value.trim(),
          bio: document.getElementById('fld-bio').value.trim(),
          photo_path: document.getElementById('fld-photo').value.trim() || null,
          notifications_enabled: document.getElementById('notif-toggle').checked ? 1 : 0
        };
        try {
          const save = await fetch(`/api/me?school=${school}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Bearer ' + token
            },
            body: JSON.stringify(body)
          });
          const j = await save.json().catch(()=>({}));
          if (!save.ok) {
            document.getElementById('save-result').textContent = 'Save failed: ' + (j.error || save.status);
            return;
          }
          document.getElementById('save-result').textContent = 'Saved!';
          // update header visuals after successful save
          if (typeof window.updateAuthUI === 'function') {
            window.updateAuthUI();
          }
          if (typeof window.initializeHeader === 'function') {
            // refresh header (avatar/display)
            try { window.initializeHeader(); } catch(e){ console.warn('initializeHeader after save failed', e); }
          }
        } catch (err) {
          console.error('Save failed', err);
          document.getElementById('save-result').textContent = 'Save failed (network error)';
        }
      });

      // username check (format/slug validation; optional server check if available)
      const btnCheck = document.getElementById('btn-check-username');
      if (btnCheck) {
        btnCheck.addEventListener('click', async () => {
          const el = document.getElementById('fld-username');
          const v = (el.value || '').trim();
          if (!v || !/^[-a-z0-9]+$/i.test(v.replace(/\s+/g,'-').toLowerCase())) {
            alert('Username should contain letters, numbers, or dashes.');
            return;
          }
          try {
            const r = await fetch(`/api/username-available?school=${school}&u=${encodeURIComponent(v)}`);
            if (r.ok) {
              const j = await r.json().catch(()=>({}));
              if (j && typeof j.available !== 'undefined') {
                alert(j.available ? 'Username available!' : 'Username already taken.');
                return;
              }
            }
          } catch (_) {}
          alert('Looks good.');
        });
      }

      // reset
      const btnReset = document.getElementById('btn-reset');
      if (btnReset) {
        btnReset.addEventListener('click', () => window.location.reload());
      }
    });
  </script>

  <!-- NOTE: DO NOT keep a static <script src="/js/app.js"></script> here.
       app.js is loaded dynamically above after the header is inserted. -->
</body>
</html>
