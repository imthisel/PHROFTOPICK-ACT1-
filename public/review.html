<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes">
  <title>Create Review</title>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/theme-loader.js" defer></script>
  <style>
    /* ===== ENHANCED PAGE HERO ===== */
    .page-hero { 
      max-width: 1100px; 
      margin: 30px auto 24px; 
      padding: 28px 32px; 
      border-radius: 20px; 
      background: linear-gradient(135deg, rgba(0,105,62,0.08) 0%, rgba(0,0,0,0.02) 100%); 
      border: 1px solid rgba(0,0,0,0.08); 
      box-shadow: 0 4px 16px rgba(0,0,0,0.04);
    }
    .page-hero h1 { 
      font-size: 32px; 
      margin: 0 0 8px; 
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    .page-hero p { 
      color: #4b5563; 
      margin: 0; 
      font-size: 15px;
      line-height: 1.6;
    }
    .step { 
      display: inline-block; 
      padding: 8px 14px; 
      background: linear-gradient(135deg, #e8fff3 0%, #d1fae5 100%); 
      color: #06603e; 
      border-radius: 9999px; 
      font-weight: 700; 
      margin-bottom: 12px;
      font-size: 13px;
      letter-spacing: 0.3px;
      text-transform: uppercase;
    }

    /* ===== PROFESSIONAL PROFESSOR PICKER ===== */
    .picker { 
      max-width: 1100px; 
      margin: 24px auto; 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 20px; 
      padding: 32px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
    }
    .picker h3 { 
      margin: 0 0 20px; 
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      letter-spacing: -0.3px;
    }
    
    /* Enhanced Search Input */
    .search-wrapper {
      position: relative;
      margin-bottom: 24px;
    }
    .search-wrapper::before {
      content: 'ðŸ”';
      position: absolute;
      left: 18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      z-index: 1;
      pointer-events: none;
    }
    .picker input { 
      width: 100%; 
      padding: 16px 18px 16px 50px; 
      border-radius: 12px; 
      border: 2px solid #e5e7eb; 
      font-size: 15px;
      transition: all 0.2s ease;
      background: #fafafa;
    }
    .picker input:focus {
      outline: none;
      border-color: var(--primary);
      background: #fff;
      box-shadow: 0 0 0 4px rgba(0,105,62,0.1);
    }
    .picker input::placeholder {
      color: #9ca3af;
    }

    /* Loading State */
    .prof-results.loading {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 200px;
      color: #6b7280;
    }
    .prof-results.loading::after {
      content: '';
      width: 32px;
      height: 32px;
      border: 3px solid #e5e7eb;
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Professional Professor Cards */
    .prof-results { 
      margin-top: 20px; 
      display: grid; 
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
      gap: 16px;
    }
    .prof-item { 
      display: flex; 
      gap: 16px; 
      align-items: center; 
      padding: 18px; 
      border: 2px solid #e5e7eb; 
      border-radius: 16px; 
      background: #fff; 
      cursor: pointer; 
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    .prof-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--primary);
      transform: scaleX(0);
      transition: transform 0.2s ease;
    }
    .prof-item:hover { 
      transform: translateY(-2px); 
      box-shadow: 0 12px 24px rgba(0,0,0,0.1);
      border-color: var(--primary);
    }
    .prof-item:hover::before {
      transform: scaleX(1);
    }
    .prof-item img { 
      width: 64px; 
      height: 64px; 
      border-radius: 50%; 
      object-fit: cover; 
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border: 3px solid #f3f4f6;
      flex-shrink: 0;
      transition: all 0.2s ease;
    }
    .prof-item:hover img {
      border-color: var(--primary);
      transform: scale(1.05);
    }
    .prof-item-content {
      flex: 1;
      min-width: 0;
    }
    .prof-item-name {
      font-weight: 700;
      font-size: 16px;
      color: #111827;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .prof-item-meta {
      color: #6b7280;
      font-size: 13px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .prof-item-rating {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 6px;
      font-size: 12px;
      color: #9ca3af;
    }
    .prof-item-rating .stars {
      color: #fbbf24;
    }

    /* Empty State */
    .prof-results.empty {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }
    .prof-results.empty::before {
      content: 'ðŸ‘¤';
      display: block;
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* ===== ENHANCED FORM DESIGN ===== */
    .form-shell { 
      max-width: 1100px; 
      margin: 24px auto 50px; 
      display: grid; 
      grid-template-columns: 1fr 0.65fr; 
      gap: 24px;
    }
    .form-card { 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 20px; 
      padding: 32px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
    }
    .form-card h2 {
      margin: 0 0 8px;
      font-size: 24px;
      font-weight: 700;
      color: #111827;
      letter-spacing: -0.3px;
    }
    .form-card > p {
      margin: 0 0 24px;
      color: #6b7280;
      font-size: 14px;
    }

    /* Enhanced Summary Card */
    .summary { 
      background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%); 
      border: 2px solid #e5e7eb; 
      border-radius: 20px; 
      padding: 28px; 
      box-shadow: 0 8px 32px rgba(0,0,0,0.08);
      position: sticky; 
      top: 24px; 
      height: fit-content;
    }
    .summary h4 { 
      margin: 0 0 20px; 
      font-size: 18px;
      font-weight: 700;
      color: #111827;
    }
    .summary .row { 
      display: flex; 
      align-items: center; 
      gap: 16px; 
    }
    .summary img { 
      width: 72px; 
      height: 72px; 
      border-radius: 16px; 
      object-fit: cover; 
      background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
      border: 3px solid #e5e7eb;
    }
    .summary-name {
      font-weight: 700;
      font-size: 18px;
      color: #111827;
      margin-bottom: 4px;
    }
    .summary-meta {
      color: #6b7280;
      font-size: 14px;
    }

    /* Review Fields Enhancement */
    .review-field {
      margin-bottom: 20px;
    }
    .review-field input,
    .review-field select,
    .review-field textarea {
      transition: all 0.2s ease;
    }
    .review-field input:focus,
    .review-field select:focus,
    .review-field textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(0,105,62,0.1);
    }

    /* Professional Star Rating */
    .star-rating {
      display: flex;
      gap: 8px;
      font-size: 42px;
      cursor: pointer;
      margin: 12px 0;
      padding: 12px;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
      border-radius: 16px;
      width: fit-content;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      border: 2px solid #e5e7eb;
    }
    .star-rating .star {
      color: #d1d5db;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      user-select: none;
      position: relative;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }
    .star-rating .star:hover {
      transform: scale(1.2) rotate(-5deg);
      filter: drop-shadow(0 4px 8px rgba(245, 158, 11, 0.4));
    }
    .star-rating .star.selected {
      color: #f59e0b;
      animation: starPop 0.3s ease;
      filter: drop-shadow(0 4px 8px rgba(245, 158, 11, 0.5));
    }
    .star-rating .star.hovered {
      color: #fbbf24;
      transform: scale(1.15);
    }
    @keyframes starPop {
      0% { transform: scale(1); }
      50% { transform: scale(1.3) rotate(10deg); }
      100% { transform: scale(1); }
    }

    /* Submit Button Enhancement */
    .review-submit-btn {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      font-weight: 700;
      border-radius: 12px;
      transition: all 0.2s ease;
      margin-top: 8px;
    }
    .review-submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 16px rgba(0,105,62,0.2);
    }

    /* Responsive */
    @media (max-width: 900px) { 
      .form-shell { 
        grid-template-columns: 1fr; 
      } 
      .summary { 
        position: static; 
      }
      .prof-results {
        grid-template-columns: 1fr;
      }
    }

    /* Dark Mode */
    html.dark .picker, 
    html.dark .form-card, 
    html.dark .summary { 
      background: #14191c; 
      border-color: #2a2f34; 
    }
    html.dark .page-hero { 
      background: linear-gradient(135deg, rgba(0,105,62,0.12) 0%, rgba(255,255,255,0.02) 100%); 
      border-color: #2a2f34; 
    }
    html.dark .picker input { 
      background: #0f1214; 
      color: #e6e6e6; 
      border-color: #2a2f34; 
    }
    html.dark .prof-item { 
      background: #1a2024; 
      border-color: #2a2f34; 
    }
    html.dark .prof-item-name {
      color: #e6e6e6;
    }
    html.dark .summary-name {
      color: #e6e6e6;
    }
    html.dark .form-card h2 {
      color: #e6e6e6;
    }
  </style>
  <link rel="stylesheet" href="css/mobile-override.css">
</head>
<body>
<div id="header-placeholder"></div>

<main>
  <section class="page-hero container">
    <span class="step">Create Review</span>
    <h1>Share your experience with a professor</h1>
    <p>Keep it constructive and respectful. Your insights help thousands of students make better decisions.</p>
  </section>

  <section id="prof-picker" class="picker container">
    <h3>Select a professor</h3>
    <div class="search-wrapper">
      <input id="prof-search-input" placeholder="Search by name, subject, or course code..." autocomplete="off">
    </div>
    <div id="prof-results" class="prof-results loading"></div>
  </section>

  <section class="form-shell container" id="review-sections" style="display:none;">
    <form id="review-form" class="form-card">
      <h2>Your review</h2>
      <p>Please be honest and avoid personal attacks.</p>

  <div class="review-field">
    <input id="rev-course" placeholder=" " required>
    <label>Course Code *</label>
  </div>

  <div class="review-field">
    <select id="rev-again">
      <option>Yes</option><option>No</option>
    </select>
    <label>Would take again?</label>
  </div>

  <div class="review-field">
    <select id="rev-4">
      <option>Yes</option><option>No</option>
    </select>
    <label>4.0 attainable?</label>
  </div>

  <div class="review-field">
    <select id="rev-deadline">
      <option>Yes</option><option>No</option>
    </select>
    <label>Deadline leniency</label>
  </div>

  <div class="review-field">
    <select id="rev-workload">
      <option>Low</option><option>Medium</option><option>High</option>
    </select>
    <label>Workload</label>
  </div>

      <div class="review-field">
        <label style="margin-bottom: 8px; display: block; font-weight: 600; color: #374151;">Rating *</label>
        <div class="star-rating" id="star-rating">
          <span data-star="1" class="star">â˜†</span>
          <span data-star="2" class="star">â˜†</span>
          <span data-star="3" class="star">â˜†</span>
          <span data-star="4" class="star">â˜†</span>
          <span data-star="5" class="star">â˜†</span>
        </div>
        <input type="hidden" id="rev-rating" value="0" required>
      </div>

      <div class="review-field">
        <textarea id="rev-text" placeholder=" " required></textarea>
        <label>Notes/Comments *</label>
      </div>

  <label style="margin-bottom:10px;display:flex;align-items:center;gap:6px;">
    <input type="checkbox" id="rev-anon"> Post anonymously
  </label>

      <button class="review-submit-btn" type="submit">Submit Review</button>
      <p id="rev-result"></p>
    </form>

    <aside class="summary">
      <h4>Professor</h4>
      <div class="row">
        <img id="prof-photo" alt="">
        <div>
          <div id="prof-name" class="summary-name">â€”</div>
          <small id="prof-meta" class="summary-meta">Select a professor to begin</small>
        </div>
      </div>
    </aside>
  </section>
</main>

<script>
document.addEventListener('DOMContentLoaded', async () => {
  const headerContainer = document.getElementById('header-placeholder');
  try {
    const res = await fetch('/components/header.html');
    if (!res.ok) throw new Error('Failed to fetch header.html');
    headerContainer.innerHTML = await res.text();
    await new Promise(r => requestAnimationFrame(r));
    if (!document.querySelector('script[src="/js/app.js"]')) {
      await new Promise((resolve, reject) => { 
        const s = document.createElement('script'); 
        s.src='/js/app.js'; 
        s.onload=resolve; 
        s.onerror=()=>reject(new Error('app.js load failed')); 
        document.head.appendChild(s); 
      });
    }
    if (window.updateSchoolLogo) try { window.updateSchoolLogo(); } catch(e){}
    if (window.initializeHeader) try { await window.initializeHeader(); } catch(e){}
  } catch (e) { console.warn('Header injection failed', e); }

  const urlParams = new URLSearchParams(window.location.search);
  let profId = urlParams.get('prof');
  const picker = document.getElementById('prof-picker');
  const results = document.getElementById('prof-results');
  const searchInput = document.getElementById('prof-search-input');
  const sections = document.getElementById('review-sections');
  const form = document.getElementById('review-form');
  const revResult = document.getElementById('rev-result');

  const profNameEl = document.getElementById('prof-name');
  const profMetaEl = document.getElementById('prof-meta');
  const profPhotoEl = document.getElementById('prof-photo');

  function showPicker() { 
    picker.style.display = 'block'; 
    sections.style.display = 'none'; 
  }
  function showForm() { 
    picker.style.display = 'none'; 
    sections.style.display = 'grid'; 
  }

  async function populateProfessor(p) {
    profNameEl.textContent = p.name || 'Professor';
    profMetaEl.textContent = p.subject_name ? `${p.subject_code || ''} ${p.subject_name}` : (p.department || '');
    if (profPhotoEl) {
      profPhotoEl.src = p.photo_path || '';
      profPhotoEl.style.display = p.photo_path ? 'block' : 'none';
    }
  }

  // Debounce function for search
  let searchTimeout;
  function debounceSearch(func, delay) {
    return function(...args) {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => func.apply(this, args), delay);
    };
  }

  if (!profId) {
    showPicker();
    
    const doSearch = async (q = '') => {
      results.classList.add('loading');
      results.classList.remove('empty');
      
      try {
        const res = await fetch(`/api/profs/search?school=${(localStorage.getItem('selectedSchool')||'dlsu')}&q=${encodeURIComponent(q)}`);
        const j = await res.json();
        const list = j.professors || [];
        
        results.classList.remove('loading');
        
        if (list.length === 0) {
          results.classList.add('empty');
          results.innerHTML = q ? 'No professors found. Try a different search.' : 'No professors available.';
          return;
        }
        
        results.innerHTML = list.map(p => {
          const rating = p.rating_avg ? Number(p.rating_avg).toFixed(1) : '0.0';
          const stars = Math.round(p.rating_avg || 0);
          const starDisplay = 'â˜…'.repeat(stars) + 'â˜†'.repeat(5 - stars);
          
          return `
            <div class="prof-item" data-id="${p.id}" data-name="${p.name}" data-photo="${p.photo_path||''}" data-subject-code="${p.subject_code||''}" data-subject-name="${p.subject_name||''}">
              <img src="${p.photo_path||'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'64\' height=\'64\'%3E%3Crect fill=\'%23f3f4f6\' width=\'64\' height=\'64\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'24\'%3EðŸ‘¤%3C/text%3E%3C/svg%3E'}" alt="${p.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'64\' height=\'64\'%3E%3Crect fill=\'%23f3f4f6\' width=\'64\' height=\'64\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'24\'%3EðŸ‘¤%3C/text%3E%3C/svg%3E'">
              <div class="prof-item-content">
                <div class="prof-item-name">${p.name}</div>
                <div class="prof-item-meta">${p.subject_code || ''} ${p.subject_name || 'No subject'}</div>
                ${p.rating_avg ? `<div class="prof-item-rating"><span class="stars">${starDisplay}</span> <span>${rating}</span> <span>(${p.rating_count || 0})</span></div>` : ''}
              </div>
            </div>
          `;
        }).join('');
        
        results.querySelectorAll('.prof-item').forEach(el => {
          el.addEventListener('click', () => {
          profId = el.dataset.id;
            populateProfessor({ 
              name: el.dataset.name, 
              photo_path: el.dataset.photo, 
              subject_code: el.dataset.subjectCode,
              subject_name: el.dataset.subjectName 
            });
          showForm();
          });
        });
      } catch(e) {
        console.error('Search error:', e);
        results.classList.remove('loading');
        results.classList.add('empty');
        results.innerHTML = 'Failed to load professors. Please try again.';
      }
    };
    
    // Live search with debounce
    const debouncedSearch = debounceSearch((q) => doSearch(q), 300);
    searchInput.addEventListener('input', e => {
      const query = e.target.value.trim();
      debouncedSearch(query);
    });
    
    // Load all professors initially
    doSearch('');
  } else {
    showForm();
    try {
      const res = await fetch(`/api/prof?id=${profId}&school=${(localStorage.getItem('selectedSchool')||'dlsu')}`);
      const j = await res.json();
      const p = (j && j.professor) || {};
      populateProfessor(p);
    } catch(_) {}
  }

  // Star rating functionality
  const starRating = document.getElementById('star-rating');
  const ratingInput = document.getElementById('rev-rating');
  let selectedRating = 0;

  if (starRating) {
    const stars = starRating.querySelectorAll('.star');
    stars.forEach(star => {
      star.addEventListener('mouseover', (e) => {
        const value = parseInt(e.target.dataset.star);
        stars.forEach((s, idx) => {
          if (idx < value) s.classList.add('hovered');
          else s.classList.remove('hovered');
        });
      });
      star.addEventListener('mouseout', () => {
        stars.forEach(s => s.classList.remove('hovered'));
        // Restore selected stars
        stars.forEach((s, idx) => {
          if (idx < selectedRating) s.classList.add('selected');
          else s.classList.remove('selected');
        });
      });
      star.addEventListener('click', (e) => {
        selectedRating = parseInt(e.target.dataset.star);
        ratingInput.value = selectedRating;
        stars.forEach((s, idx) => {
          if (idx < selectedRating) s.classList.add('selected');
          else s.classList.remove('selected');
        });
      });
    });
  }

  const courseEl = document.getElementById('rev-course');
  const againEl = document.getElementById('rev-again');
  const attainableEl = document.getElementById('rev-4');
  const deadlineEl = document.getElementById('rev-deadline');
  const workloadEl = document.getElementById('rev-workload');
  const textEl = document.getElementById('rev-text');
  const anonEl = document.getElementById('rev-anon');
  const ratingEl = document.getElementById('rev-rating');
  const submitBtn = form.querySelector('button[type="submit"]');

  function disableForm(state = true) {
    if (submitBtn) submitBtn.disabled = state;
    [courseEl, againEl, attainableEl, deadlineEl, workloadEl, textEl, anonEl, ratingEl]
      .forEach(el => { if (el) el.disabled = state; });
    if (starRating) {
      starRating.style.pointerEvents = state ? 'none' : 'auto';
      starRating.style.opacity = state ? '0.6' : '1';
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    revResult.textContent = '';

    // Get token from localStorage (user is already logged in to access this page)
    const token = localStorage.getItem('token') || '';
    
    console.log('ðŸ“ Submitting review with token:', token ? 'Present âœ…' : 'Missing âŒ');

    // Build payload
    const payload = {
      course_code: courseEl.value.trim(),
      would_take_again: againEl.value,
      attainable_4: attainableEl.value,
      deadline_leniency: deadlineEl.value,
      workload_rating: workloadEl.value,
      tags: '',
      review_text: textEl.value.trim(),
      anonymous: !!anonEl.checked,
      rating: parseInt(ratingEl.value) || 0
    };

    try {
      const res = await fetch(`/api/profs/${profId}/review?school=${(localStorage.getItem('selectedSchool')||'dlsu')}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
        body: JSON.stringify(payload)
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok) {
        revResult.textContent = j.error || ('Submission failed (' + (res.status || 'error') + ')');
        disableForm(false);
        return;
      }
      revResult.textContent = 'âœ… Review submitted! Redirecting to professor page...';
      form.reset();
      selectedRating = 0;
      if (starRating) {
        starRating.querySelectorAll('.star').forEach(s => s.classList.remove('selected', 'hovered'));
      }
      setTimeout(() => { window.location.href = `/prof.html?id=${profId}`; }, 900);
    } catch (err) {
      console.error('Network error submitting review', err);
      revResult.textContent = 'Network error. Please try again.';
      disableForm(false);
    }
  });
});
</script>

</body>
</html>
