<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Signing you in…</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="robots" content="noindex, nofollow">
  <link rel="canonical" href="/oauth-success">
  <style>
    /* Minimal centered loader */
    body{display:flex;align-items:center;justify-content:center;height:100vh;margin:0;font-family:Inter,system-ui;}
    .box{text-align:center}
    .spinner{width:48px;height:48px;border-radius:50%;border:5px solid #eee;border-top-color:#00693e;animation:spin .8s linear infinite;margin:0 auto 12px}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="box">
    <div class="spinner"></div>
    <div>Finishing sign in — redirecting...</div>
  </div>

  <script>
    // Parse query string safely
    (function(){
      function parseQS() {
        const q = location.search.replace(/^\?/,'');
        const pairs = q ? q.split('&') : [];
        const out = {};
        for (const p of pairs) {
          const [k,v=''] = p.split('=');
          try { out[decodeURIComponent(k)] = decodeURIComponent(v); } catch(e){ out[k]=v; }
        }
        return out;
      }
      const qs = parseQS();
      // expected: token, display, school, photo (photo is optional)
      if (qs.token) {
        try {
          localStorage.setItem('token', qs.token);
          if (qs.display) localStorage.setItem('user_display', qs.display);
          if (qs.photo) localStorage.setItem('user_photo', qs.photo);
        } catch (err) { console.error('Failed to store auth token', err); }
      } else {
        console.warn('No token in URL — oauth might have failed');
      }

      // Best UX: small delay so user sees the spinner if redirect is instant
      setTimeout(() => {
        // prefer returning to the page that initiated login if present
        const next = sessionStorage.getItem('post_auth_redirect') || '/index';
        sessionStorage.removeItem('post_auth_redirect');
        window.location.replace(next);
      }, 600);
    })();
  </script>
</body>
</html>
