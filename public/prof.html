<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=1100, initial-scale=1.0, user-scalable=yes" />
  <title>Professor Details</title>
  <link rel="icon" type="image/png" href="images/favicon.png">

  <link rel="stylesheet" href="css/base.css" />
  <script>
  // Preload the correct logo before header loads
  (function preloadLogo() {
    const school = localStorage.getItem('selectedSchool') || 'dlsu';
    const logoMap = {
      dlsu: 'images/dlsu-logo.png',
      ateneo: 'images/ateneo-logo.png',
      benilde: 'images/benilde-logo.png',
      up: 'images/up-logo.png',
    };
    const selectedLogo = logoMap[school] || 'images/default-logo.png';

    // Preload it to browser cache
    const img = new Image();
    img.src = selectedLogo;

    // Pre-store it globally for instant use when header loads
    window.__PRELOADED_LOGO = selectedLogo;
  })();
</script>

  <script src="js/theme-loader.js" defer></script>
  <script>
    // keep theme loading early
    const school = localStorage.getItem("selectedSchool") || "dlsu";
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = `css/style-${school}.css`;
    document.head.appendChild(link);
  </script>
  <style>
    .star-rating { display:flex; gap:4px; font-size:28px; cursor:pointer; }
    .star { color:#ccc; transition: color .18s; }
    .star.selected, .star.hovered { color: #FFD700; }
    .prof-photo { max-width:120px; border-radius:8px; display:block; margin:8px 0; }
  </style>
  <link rel="stylesheet" href="css/mobile-override.css">
</head>

<body>
  <div id="header-placeholder"></div>

  <div class="container">
    <div id="prof-details" class="card"></div>

    <form id="rating-form">
      <div id="star-container" class="star-rating">
        <span data-star="1" class="star">&#9734;</span>
        <span data-star="2" class="star">&#9734;</span>
        <span data-star="3" class="star">&#9734;</span>
        <span data-star="4" class="star">&#9734;</span>
        <span data-star="5" class="star">&#9734;</span>
      </div>
      <input type="hidden" id="stars" value="0" />
      <br/>
      <label for="comment">Comment:</label><br/>
      <textarea id="comment" rows="3" style="width:100%"></textarea>
      <br/>
      <button type="submit">Submit</button>
    </form>

    <div class="panel">
      <h3>Comments</h3>
      <div id="comments"></div>
    </div>
    <h3>Student Reviews</h3>
   <div id="full-reviews"></div>
    <div class="panel">
      <h3>Notes</h3>
      <div id="notes"></div>
    </div>
  </div>

  <!-- =============== JS SECTION =============== -->
  <script>
  // All DOM logic runs after DOMContentLoaded to avoid "null" element errors.
  document.addEventListener('DOMContentLoaded', () => {
    console.log("✅ DOM ready");

    const profId = new URLSearchParams(window.location.search).get("id");
    if (!profId) {
      document.getElementById('prof-details').innerHTML = '<p style="color:red">Professor ID missing in URL.</p>';
      return;
    }

    const starContainer = document.getElementById('star-container');
    const hiddenStarsInput = document.getElementById('stars');
    let selectedStars = 0;

    // Star rating UI
    if (starContainer) {
      const stars = starContainer.querySelectorAll('.star');
      stars.forEach(s => {
        s.addEventListener('mouseover', e => {
          const v = parseInt(e.target.dataset.star);
          stars.forEach(x => x.classList.toggle('hovered', parseInt(x.dataset.star) <= v));
        });
        s.addEventListener('mouseout', () => stars.forEach(x => x.classList.remove('hovered')));
        s.addEventListener('click', e => {
          selectedStars = parseInt(e.target.dataset.star);
          hiddenStarsInput.value = selectedStars;
          stars.forEach(x => x.classList.toggle('selected', parseInt(x.dataset.star) <= selectedStars));
        });
      });
    }

    // Load professor details
    async function loadProfessor() {
      try {
        const school = localStorage.getItem("selectedSchool") || "dlsu";
        const res = await fetch(`/api/profs/${profId}?school=${school}`);
        if (!res.ok) {
          document.getElementById("prof-details").innerHTML = "<p style='color:red'>Failed to load professor details.</p>";
          return;
        }
        const data = await res.json();
        const prof = data.prof || {};
        const comments = data.comments || [];
        const notes = data.notes || [];

        const details = document.getElementById("prof-details");
        details.innerHTML = `
          <h2>${prof.name || "Unknown Professor"}</h2>
          <p><strong>Subject:</strong> ${prof.subject_code || ""} ${prof.subject_name ? '- ' + prof.subject_name : ''}</p>
          ${prof.photo_path ? `<img src="${prof.photo_path}" class="prof-photo">` : ''}
          <p><strong>Workload:</strong> ${prof.workload || "N/A"}</p>
          <p><strong>Teaching Style:</strong> ${prof.teaching_style || "N/A"}</p>
          <p><strong>Tips:</strong> ${prof.tips || "N/A"}</p>
          <p><strong>Plus Points:</strong> ${prof.plus_points || "N/A"}</p>
          <p>
            <strong>Average Rating:</strong>
            <strong class="avg-rating">${prof.rating_avg ? Number(prof.rating_avg).toFixed(2) : "0.00"}</strong>
            <span>${'★'.repeat(Math.round(prof.rating_avg || 0))}${'☆'.repeat(5 - Math.round(prof.rating_avg || 0))}</span>
            <small class="rating-count">(${prof.rating_count || 0} ratings)</small>
          </p>
        `;

        // Comments
        const commentsDiv = document.getElementById("comments");
        commentsDiv.innerHTML = comments.length
          ? comments.map(c => `
              <div class="comment-item" style="margin-bottom:10px">
                <strong>${c.anonymous ? "Anonymous" : (c.display_name || "User")}</strong>
                <span style="margin-left:8px">${'★'.repeat(c.stars)}${'☆'.repeat(5 - c.stars)}</span>
                <p style="margin:6px 0;">${c.comment || ""}</p>
                <small style="color:#666">${c.created_at ? new Date(c.created_at).toLocaleString() : ''}</small>
              </div>
            `).join('')
          : "<p>No comments yet.</p>";

          // Load full reviews
const revRes = await fetch(`/api/profs/${profId}/reviews?school=${school}`);
const revData = await revRes.json();

document.getElementById("full-reviews").innerHTML = revData.reviews.length
? revData.reviews.map(r => `
  <div class="card">
    <strong>${r.anonymous ? "Anonymous" : r.display_name}</strong>
    <p><strong>${r.title}</strong> — ${r.course_code}</p>
    <p>${r.review_text}</p>
    <small>${new Date(r.created_at).toLocaleDateString()}</small>
  </div>
`).join("")
: "<p>No reviews yet.</p>";


        // Notes
        const notesDiv = document.getElementById("notes");
        notesDiv.innerHTML = notes.length
          ? notes.map(n => `
              <div class="note-item" style="margin-bottom:10px">
                <a href="${n.path}" target="_blank">${n.original_name}</a>
                <p style="margin:6px 0">${n.description || ""}</p>
                <small style="color:#666">Uploaded by ${n.anonymous ? "Anonymous" : (n.display_name || "User")} on ${n.created_at ? new Date(n.created_at).toLocaleString() : ''}</small>
              </div>
            `).join('')
          : "<p>No notes yet.</p>";

      } catch (err) {
        document.getElementById("prof-details").innerHTML = "<p style='color:red'>Error loading professor details.</p>";
      }
    }

    // Submit rating
    const ratingForm = document.getElementById("rating-form");
    ratingForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const stars = parseInt(document.getElementById("stars").value) || 0;
      const comment = document.getElementById("comment").value.trim();
      const anonymous = false;

      if (stars === 0) return alert("Please select a star rating first!");

      const school = localStorage.getItem("selectedSchool") || "dlsu";
      const res = await fetch(`/api/profs/${profId}/rate?school=${school}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ stars, comment, anonymous })
      });

      const data = await res.json();
      if (data.ok) {
        await loadProfessor();
        ratingForm.reset();
        document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
        document.getElementById('stars').value = 0;
        selectedStars = 0;
      } else {
        alert(data.error || "Failed to submit rating.");
      }
    });

    loadProfessor();
  });
  </script>


  <!-- Load shared header dynamically -->
 <!-- Load shared header dynamically -->
<script src="js/app.js"></script>
<!-- Load shared header dynamically (replace existing fetch block) -->
<script>
document.addEventListener("DOMContentLoaded", async () => {
  try {
    const headerContainer = document.getElementById("header-placeholder");
    // use absolute path to avoid relative-path issues
    const res = await fetch("/components/header.html");
    headerContainer.innerHTML = await res.text();

    // small pause to allow browser to parse inserted HTML
    await new Promise(requestAnimationFrame);

    // call the global functions only if available
    if (typeof window.updateSchoolLogo === "function") {
      window.updateSchoolLogo(); // set correct logo src
    }
    if (typeof window.initializeHeader === "function") {
      // initializeHeader is async in your code; await if it returns a promise
      await window.initializeHeader();
    }
    if (typeof window.updateAuthUI === "function") {
      window.updateAuthUI();
    }

    console.log("Header injected and initialized (prof/subject).");
  } catch (err) {
    console.error("Failed to load header:", err);
  }
});
</script>





  <!-- Load global JS (which has the new initializeHeader) -->

  
</body>
</html>
