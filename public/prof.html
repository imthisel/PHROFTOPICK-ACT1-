<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Professor Details</title>
  <link rel="stylesheet" href="css/base.css" />
  <script src="js/theme-loader.js" defer></script>
  <script>
    // keep theme loading early
    const school = localStorage.getItem("selectedSchool") || "dlsu";
    const link = document.createElement("link");
    link.rel = "stylesheet";
    link.href = `css/style-${school}.css`;
    document.head.appendChild(link);
  </script>
  <style>
    .star-rating { display:flex; gap:4px; font-size:28px; cursor:pointer; }
    .star { color:#ccc; transition: color .18s; }
    .star.selected, .star.hovered { color: #FFD700; }
    .prof-photo { max-width:120px; border-radius:8px; display:block; margin:8px 0; }
  </style>
</head>
<body>
  <div id="header-placeholder"></div>


  <div class="container">
    <div id="prof-details" class="card"></div>

    <form id="rating-form">
      <div id="star-container" class="star-rating">
        <span data-star="1" class="star">&#9734;</span>
        <span data-star="2" class="star">&#9734;</span>
        <span data-star="3" class="star">&#9734;</span>
        <span data-star="4" class="star">&#9734;</span>
        <span data-star="5" class="star">&#9734;</span>
      </div>
      <input type="hidden" id="stars" value="0" />
      <br/>
      <label for="comment">Comment:</label><br/>
      <textarea id="comment" rows="3" style="width:100%"></textarea>
      <br/>
      <button type="submit">Submit</button>
    </form>

    <div class="panel">
      <h3>Comments</h3>
      <div id="comments"></div>
    </div>

    <div class="panel">
      <h3>Notes</h3>
      <div id="notes"></div>
    </div>
  </div>

  <script>
  // All DOM logic runs after DOMContentLoaded to avoid "null" element errors.
  document.addEventListener('DOMContentLoaded', () => {
    console.log("‚úÖ DOM ready");

    // get profId after DOM ready
    const profId = new URLSearchParams(window.location.search).get("id");
    if (!profId) {
      console.error("‚ùå No prof id in URL (use ?id=<profId>)");
      document.getElementById('prof-details').innerHTML = '<p style="color:red">Professor ID missing in URL.</p>';
      return;
    }

    // star UI setup
    const starContainer = document.getElementById('star-container');
    const hiddenStarsInput = document.getElementById('stars');
    let selectedStars = 0;

    if (starContainer) {
      const stars = starContainer.querySelectorAll('.star');
      stars.forEach(s => {
        s.addEventListener('mouseover', (e) => {
          const v = parseInt(e.target.dataset.star);
          stars.forEach(x => x.classList.toggle('hovered', parseInt(x.dataset.star) <= v));
        });
        s.addEventListener('mouseout', () => stars.forEach(x => x.classList.remove('hovered')));
        s.addEventListener('click', (e) => {
          selectedStars = parseInt(e.target.dataset.star);
          hiddenStarsInput.value = selectedStars;
          stars.forEach(x => x.classList.toggle('selected', parseInt(x.dataset.star) <= selectedStars));
        });
      });
    } else {
      console.error("‚ùå starContainer not found");
    }

    // load professor details and comments/notes
    async function loadProfessor() {
      try {
        const school = localStorage.getItem("selectedSchool") || "dlsu";
        const res = await fetch(`/api/profs/${profId}?school=${school}`);
        if (!res.ok) {
          console.error("Error fetching professor:", res.status);
          document.getElementById("prof-details").innerHTML = "<p style='color:red'>Failed to load professor details.</p>";
          return;
        }
        const data = await res.json();
        const prof = data.prof || {};
        const comments = data.comments || [];
        const notes = data.notes || [];

        const details = document.getElementById("prof-details");
        details.innerHTML = `
          <h2>${prof.name || "Unknown Professor"}</h2>
          <p><strong>Subject:</strong> ${prof.subject_code || ""} ${prof.subject_name ? '- ' + prof.subject_name : ''}</p>
          ${prof.photo_path ? `<img src="${prof.photo_path}" class="prof-photo">` : ''}
          <p><strong>Workload:</strong> ${prof.workload || "N/A"}</p>
          <p><strong>Teaching Style:</strong> ${prof.teaching_style || "N/A"}</p>
          <p><strong>Tips:</strong> ${prof.tips || "N/A"}</p>
          <p><strong>Plus Points:</strong> ${prof.plus_points || "N/A"}</p>
          <p>
            <strong>Average Rating:</strong>
            <strong class="avg-rating">${prof.rating_avg ? Number(prof.rating_avg).toFixed(2) : "0.00"}</strong>
            <span>${'‚òÖ'.repeat(Math.round(prof.rating_avg || 0))}${'‚òÜ'.repeat(5 - Math.round(prof.rating_avg || 0))}</span>
            <small class="rating-count">(${prof.rating_count || 0} ratings)</small>
          </p>
        `;

        // render comments
        const commentsDiv = document.getElementById("comments");
        commentsDiv.innerHTML = comments.length
          ? comments.map(c => `
              <div class="comment-item" style="margin-bottom:10px">
                <strong>${c.anonymous ? "Anonymous" : (c.display_name || "User")}</strong>
                <span style="margin-left:8px">${'‚òÖ'.repeat(c.stars)}${'‚òÜ'.repeat(5 - c.stars)}</span>
                <p style="margin:6px 0;">${c.comment || ""}</p>
                <small style="color:#666">${c.created_at ? new Date(c.created_at).toLocaleString() : ''}</small>
              </div>
            `).join('')
          : "<p>No comments yet.</p>";

        // render notes
        const notesDiv = document.getElementById("notes");
        notesDiv.innerHTML = notes.length
          ? notes.map(n => `
              <div class="note-item" style="margin-bottom:10px">
                <a href="${n.path}" target="_blank">${n.original_name}</a>
                <p style="margin:6px 0">${n.description || ""}</p>
                <small style="color:#666">Uploaded by ${n.anonymous ? "Anonymous" : (n.display_name || "User")} on ${n.created_at ? new Date(n.created_at).toLocaleString() : ''}</small>
              </div>
            `).join('')
          : "<p>No notes yet.</p>";

      } catch (err) {
        console.error("Error loading professor:", err);
        document.getElementById("prof-details").innerHTML = "<p style='color:red'>Error loading professor details. Please try again later.</p>";
      }
    }

    // submit handler
    const ratingForm = document.getElementById("rating-form");
    if (!ratingForm) {
      console.error("‚ùå rating-form element not found");
      return;
    }

    ratingForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      console.log("üì© Rating form submitted");

      const stars = parseInt(document.getElementById("stars").value) || 0;
      const comment = document.getElementById("comment").value.trim();
      const anonymous = false;

      if (stars === 0) {
        alert("Please select a star rating first!");
        return;
      }

      const school = localStorage.getItem("selectedSchool") || "dlsu";

      try {
        const res = await fetch(`/api/profs/${profId}/rate?school=${school}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ stars, comment, anonymous })
        });

        console.log("üßæ POST status:", res.status);
        const data = await res.json();
        console.log("üì¶ POST response:", data);

        if (data.ok) {
          // refresh UI to show new comment & updated average
          await loadProfessor();
          ratingForm.reset();
          document.querySelectorAll('.star').forEach(s => s.classList.remove('selected'));
          document.getElementById('stars').value = 0;
          selectedStars = 0;
        } else {
          alert(data.error || "Failed to submit rating.");
        }
      } catch (err) {
        console.error("üö® Submit error:", err);
        alert("Network or server error when submitting rating.");
      }
    });

    // initial load
    loadProfessor();
  });
  </script>

  <script>
  // Load shared header dynamically
  document.addEventListener("DOMContentLoaded", async () => {
    const headerContainer = document.getElementById("header-placeholder");
    const res = await fetch("components/header.html");
    const html = await res.text();
    headerContainer.innerHTML = html;

    // Once header is loaded, initialize its JS
    initializeHeader();
  });

  function initializeHeader() {
    const school = localStorage.getItem("selectedSchool") || "dlsu";
    const header = document.querySelector(".site-header h1");
    const logoArea = document.querySelector(".logo-area");

    if (header) {
      header.innerHTML = `${school.toUpperCase()} ‚Äî PHROFSTOPICK<br><span class="business-name"></span>`;
    }

    if (logoArea) {
      const img = logoArea.querySelector(".school-logo");
      img.src = `images/${school}-logo.png`;
      img.onerror = () => { img.src = `images/${school}-logo.jpeg`; };
      img.alt = `${school} logo`;
    }

    // Auth UI setup
    const btnShowLogin = document.getElementById("btn-show-login");
    const btnShowSignup = document.getElementById("btn-show-signup");
    const btnLogout = document.getElementById("btn-logout");
    const userNameSpan = document.getElementById("user-name");

    function updateAuthUI() {
      const token = localStorage.getItem("token");
      if (token) {
        btnShowLogin.style.display = "none";
        btnShowSignup.style.display = "none";
        btnLogout.style.display = "inline-block";
        userNameSpan.style.display = "inline-block";
        userNameSpan.textContent = localStorage.getItem("user_display") || "You";
      } else {
        btnShowLogin.style.display = "inline-block";
        btnShowSignup.style.display = "inline-block";
        btnLogout.style.display = "none";
        userNameSpan.style.display = "none";
      }
    }
    updateAuthUI();

    btnLogout.onclick = () => {
      localStorage.removeItem("token");
      localStorage.removeItem("user_display");
      updateAuthUI();
      alert("Logged out");
    };
  }

  function changeSchool() {
    localStorage.removeItem("selectedSchool");
    window.location.href = "school.html";
  }
</script>


</body>
</html>
