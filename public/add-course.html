<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes" />
  <title>Add Course</title>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/theme-loader.js" defer></script>
  <link rel="stylesheet" href="css/mobile-override.css">
</head>
<body>
  <div id="header-placeholder"></div>

  <style>
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:800px){ .grid-2{ grid-template-columns:1fr; } }
    .auth-btn:focus { outline:2px solid var(--primary); outline-offset:2px; }
    /* Local override: keep labels above inputs to avoid covering placeholders */
    .review-field input { padding: 16px 12px; }
    .review-field label { top: -10px; transform: none; font-size: 12px; background: #fff; }
  </style>

  <main class="container" style="max-width:1200px; margin-top:24px; min-height:calc(100vh - 160px); display:flex; justify-content:center; align-items:flex-start;">
    <h1 style="margin-bottom:10px;">Add Course</h1>
    <p style="color:#6b7280;">Submit a new course. It becomes searchable but is hidden from index listing.</p>

    <section class="card" style="padding:28px; width:100%; max-width:900px; margin:0 auto;">
      <form id="course-form" aria-label="Add Course Form">
        <div class="review-field">
          <input id="course-code" placeholder="e.g., GEMATMW" maxlength="7" required aria-describedby="code-error" style="width:100%;" list="course-code-list" />
          <datalist id="course-code-list"></datalist>
          <label>Course Code</label>
          </div>
        <div id="code-error" style="color:#dc2626; font-weight:600; display:none;">Code must be exactly 7 uppercase letters.</div>

        <div class="review-field" style="margin-top:14px;">
          <input id="course-name" placeholder="e.g., GEMATMW - Mathematics in The Modern World" required aria-describedby="name-error" style="width:100%;" />
          <label>Course Name</label>
        </div>
        <div id="name-error" style="color:#dc2626; font-weight:600; display:none;">Format must be: CODE - Full Course Name</div>

        <button class="auth-btn" type="submit" style="margin-top:12px;">Submit</button>
        <p id="course-result" style="margin-top:10px; font-weight:600;" aria-live="polite"></p>
      </form>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const headerContainer = document.getElementById('header-placeholder');
        const res = await fetch('/components/header.html');
        headerContainer.innerHTML = await res.text();
        await new Promise(requestAnimationFrame);
        if (!document.querySelector('script[src="/js/app.js"]')) {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = '/js/app.js';
            s.onload = resolve;
            s.onerror = () => reject(new Error('app.js load failed'));
            document.head.appendChild(s);
          });
        }
        if (window.updateSchoolLogo) window.updateSchoolLogo();
        if (window.initializeHeader) await window.initializeHeader();
        if (window.updateAuthUI) window.updateAuthUI();
      } catch (e) { console.warn('Header init failed', e); }

      const form = document.getElementById('course-form');
      const codeInput = document.getElementById('course-code');
      const nameInput = document.getElementById('course-name');
      const codeErr = document.getElementById('code-error');
      const nameErr = document.getElementById('name-error');
      const resultEl = document.getElementById('course-result');

      const codeRe = /^[A-Z]{7}$/;
      const nameRe = /^[A-Z]{7}\s-\s.{3,}$/;
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      let debounceT;
      let allCourses = [];
      async function autofillNameFromCode() {
        const code = (codeInput.value||'').trim().toUpperCase();
        if (!codeRe.test(code)) return;
        try {
          const r = await fetch(`/api/subjects?school=${school}&q=${encodeURIComponent(code)}`);
          const j = await r.json();
          const list = Array.isArray(j) ? j : (j.subjects||[]);
          const match = list.find(s => String(s.code||'').toUpperCase() === code) || list[0];
          if (match && match.name) {
            nameInput.value = `${code} - ${match.name}`;
          }
        } catch (_) {}
      }
      codeInput.addEventListener('input', ()=>{
        clearTimeout(debounceT); debounceT = setTimeout(autofillNameFromCode, 250);
      });

      async function loadCourseList(){
        try{
          const r = await fetch(`/api/subjects?school=${school}`);
          const j = await r.json();
          allCourses = (Array.isArray(j)? j : (j.subjects||[])).slice().sort((a,b)=>String(a.code).localeCompare(String(b.code)));
          const dl = document.getElementById('course-code-list');
          if (dl) dl.innerHTML = allCourses.map(s => `<option value="${String(s.code||'').toUpperCase()}">${s.name||''}</option>`).join('');
        }catch(_){ /* noop */ }
      }

      await loadCourseList();
      codeInput.addEventListener('change', ()=>{ clearTimeout(debounceT); autofillNameFromCode(); });

      function clearValidation() {
        codeInput.removeAttribute('aria-invalid');
        nameInput.removeAttribute('aria-invalid');
        codeErr.style.display = 'none';
        nameErr.style.display = 'none';
      }

      codeInput.addEventListener('input', clearValidation);
      nameInput.addEventListener('input', clearValidation);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearValidation();
        resultEl.textContent = '';

        const code = (codeInput.value || '').trim();
        const name = (nameInput.value || '').trim();
        if (!codeRe.test(code)) { codeErr.style.display = 'block'; codeInput.setAttribute('aria-invalid','true'); return; }
        if (!nameRe.test(name)) { nameErr.style.display = 'block'; nameInput.setAttribute('aria-invalid','true'); return; }

        try {
          const r = await fetch(`/api/subjects/create?school=${school}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, name })
          });
          const j = await r.json().catch(() => ({}));
          if (!r.ok) {
            resultEl.style.color = '#dc2626';
            resultEl.textContent = j.error || 'Submission failed';
            return;
          }
          resultEl.style.color = '#065f46';
          resultEl.innerHTML = `Course created. <a href="/subject.html?id=${j.id}">Open page</a>`;
        } catch (err) {
          resultEl.style.color = '#dc2626';
          resultEl.textContent = 'Network error. Please try again.';
        }
      });
    });
  </script>
</body>
</html>
