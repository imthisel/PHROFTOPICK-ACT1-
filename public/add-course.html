<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes" />
  <title>Add Course</title>
  <meta name="description" content="Submit a new course to make it searchable for students.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="/add-course">
  <meta property="og:title" content="Add Course — Phroftopick">
  <meta property="og:description" content="Contribute course details to help students find information.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://phroftopick.com/add-course">
  <meta property="og:image" content="/images/default-logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Add Course — Phroftopick">
  <meta name="twitter:description" content="Contribute course details to help students find information.">
  <meta name="twitter:image" content="/images/default-logo.png">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@600;700;800&display=swap" rel="stylesheet">
  <script>
    (function preloadLogo() {
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const logoMap = {
        dlsu: 'images/dlsu-logo.png',
        ateneo: 'images/ateneo-logo.png',
        benilde: 'images/benilde-logo.png',
        up: 'images/up-logo.png',
      };
      const selectedLogo = logoMap[school] || 'images/default-logo.png';
      const img = new Image();
      img.src = selectedLogo;
      window.__PRELOADED_LOGO = selectedLogo;
    })();
  </script>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/theme-loader.js" defer></script>
  <link rel="stylesheet" href="css/mobile-override.css">
</head>
<body>
  <div id="header-placeholder"></div>

  <style>
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:800px){ .grid-2{ grid-template-columns:1fr; } }
    .auth-btn:focus { outline:2px solid var(--primary); outline-offset:2px; }
    /* Local override: keep labels above inputs to avoid covering placeholders */
    .review-field input { padding: 16px 12px; }
    .review-field label { top: -10px; transform: none; font-size: 12px; background: #fff; }
  </style>

  <main class="container" style="max-width:1200px; margin-top:24px; min-height:calc(100vh - 160px); display:flex; justify-content:center; align-items:flex-start;">
    <h1 style="margin-bottom:10px;">Add Course</h1>
    <p style="color:#6b7280;">Submit a new course. It becomes searchable but is hidden from index listing.</p>

    <section class="card" style="padding:28px; width:100%; max-width:900px; margin:0 auto;">
      <form id="course-form" aria-label="Add Course Form">
        <div class="review-field">
          <input id="course-code" placeholder="e.g., CS101 or GEMATMW" maxlength="8" required aria-describedby="code-error" style="width:100%;" list="course-code-list" />
          <datalist id="course-code-list"></datalist>
          <label>Course Code</label>
          </div>
        <div id="code-error" style="color:#dc2626; font-weight:600; display:none;">Code must be 3–8 uppercase letters or numbers.</div>

        <div class="review-field" style="margin-top:14px;">
          <input id="course-name" placeholder="e.g., Mathematics in The Modern World" required aria-describedby="name-error" style="width:100%;" />
          <label for="course-name">Course Name</label>
        </div>
        <div id="name-error" style="color:#dc2626; font-weight:600; display:none;">Enter the full course name (no code).</div>

        <button class="auth-btn" type="submit" style="margin-top:12px;">Submit</button>
        <p id="course-result" style="margin-top:10px; font-weight:600;" aria-live="polite"></p>
      </form>
    </section>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const headerContainer = document.getElementById('header-placeholder');
        const res = await fetch('/components/header.html');
        headerContainer.innerHTML = await res.text();
        await new Promise(requestAnimationFrame);
        if (!document.querySelector('script[src="/js/app.js"]')) {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = '/js/app.js';
            s.onload = resolve;
            s.onerror = () => reject(new Error('app.js load failed'));
            document.head.appendChild(s);
          });
        }
        if (window.updateSchoolLogo) window.updateSchoolLogo();
        if (window.initializeHeader) await window.initializeHeader();
        if (window.updateAuthUI) window.updateAuthUI();
      } catch (e) { console.warn('Header init failed', e); }
      try {
        const school = localStorage.getItem('selectedSchool') || 'dlsu';
        const titleEl = document.getElementById('site-title');
        const logoEl = document.querySelector('.school-logo');
        if (titleEl) titleEl.textContent = `${String(school||'').toUpperCase()} — PHROFS TO PICK`;
        if (logoEl) {
          const map = { dlsu:'images/dlsu-logo.png', ateneo:'images/ateneo-logo.png', benilde:'images/benilde-logo.png', up:'images/up-logo.png' };
          const src = map[String(school).toLowerCase()] || 'images/default-logo.png';
          logoEl.src = window.__PRELOADED_LOGO || src;
        }
      } catch (_) {}

      const form = document.getElementById('course-form');
      const codeInput = document.getElementById('course-code');
      const nameInput = document.getElementById('course-name');
      const codeErr = document.getElementById('code-error');
      const nameErr = document.getElementById('name-error');
      const resultEl = document.getElementById('course-result');
      function primaryColor() {
        try {
          const cs = getComputedStyle(document.documentElement);
          const v = cs.getPropertyValue('--primary').trim();
          return v || '#065f46';
        } catch (_) { return '#065f46'; }
      }
      function showOverlay(msg) {
        const ov = document.createElement('div');
        ov.style.position='fixed';
        ov.style.inset='0';
        ov.style.background='rgba(0,0,0,0.35)';
        ov.style.zIndex='9999';
        ov.style.display='flex';
        ov.style.alignItems='center';
        ov.style.justifyContent='center';
        const box = document.createElement('div');
        box.style.background='#fff';
        box.style.padding='16px 20px';
        box.style.borderRadius='12px';
        box.style.boxShadow='0 8px 24px rgba(0,0,0,0.18)';
        box.style.fontWeight='700';
        box.style.color=primaryColor();
        box.textContent = msg || 'Redirecting...';
        ov.appendChild(box);
        document.body.appendChild(ov);
        return ov;
      }

      const codeRe = /^[A-Z0-9]{3,8}$/;
      // Validation: 3–8 uppercase alphanumeric (A–Z, 0–9)
      function validateCode(raw){
        const code = String(raw||'').trim();
        if (!code) return { ok:false, reason:'empty' };
        if (code.length < 3 || code.length > 8) return { ok:false, reason:'length' };
        if (/[^A-Za-z0-9]/.test(code)) return { ok:false, reason:'alnumOnly' };
        if (code !== code.toUpperCase()) return { ok:false, reason:'uppercase' };
        return { ok:true, reason:null };
      }
      const nameRe = /^.{3,}$/;
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      let debounceT;
      let allCourses = [];
      async function autofillNameFromCode() {
        const code = (codeInput.value||'').trim().toUpperCase();
        if (!codeRe.test(code)) return;
        try {
          const r = await fetch(`/api/subjects?school=${school}&q=${encodeURIComponent(code)}`);
          const j = await r.json();
          const list = Array.isArray(j) ? j : (j.subjects||[]);
          const match = list.find(s => String(s.code||'').toUpperCase() === code) || list[0];
          if (match && match.name) {
            nameInput.value = `${match.name}`;
          }
        } catch (_) {}
      }
      codeInput.addEventListener('input', ()=>{
        clearTimeout(debounceT); debounceT = setTimeout(autofillNameFromCode, 250);
      });

      async function loadCourseList(){
        try{
          const r = await fetch(`/api/subjects?school=${school}`);
          const j = await r.json();
          allCourses = (Array.isArray(j)? j : (j.subjects||[])).slice().sort((a,b)=>String(a.code).localeCompare(String(b.code)));
          const dl = document.getElementById('course-code-list');
          if (dl) dl.innerHTML = allCourses.map(s => `<option value="${String(s.code||'').toUpperCase()}">${s.name||''}</option>`).join('');
        }catch(_){ /* noop */ }
      }

      await loadCourseList();
      codeInput.addEventListener('change', ()=>{ clearTimeout(debounceT); autofillNameFromCode(); });

      function clearValidation() {
        codeInput.removeAttribute('aria-invalid');
        nameInput.removeAttribute('aria-invalid');
        codeErr.style.display = 'none';
        nameErr.style.display = 'none';
      }

      codeInput.addEventListener('input', clearValidation);
      nameInput.addEventListener('input', clearValidation);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearValidation();
        resultEl.textContent = '';

        const code = (codeInput.value || '').trim();
        const name = (nameInput.value || '').trim();
        const v = validateCode(code);
        if (!v.ok) {
          codeErr.textContent = v.reason==='length' ? 'Code must be 3–8 characters.'
            : v.reason==='alnumOnly' ? 'Code must contain only letters or numbers (A–Z, 0–9).'
            : v.reason==='uppercase' ? 'Code must be uppercase (A–Z).'
            : 'Course code is required.';
          codeErr.style.display = 'block';
          codeInput.setAttribute('aria-invalid','true');
          return;
        }
        if (!nameRe.test(name)) { nameErr.style.display = 'block'; nameInput.setAttribute('aria-invalid','true'); return; }

        try {
          const r = await fetch(`/api/subjects/create?school=${school}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code.toUpperCase(), name })
          });
          const j = await r.json().catch(() => ({}));
          if (!r.ok) {
            resultEl.style.color = '#dc2626';
            resultEl.textContent = j.error || 'Submission failed';
            return;
          }
          resultEl.style.color = primaryColor();
          const ref = sessionStorage.getItem('referrer');
          const ov = showOverlay(ref==='add-professor' ? 'Returning to Add Professor...' : ref==='review' ? 'Returning to Review...' : 'Opening subject page...');
          if (ref === 'add-professor') {
            sessionStorage.setItem('refReturn', JSON.stringify({ from: 'add-course', createdCode: String(code).toUpperCase() }));
            setTimeout(() => { window.location.href = '/add-professor'; }, 800);
          } else if (ref === 'review') {
            sessionStorage.setItem('refReturn', JSON.stringify({ from: 'add-course', createdCode: String(code).toUpperCase() }));
            setTimeout(() => { window.location.href = '/review'; }, 800);
          } else {
            resultEl.innerHTML = `Course created. <a href="/subject?id=${j.id}">Open page</a>`;
            setTimeout(() => { window.location.href = `/subject?id=${j.id}`; }, 900);
          }
        } catch (err) {
          resultEl.style.color = '#dc2626';
          resultEl.textContent = 'Network error. Please try again.';
        }
      });
    });
  </script>
  <!-- Ensure app.js is available globally across pages -->
  <script src="/js/app.js"></script>
</body>
</html>
