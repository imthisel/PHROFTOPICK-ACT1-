<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    try {
      const hasToken = !!localStorage.getItem('token');
      const isLogout = sessionStorage.getItem('justLoggedOut') === '1';
      const skipLanding = sessionStorage.getItem('skipLanding') === '1';

      if (isLogout || !hasToken) {
        sessionStorage.removeItem('justLoggedOut');
        window.location.replace('home.html');
      } else {
        localStorage.setItem('visitedApp', '1');
        const lastPage = localStorage.getItem('lastVisitedPage');
        if (!skipLanding && lastPage && !lastPage.includes('home.html') && !lastPage.includes('school.html')) {
          localStorage.removeItem('lastVisitedPage');
          window.location.replace(lastPage);
        }
        if (skipLanding) {
          sessionStorage.removeItem('skipLanding');
        }
      }
    } catch (e) {
      window.location.replace('home.html');
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes" />
  <title>PHrofstopick ‚Äî Home</title>

  <link rel="icon" type="image/png" href="images/favicon.png">

  <!-- Preload the correct logo before header loads -->
  <script>
    (function preloadLogo() {
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const logoMap = {
        dlsu: 'images/dlsu-logo.png',
        ateneo: 'images/ateneo-logo.png',
        benilde: 'images/benilde-logo.png',
        up: 'images/up-logo.png',
      };
      const selectedLogo = logoMap[school] || 'images/default-logo.png';
      const img = new Image();
      img.src = selectedLogo;
      window.__PRELOADED_LOGO = selectedLogo;
    })();
  </script>

  <!-- Base design -->
  <link rel="stylesheet" href="css/base.css">
  <!-- Theme loader -->
  <script src="js/theme-loader.js" defer></script>

  <link rel="stylesheet" href="css/mobile-override.css">
  <style>
    .reviews-list { max-width: 860px; margin: 0 auto; display: flex; flex-direction: column; gap: 20px; }
    .review-card { background:#fff; border:2px solid #e5e7eb; border-radius:16px; padding:24px; position:relative; }
    .review-header { display:flex; align-items:center; gap:16px; margin-bottom:16px; }
    .review-avatar { width:56px; height:56px; border-radius:50%; object-fit:cover; background:linear-gradient(135deg,#f3f4f6 0%,#e5e7eb 100%); border:3px solid #e5e7eb; flex-shrink:0; }
    .review-user-name { font-weight:700; font-size:16px; color:#111827; margin-bottom:4px; }
    .review-meta { font-size:13px; color:#6b7280; display:flex; gap:12px; flex-wrap:wrap; }
    .review-rating { display:flex; align-items:center; gap:4px; margin-top:8px; font-size:16px; }
    .review-rating .stars { color:#fbbf24; }
    .review-content { margin:16px 0; color:#374151; line-height:1.6; }
    .review-tags { display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .review-tag { background:#f3f4f6; color:#6b7280; padding:4px 10px; border-radius:9999px; font-size:12px; font-weight:500; }
    .review-footer { margin-top:16px; padding-top:16px; border-top:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap; }
    .footer-timestamp { font-size:13px; color:#6b7280; white-space:nowrap; }
    .badge { display:inline-block; padding:6px 12px; border-radius:6px; font-size:12px; font-weight:600; white-space:nowrap; }
    .badge-success { background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color:#065f46; border:1px solid #6ee7b7; }
    .badge-danger { background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color:#991b1b; border:1px solid #fca5a5; }
    .badge-info { background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color:#1e40af; border:1px solid #93c5fd; }
    .badge-workload { background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color:#92400e; border:1px solid #fcd34d; }
    .badge-workload.badge-high { background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color:#991b1b; border:1px solid #fca5a5; }
    .badge-workload.badge-low { background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color:#065f46; border:1px solid #6ee7b7; }
    .review-view-count { position:absolute; top:20px; right:20px; display:flex; align-items:center; gap:6px; color:#6b7280; font-size:13px; }
    .review-view-count svg { width:18px; height:18px; }
    html { scroll-behavior: smooth; }
  </style>
</head>

<body>
  <!-- ===== HEADER PLACEHOLDER ===== -->
  <div id="header-placeholder"></div>
  <div id="spa-nav" style="position:sticky; top:0; background:#fff; z-index:50; padding:14px; border-bottom:1px solid #e5e7eb; display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
    <button id="nav-subjects" class="auth-btn" aria-controls="spa-container" aria-label="Show subjects" style="font-weight:800; padding:12px 18px;">Subjects</button>
    <button id="nav-notes" class="auth-btn" aria-controls="spa-container" aria-label="Show notes" style="font-weight:800; padding:12px 18px;">Notes</button>
    <button id="nav-reviews" class="auth-btn" aria-controls="spa-container" aria-label="Show reviews" style="font-weight:800; padding:12px 18px;">Reviews</button>
  </div>

  <!-- ===== MODAL (single copy) ===== -->
  <div id="modal" class="modal hidden">
    <div class="modal-inner" id="modal-content"></div>
    <button id="modal-close">‚úï</button>
  </div>

  <!-- ===== CONTENT ===== -->
  <main class="container fade-in">
    <!-- Search -->
    <div class="search-panel" id="subjects-search-panel" style="position: relative; display:none;">
      <input
        id="subject-search"
        type="text"
        placeholder="Search subject..."
        autocomplete="off"
      />
      <div id="index-suggestions" class="suggestions"></div>
      <button id="btn-search">Search</button>
      <button id="btn-list-all">List All Subjects</button>

    </div>


    <div id="spa-container" style="padding:16px 0; min-height:240px; transition:opacity .3s ease;">
    </div>

    <!-- Cards appear here -->
    <div id="prof-list" style="display:none"></div>
    <div id="subjects-list" class="results" style="display:none"></div>
    <div id="review-prof-list" class="results" style="display:none"></div>

  </main>

  <footer style="text-align:center; margin:16px 0 24px; color:#6b7280; font-size:12px;">
    This website is a registered business with the BIR and holds a valid DTI permit
  </footer>

  <!-- ===== SCRIPTS ===== -->
  <script>
    function initChangeSchoolButton() {
      const changeBtn = document.getElementById("change-school-btn");
      if (changeBtn) {
        changeBtn.style.display = "inline-block";
        changeBtn.onclick = () => {
          localStorage.removeItem("selectedSchool");
          window.location.href = "school.html";
        };
        console.log("‚úÖ Change School button initialized");
      } else {
        console.warn("‚ö†Ô∏è Change School button not found");
      }
    }
  </script>
  <script>
    (function(){
      const container = document.getElementById('spa-container');
      const btnSubjects = document.getElementById('nav-subjects');
      const btnNotes = document.getElementById('nav-notes');
      const btnReviews = document.getElementById('nav-reviews');
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const subjectsSearchPanel = document.getElementById('subjects-search-panel');
      const subjectsListEl = document.getElementById('subjects-list');
      const suggestionsEl = document.getElementById('index-suggestions');

      function setActive(btn){
        [btnSubjects, btnNotes, btnReviews].forEach(b=>{ if(!b)return; b.classList.toggle('active', b===btn); });
      }
      function showLoading(){ container.style.opacity='0.5'; container.innerHTML='<div class="card">Loading...</div>'; }
      function showError(){ container.style.opacity='1'; container.innerHTML='<div class="card">Failed to load</div>'; }

      function hideAll(){
        subjectsSearchPanel.style.display = 'none';
        subjectsListEl.style.display = 'none';
        if (suggestionsEl) { suggestionsEl.innerHTML=''; suggestionsEl.style.display='none'; }
        container.style.display = 'block';
        container.innerHTML = '';
      }

      async function loadSubjects(){
        btnSubjects && setActive(btnSubjects);
        subjectsSearchPanel.style.display = 'block';
        subjectsListEl.style.display = 'block';
        container.style.display = 'none';
        try{
          const r = await fetch(`/api/subjects?school=${school}`);
          const j = await r.json();
          let list = Array.isArray(j)? j : (j.subjects||[]);
          const seen = new Set();
          list = list.filter(s => { if (seen.has(s.id)) return false; seen.add(s.id); return true; });
          console.log('Subjects view', list.length);
          if (window.renderSubjects) window.renderSubjects(list);
          else {
            subjectsListEl.innerHTML = list.map(s => `
              <div class=\"card\">
                <h3>${s.code || '‚Äî'} ‚Äî ${s.name || ''}</h3>
                <a href=\"/subject.html?id=${s.id}\"><button class=\"auth-btn\">Open Subject Page</button></a>
              </div>
            `).join('');
          }
        }catch(e){ console.error('Subjects load error', e); subjectsListEl.innerHTML = '<div class="card">Failed to load subjects</div>'; }
      }

      async function loadNotes(){
        hideAll();
        showLoading();
        try{
          const r = await fetch(`/api/resources?school=${school}&limit=50`);
          const j = await r.json();
          const list = j.resources||[];
          console.log('SPA notes', list.length);
          if(!list.length){ container.innerHTML='<div class="card">No notes available</div>'; container.style.opacity='1'; return; }
          const heading = `<div class="container" style="display:flex; align-items:center; justify-content:space-between; margin:8px 0 12px;">
            <h2 style="margin:0; font-size:20px; font-weight:800; letter-spacing:-0.3px;">Recent Notes from All Subjects</h2>
            <span style="display:inline-block; padding:6px 10px; border:1px solid #e5e7eb; border-radius:9999px; font-size:12px; color:#374151;">üåê All Subjects</span>
          </div>`;
          function formatPH(ts){
            try{
              return new Intl.DateTimeFormat('en-PH',{timeZone:'Asia/Manila',year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date(ts));
            }catch(_){ return String(ts).slice(0,16); }
          }
          const html = heading + `<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:16px;">` +
            list.map(n=>`
              <div class="card" style="padding:16px;">
                <h3 style="margin:6px 0;">${n.title||n.file_name||'Note'}</h3>
                <div style="display:flex; gap:12px; color:#6b7280; font-size:12px; flex-wrap:wrap;">
                  <span>${formatPH(n.created_at)} (PH)</span>
                  <span>${(n.file_name||'').split('.').pop().toUpperCase()}</span>
                </div>
                <p style="color:#374151; font-size:13px; white-space:pre-wrap;">${(n.description||'').split('\n').slice(0,3).join('\n')}</p>
                <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px;">
                  ${n.file_path ? `<a href="${n.file_path}" target="_blank" rel="noopener" class="auth-btn" data-resid="${n.id}">View/Download</a>` : ''}
                  ${n.subject_id ? `<a href="/subject.html?id=${n.subject_id}" class="auth-btn">Open Subject Page</a>` : ''}
                </div>
              </div>
            `).join('') + `</div>`;
          container.innerHTML = html; container.style.opacity='1';
          container.querySelectorAll('a[data-resid]').forEach(a => {
            a.addEventListener('click', async () => {
              const id = a.getAttribute('data-resid');
              try { await fetch(`/api/resources/${id}/download?school=${school}`, { method: 'POST' }); } catch (_) {}
            });
          });
        }catch(e){ console.error('SPA notes error', e); showError(); }
      }

      async function loadReviews(){
        hideAll();
        showLoading();
        try{
          const r = await fetch(`/api/reviews/recent?school=${school}&limit=50`);
          const j = await r.json();
          let list = j.reviews||[];
          list = list.slice().sort((a,b)=>{
            const ta = new Date(a.created_at||0).getTime();
            const tb = new Date(b.created_at||0).getTime();
            return tb - ta;
          });
          console.log('SPA reviews', list.length);
          if(!list.length){ container.innerHTML='<div class="card">No recent reviews</div>'; container.style.opacity='1'; return; }
          const heading = `<div class="container" style="display:flex; align-items:center; justify-content:space-between; margin:8px 0 12px;">
            <h2 style="margin:0; font-size:20px; font-weight:800; letter-spacing:-0.3px;">Recent Reviews from All Subjects</h2>
            <span style="display:inline-block; padding:6px 10px; border:1px solid #e5e7eb; border-radius:9999px; font-size:12px; color:#374151;">üåê All Subjects</span>
          </div>`;
          function formatPH(ts){
            try{
              return new Intl.DateTimeFormat('en-PH',{timeZone:'Asia/Manila',year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date(ts));
            }catch(_){ return String(ts).slice(0,16); }
          }
          function relativeTime(ts){
            const d = new Date(ts).getTime();
            const diff = Math.max(0, Date.now() - d);
            const m = Math.floor(diff/60000), h = Math.floor(m/60), days = Math.floor(h/24);
            if (days > 0) return `${days} day${days>1?'s':''} ago`;
            if (h > 0) return `${h} hour${h>1?'s':''} ago`;
            return `${m} min${m>1?'s':''} ago`;
          }
          const html = heading + `<div class="reviews-list">` +
            list.map(v=>{
              const stars = Math.max(0, Math.min(5, Math.round(Number(v.rating||0))));
              const starDisplay = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(5-stars);
              const avatar = v.anonymous ? 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'56\' height=\'56\'%3E%3Crect fill=\'%23f3f4f6\' width=\'56\' height=\'56\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'24\'%3EA%3C/text%3E%3C/svg%3E' : (v.photo_path || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'56\' height=\'56\'%3E%3Crect fill=\'%23f3f4f6\' width=\'56\' height=\'56\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'24\'%3Eüë§%3C/text%3E%3C/svg%3E');
              const name = v.anonymous ? 'Anonymous' : (v.display_name||'User');
              const courseDisplay = (v.course_code||'').toString().toUpperCase().slice(0,7);
              const phDate = formatPH(v.created_at);
              const rel = relativeTime(v.created_at);
              const tags = (v.tags||'').split(',').map(t=>t.trim()).filter(Boolean);
              const badges = [];
              if (v.would_take_again === 'Yes') badges.push('<span class="badge badge-success">‚úì Would take again</span>');
              if (v.would_take_again === 'No') badges.push('<span class="badge badge-danger">‚úó Would not take again</span>');
              if (v.attainable_4) badges.push(`<span class=\"badge badge-info\">üéØ Attainability: ${v.attainable_4}</span>`);
              if (v.workload_rating) badges.push(`<span class=\"badge badge-workload badge-${String(v.workload_rating).toLowerCase()}\">üìö Workload: ${v.workload_rating}</span>`);
              if (v.deadline_leniency) badges.push(`<span class=\"badge badge-info\">üìÖ Deadlines: ${v.deadline_leniency}</span>`);
              return `
              <div class="review-card">
                <div class="review-view-count">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                  <span>${v.view_count||0}</span>
                </div>
                <div class="review-header">
                  <img src="${avatar}" alt="${name}" class="review-avatar">
                  <div>
                    <div class="review-user-name">${name}</div>
                    ${stars>0?`<div class="review-rating"><span class="stars">${starDisplay}</span> <span>${stars}/5</span></div>`:''}
                  </div>
                </div>
                <div class="review-content">
                  ${courseDisplay?`<p><strong>Course:</strong> ${courseDisplay}</p>`:''}
                  <p>${String(v.review_text||'')}</p>
                  ${tags.length?`<div class="review-tags">${tags.map(t=>`<span class="review-tag">${t}</span>`).join('')}</div>`:''}
                </div>
                <div class="review-footer">
                  <div class="footer-badges">${badges.join(' ')}</div>
                  <div class="footer-timestamp">${phDate} ‚Ä¢ ${rel}</div>
                </div>
              </div>`;
            }).join('') + `</div>`;
          container.innerHTML = html; container.style.opacity='1';
          container.scrollIntoView({ behavior:'smooth', block:'start' });
        }catch(e){ console.error('SPA reviews error', e); showError(); }
      }

      if(btnSubjects){ btnSubjects.addEventListener('click', ()=>{ loadSubjects(); }); }
      if(btnNotes){ btnNotes.addEventListener('click', ()=>{ setActive(btnNotes); loadNotes(); }); }
      if(btnReviews){ btnReviews.addEventListener('click', ()=>{ setActive(btnReviews); loadReviews(); }); }
      if(btnSubjects) { setActive(btnSubjects); loadSubjects(); }
    })();
  </script>

  <script src="js/app.js"></script>

    <!-- remove the static app.js include above (if present) and use this block below -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // 1) Inject header
      const res = await fetch("/components/header.html");
      if (!res.ok) throw new Error('Failed to fetch header');
      document.getElementById("header-placeholder").innerHTML = await res.text();

      // 2) Wait for DOM parsing
      await new Promise(resolve => requestAnimationFrame(resolve));

      // 3) Load app.js dynamically
      await new Promise((resolve, reject) => {
        if (document.querySelector('script[src="/js/app.js"]')) return resolve();
        const s = document.createElement('script');
        s.src = '/js/app.js';
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load app.js'));
        document.head.appendChild(s);
      });

      // 4) Initialize everything in correct order
      if (typeof updateSchoolLogo === "function") updateSchoolLogo();
      if (typeof initializeHeader === "function") await initializeHeader();
      if (typeof updateAuthUI === "function") updateAuthUI();
      if (typeof initializeHeaderSearch === "function") initializeHeaderSearch();
      if (typeof enableAutocomplete === "function") {
        enableAutocomplete("subject-search", "index-suggestions");
        enableAutocomplete("prof-search", "header-suggestions");
      }

      console.log("‚úÖ Header and app initialized (index)");
    } catch (err) {
      console.error("‚ùå Initialization failed:", err);
    }
  });
</script>

</body>
</html>
