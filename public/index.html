<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    try {
      const hasToken = !!localStorage.getItem('token');
      const isLogout = sessionStorage.getItem('justLoggedOut') === '1';
      const skipLanding = sessionStorage.getItem('skipLanding') === '1';

      if (isLogout || !hasToken) {
        sessionStorage.removeItem('justLoggedOut');
        window.location.replace('/home');
      } else {
        localStorage.setItem('visitedApp', '1');
        const lastPage = localStorage.getItem('lastVisitedPage');
        if (!skipLanding && lastPage && !(lastPage.includes('/home') || lastPage.includes('home.html')) && !(lastPage.includes('/school') || lastPage.includes('school.html'))) {
          localStorage.removeItem('lastVisitedPage');
          window.location.replace(lastPage);
        }
        if (skipLanding) {
          sessionStorage.removeItem('skipLanding');
        }
      }
    } catch (e) {
      window.location.replace('/home');
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes" />
  <title>PHrofstopick ‚Äî Home</title>
  <meta name="description" content="Browse professors, subjects, recent notes, and reviews for your school.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="/index">
  <meta property="og:title" content="Phroftopick ‚Äî Student Reviews and Notes">
  <meta property="og:description" content="Discover professors and subjects with community reviews and study resources.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://phroftopick.com/index">
  <meta property="og:image" content="/images/default-logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Phroftopick ‚Äî Student Reviews and Notes">
  <meta name="twitter:description" content="Discover professors and subjects with community reviews and study resources.">
  <meta name="twitter:image" content="/images/default-logo.png">

  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@600;700;800&display=swap" rel="stylesheet">

  <!-- Preload the correct logo before header loads -->
  <script>
    (function preloadLogo() {
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const logoMap = {
        dlsu: 'images/dlsu-logo.png',
        ateneo: 'images/ateneo-logo.png',
        benilde: 'images/benilde-logo.png',
        up: 'images/up-logo.png',
      };
      const selectedLogo = logoMap[school] || 'images/default-logo.png';
      const img = new Image();
      img.src = selectedLogo;
      window.__PRELOADED_LOGO = selectedLogo;
    })();
  </script>

  <!-- Base design -->
  <link rel="stylesheet" href="css/base.css">
  <!-- Theme loader -->
  <script src="js/theme-loader.js" defer></script>

  <link rel="stylesheet" href="css/mobile-override.css">
  <style>
    :root { --ease: ease-in-out; --t: .22s; }
    .hide-subjects { display: none !important; }
    #index-page { background-color: transparent; }
    #index-page .container { max-width: 1120px; }
    :root { --header-height: 64px; }
    /* Fixed controls bar (nav + search) */
    #index-controls { position: fixed; top: var(--header-height); left: 0; right: 0; z-index: 100; }
    #index-controls .index-controls-inner { max-width: 1120px; margin: 0 auto; padding: 10px 16px; }
    /* Typography: Inter for headings, Poppins for body */
    #index-page h1, #index-page h2, #index-page h3 { font-family: 'Inter', 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; letter-spacing: -0.2px; }
    #index-page h1 { font-size: 30px; font-weight: 800; }
    #index-page h2 { font-size: 22px; font-weight: 800; }
    #index-page h3 { font-size: 18px; font-weight: 700; }
    #index-page p, #index-page small, #index-page span, #index-page button, #index-page input { font-family: 'Poppins', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    /* Decorative background accents */
    #index-page::before { content:''; position:fixed; inset:-10% -10%; pointer-events:none; background: none; z-index:-1; }
    .reviews-list { max-width: 960px; margin: 0 auto; display: flex; flex-direction: column; gap: 24px; }
    .review-card { background:#fff; border:2px solid #e5e7eb; border-radius:16px; padding:24px; position:relative; cursor:pointer; transition: all var(--t) var(--ease); box-shadow: 0 6px 18px rgba(0,0,0,0.08); }
    .review-card:hover { transform: translateY(-2px); box-shadow: 0 12px 28px rgba(0,0,0,0.12); border-color: var(--primary); }
    .review-card:active { transform: translateY(0); box-shadow: 0 6px 18px rgba(0,0,0,0.12); }
    .review-card.selected { border-color: var(--primary); background: linear-gradient(135deg, rgba(0,105,62,0.03) 0%, rgba(0,0,0,0.01) 100%); box-shadow: 0 10px 20px rgba(0,105,62,0.15); }
    .review-header { display:flex; align-items:center; gap:16px; margin-bottom:16px; }
    .review-avatar { width:56px; height:56px; border-radius:50%; object-fit:cover; background:linear-gradient(135deg,#f9fafb 0%,#eef2f7 100%); border:3px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.08); flex-shrink:0; }
    .review-user-info { flex:1; }
    .review-user-name { font-weight:700; font-size:16px; color:#111827; margin-bottom:4px; letter-spacing:0.2px; }
    .review-meta { font-size:13px; color:#6b7280; display:flex; gap:12px; flex-wrap:wrap; }
    .review-rating { display:flex; align-items:center; gap:4px; margin-top:8px; font-size:16px; }
    .review-rating .stars { color:#fbbf24; }
    .review-content { margin:18px 0; color:#374151; line-height:1.7; }
    .review-tags { display:flex; flex-wrap:wrap; gap:8px; margin-top:14px; }
    .review-tag { background:#f3f4f6; color:#6b7280; padding:6px 12px; border-radius:9999px; font-size:12px; font-weight:600; }
    .review-footer { margin-top:16px; padding-top:16px; border-top:1px solid #e5e7eb; display:flex; justify-content:space-between; align-items:flex-start; gap:16px; flex-wrap:wrap; }
    .footer-timestamp { font-size:13px; color:#6b7280; white-space:nowrap; }
    .badge { display:inline-block; padding:6px 12px; border-radius:8px; font-size:12px; font-weight:700; white-space:nowrap; box-shadow: 0 1px 4px rgba(0,0,0,0.06); }
    .badge-success { background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color:#065f46; border:1px solid #6ee7b7; }
    .badge-danger { background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color:#991b1b; border:1px solid #fca5a5; }
    .badge-info { background:linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); color:#1e40af; border:1px solid #93c5fd; }
    .badge-workload { background:linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); color:#92400e; border:1px solid #fcd34d; }
    .badge-workload.badge-high { background:linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); color:#991b1b; border:1px solid #fca5a5; }
    .badge-workload.badge-low { background:linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); color:#065f46; border:1px solid #6ee7b7; }
    .review-view-count { position:absolute; top:20px; right:20px; display:flex; align-items:center; gap:6px; color:#6b7280; font-size:13px; }
    .review-view-count svg { width:18px; height:18px; }
    .review-card.zoomed { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(1.03); max-width:840px; width:92%; max-height:85vh; overflow-y:auto; z-index:10001; box-shadow:0 24px 48px rgba(0,0,0,0.28); animation: zoomIn .28s var(--ease); }
    @keyframes zoomIn { from { transform: translate(-50%, -50%) scale(0.96); opacity: 0; } to { transform: translate(-50%, -50%) scale(1.03); opacity: 1; } }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.55); backdrop-filter:blur(4px); z-index:10000; animation: fadeIn .25s var(--ease); }
    @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
    body.modal-open { overflow:hidden; }
    html { scroll-behavior: smooth; }

    #spa-nav { position: static; background: transparent; z-index:10; padding:0; border-bottom: none; display:flex; gap:14px; flex-wrap:wrap; justify-content:flex-start; box-shadow: none; }
    #spa-nav .auth-btn { background: transparent; border: none; border-radius: 12px; padding: 14px 22px; box-shadow: none; transition: color var(--t) var(--ease), background-color var(--t) var(--ease); font-weight:600 !important; font-size:16px; }
    #spa-nav .auth-btn:hover { background: rgba(0,0,0,0.06); }
    html.dark #spa-nav .auth-btn:hover { background: rgba(255,255,255,0.08); }
    #spa-nav .auth-btn:active { background: rgba(0,0,0,0.08); }
    html.dark #spa-nav .auth-btn:active { background: rgba(255,255,255,0.12); }
    #spa-nav .auth-btn:focus-visible { outline: 3px solid #2563eb; outline-offset: 2px; }
    #spa-nav .auth-btn.active { background: transparent; border-bottom: 2px solid currentColor; }
    /* School-specific text colors */
    body.dlsu #spa-nav .auth-btn { color:#00703C; }
    body.ateneo #spa-nav .auth-btn { color:#0033A0; }
    body.benilde #spa-nav .auth-btn { color:#006241; }
    body.up #spa-nav .auth-btn { color:#7B1113; }

    /* Global button style */
    #index-page .auth-btn { transition: all var(--t) var(--ease); border-radius: 12px; padding: 10px 16px; font-weight: 700; box-shadow: 0 6px 16px rgba(0,0,0,0.06); }
    #index-page .auth-btn:active { transform: translateY(1px); }
    #index-page .auth-btn:focus-visible { outline: 3px solid var(--ring); outline-offset: 2px; }
    #index-page .auth-btn.primary { background: var(--primary); color: var(--text-on-primary); border: 2px solid var(--primary); }
    #index-page .auth-btn.secondary { background: #fff; color: var(--primary); border: 2px solid #e5e7eb; }
    #index-page .auth-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 26px rgba(0,0,0,0.12); }
    #index-page .auth-btn .pulse { display:inline-block; width:6px; height:6px; border-radius:9999px; background: var(--accent); margin-left:8px; animation: pulse var(--t) var(--ease) alternate infinite; }
    @keyframes pulse { to { transform: scale(1.35); opacity: .7; } }

    /* Search bar area */
    #subjects-search-panel { background: #fff; border: 2px solid #e5e7eb; border-radius: 16px; padding: 16px; box-shadow: 0 6px 20px rgba(0,0,0,0.06); }
    /* Spacer to prevent overlap with fixed controls */
    #index-controls-spacer { height: 120px; }
    #subjects-search-panel input { border-radius: 12px; padding: 12px 14px; }
    #subjects-search-panel #btn-search, #subjects-search-panel #btn-list-all { border-radius: 12px; }

    /* Cards and results grid */
    #index-page .results { gap: 20px; }
    #index-page .card { border: 2px solid #e5e7eb; border-radius: 18px; box-shadow: 0 8px 24px rgba(0,0,0,0.08); transition: all var(--t) var(--ease); }
    #index-page .card:hover { transform: translateY(-2px); box-shadow: 0 16px 36px rgba(0,0,0,0.12); border-color: var(--primary); }
    #index-page .card h3 { margin: 6px 0 8px; }
  </style>
</head>

<body id="index-page">
  <!-- ===== HEADER PLACEHOLDER ===== -->
  <div id="header-placeholder"></div>
  <!-- Fixed controls: SPA nav + search bar -->
  <div id="index-controls">
    <div class="index-controls-inner">
      <div id="spa-nav" aria-label="Section navigation">
        <button id="nav-subjects" class="auth-btn" aria-controls="spa-container" aria-label="Show subjects">Subjects</button>
        <button id="nav-notes" class="auth-btn" aria-controls="spa-container" aria-label="Show notes">Notes</button>
        <button id="nav-reviews" class="auth-btn" aria-controls="spa-container" aria-label="Show reviews">Reviews</button>
      </div>
      <div class="search-panel" id="subjects-search-panel" style="position: relative; display:none;">
        <input
          id="subject-search"
          type="text"
          placeholder="Search subject..."
          autocomplete="off"
        />
        <div id="index-suggestions" class="suggestions"></div>
        <button id="btn-search">Search</button>
        <button id="btn-list-all">List All Subjects</button>
      </div>
    </div>
  </div>
  <div id="index-controls-spacer"></div>

  <!-- ===== MODAL (single copy) ===== -->
  <div id="modal" class="modal hidden">
    <div class="modal-inner" id="modal-content"></div>
    <button id="modal-close">‚úï</button>
  </div>

  <!-- ===== CONTENT ===== -->
  <main class="container fade-in">
    <!-- Search moved to fixed controls -->


    <div id="spa-container" style="padding:16px 0; min-height:240px; transition:opacity .3s ease;">
    </div>

    <!-- Cards appear here -->
    <div id="prof-list" style="display:none"></div>
    <div id="subjects-list" class="results" style="display:none"></div>
    <div id="review-prof-list" class="results" style="display:none"></div>

  </main>

  <footer style="text-align:center; margin:16px 0 24px; color:#6b7280; font-size:12px;">
    This website is a registered business with the BIR and holds a valid DTI permit
  </footer>

  <!-- ===== SCRIPTS ===== -->
  <script>
    function initChangeSchoolButton() {
      const changeBtn = document.getElementById("change-school-btn");
      if (changeBtn) {
        changeBtn.style.display = "inline-block";
        changeBtn.onclick = () => {
          localStorage.removeItem("selectedSchool");
          window.location.href = "/school";
        };
        console.log("‚úÖ Change School button initialized");
      } else {
        console.warn("‚ö†Ô∏è Change School button not found");
      }
    }
  </script>
  <script>
    (function(){
      const container = document.getElementById('spa-container');
      const btnSubjects = document.getElementById('nav-subjects');
      const btnNotes = document.getElementById('nav-notes');
      const btnReviews = document.getElementById('nav-reviews');
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const subjectsSearchPanel = document.getElementById('subjects-search-panel');
      const subjectsListEl = document.getElementById('subjects-list');
      const suggestionsEl = document.getElementById('index-suggestions');
      const subjectElements = [subjectsSearchPanel, subjectsListEl, suggestionsEl].filter(Boolean);
      let currentSection = 'subjects';

      function setActive(btn){
        [btnSubjects, btnNotes, btnReviews].forEach(b=>{ if(!b)return; b.classList.toggle('active', b===btn); });
      }
      function showLoading(){ container.style.opacity='0.5'; container.innerHTML='<div class="card">Loading...</div>'; }
      function showError(){ container.style.opacity='1'; container.innerHTML='<div class="card">Failed to load</div>'; }

      function hideAll(){
        applySubjectVisibilityState(true);
        if (suggestionsEl) { suggestionsEl.innerHTML=''; }
        container.style.display = 'block';
        container.innerHTML = '';
      }

      function applySubjectVisibilityState(hidden){
        localStorage.setItem('hideSubjects', hidden ? '1' : '0');
        subjectElements.forEach(el=>{
          if(hidden){ el.classList.add('hide-subjects'); el.style.display='none'; }
          else { el.classList.remove('hide-subjects'); el.style.display=''; }
        });
      }

      async function loadSubjects(){
        btnSubjects && setActive(btnSubjects);
        applySubjectVisibilityState(false);
        subjectsSearchPanel.style.display = 'block';
        subjectsListEl.style.display = 'block';
        container.style.display = 'none';
        currentSection = 'subjects';
        localStorage.setItem('activeSection', currentSection);
        try{
          const r = await fetch(`/api/subjects?school=${school}`);
          const j = await r.json();
          let list = Array.isArray(j)? j : (j.subjects||[]);
          const seen = new Set();
          list = list.filter(s => { if (seen.has(s.id)) return false; seen.add(s.id); return true; });
          console.log('Subjects view', list.length);
          if (window.renderSubjects) window.renderSubjects(list);
          else {
            subjectsListEl.innerHTML = list.map(s => `
              <div class=\"card\">
                <h3>${s.code || '‚Äî'} ‚Äî ${s.name || ''}</h3>
                <a href=\"/subject?id=${s.id}\"><button class=\"auth-btn\">Open Subject Page</button></a>
              </div>
            `).join('');
          }
        }catch(e){ console.error('Subjects load error', e); subjectsListEl.innerHTML = '<div class="card">Failed to load subjects</div>'; }
      }

      async function loadNotes(){
        hideAll();
        showLoading();
        currentSection = 'notes';
        localStorage.setItem('activeSection', currentSection);
        try{
          const r = await fetch(`/api/resources?school=${school}&limit=50`);
          const j = await r.json();
          const list = j.resources||[];
          console.log('SPA notes', list.length);
          if(!list.length){ container.innerHTML='<div class="card">No notes available</div>'; container.style.opacity='1'; return; }
          const heading = `<div class="container" style="display:flex; align-items:center; justify-content:space-between; margin:8px 0 12px;">
            <h2 style="margin:0; font-size:20px; font-weight:800; letter-spacing:-0.3px;">Recent Notes from All Subjects</h2>
            <span style="display:inline-block; padding:6px 10px; border:1px solid #e5e7eb; border-radius:9999px; font-size:12px; color:#374151;">üåê All Subjects</span>
          </div>`;
          function formatPH(ts){
            try{
              return new Intl.DateTimeFormat('en-PH',{timeZone:'Asia/Manila',year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date(ts));
            }catch(_){ return String(ts).slice(0,16); }
          }
          const html = heading + `<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:16px;">` +
            list.map(n=>`
              <div class="card" style="padding:16px;">
                <h3 style="margin:6px 0;">${n.title||n.file_name||'Note'}</h3>
                <div style="display:flex; gap:12px; color:#6b7280; font-size:12px; flex-wrap:wrap;">
                  <span>${formatPH(n.created_at)} (PH)</span>
                  <span>${(n.file_name||'').split('.').pop().toUpperCase()}</span>
                </div>
                <p style="color:#374151; font-size:13px; white-space:pre-wrap;">${(n.description||'').split('\n').slice(0,3).join('\n')}</p>
                <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:8px;">
                  ${n.file_path ? `<a href="${n.file_path}" target="_blank" rel="noopener" class="auth-btn" data-resid="${n.id}">View/Download</a>` : ''}
                  ${n.subject_id ? `<a href="/subject?id=${n.subject_id}" class="auth-btn">Open Subject Page</a>` : ''}
                </div>
              </div>
            `).join('') + `</div>`;
          container.innerHTML = html; container.style.opacity='1';
          container.querySelectorAll('a[data-resid]').forEach(a => {
            a.addEventListener('click', async () => {
              const id = a.getAttribute('data-resid');
              try { await fetch(`/api/resources/${id}/download?school=${school}`, { method: 'POST' }); } catch (_) {}
            });
          });
        }catch(e){ console.error('SPA notes error', e); showError(); }
      }

      async function loadReviews(){
        hideAll();
        showLoading();
        currentSection = 'reviews';
        localStorage.setItem('activeSection', currentSection);
        try{
          const r = await fetch(`/api/reviews/recent?school=${school}&limit=50`);
          const j = await r.json();
          let list = j.reviews||[];
          list = list.slice().sort((a,b)=>{
            const ta = new Date(a.created_at||0).getTime();
            const tb = new Date(b.created_at||0).getTime();
            return tb - ta;
          });
          console.log('SPA reviews', list.length);
          if(!list.length){ container.innerHTML='<div class="card">No recent reviews</div>'; container.style.opacity='1'; return; }
          const heading = `<div class="container" style="display:flex; align-items:center; justify-content:space-between; margin:8px 0 12px;">
            <h2 style="margin:0; font-size:20px; font-weight:800; letter-spacing:-0.3px;">Recent Reviews from All Subjects</h2>
            <span style="display:inline-block; padding:6px 10px; border:1px solid #e5e7eb; border-radius:9999px; font-size:12px; color:#374151;">üåê All Subjects</span>
          </div>`;
          function formatPH(ts){
            try{
              return new Intl.DateTimeFormat('en-PH',{timeZone:'Asia/Manila',year:'numeric',month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit'}).format(new Date(ts));
            }catch(_){ return String(ts).slice(0,16); }
          }
          function relativeTime(ts){
            const d = new Date(ts).getTime();
            const diff = Math.max(0, Date.now() - d);
            const m = Math.floor(diff/60000), h = Math.floor(m/60), days = Math.floor(h/24);
            if (days > 0) return `${days} day${days>1?'s':''} ago`;
            if (h > 0) return `${h} hour${h>1?'s':''} ago`;
            return `${m} min${m>1?'s':''} ago`;
          }
          const html = heading + `<div class="reviews-list">` +
            list.map(v=>{
              const stars = Math.max(0, Math.min(5, Math.round(Number(v.rating||0))));
              const starDisplay = '‚òÖ'.repeat(stars) + '‚òÜ'.repeat(5 - stars);
              const avatarSrc = v.anonymous ? 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'56\' height=\'56\'%3E%3Crect fill=\'%23f3f4f6\' width=\'56\' height=\'56\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'24\'%3EA%3C/text%3E%3C/svg%3E' : (v.photo_path || 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'56\' height=\'56\'%3E%3Crect fill=\'%23f3f4f6\' width=\'56\' height=\'56\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'24\'%3Eüë§%3C/text%3E%3C/svg%3E');
              const displayName = v.anonymous ? 'Anonymous' : (v.display_name || 'User');
              const metaInfo = v.anonymous ? '' : [
                v.college ? `College: ${v.college}` : '',
                v.batch_id ? `Batch: ${v.batch_id}` : ''
              ].filter(Boolean).join(' ‚Ä¢ ');
              const tags = (v.tags||'').split(',').map(t=>t.trim()).filter(Boolean);
              const courseDisplay = (v.course_code||'').toString().toUpperCase().slice(0,7);
              const phDate = formatPH(v.created_at);
              const badges = [];
              if (v.would_take_again === 'Yes') badges.push('<span class="badge badge-success">‚úì Would take again</span>');
              if (v.would_take_again === 'No') badges.push('<span class="badge badge-danger">‚úó Would not take again</span>');
              if (v.attainable_4) badges.push(`<span class=\"badge badge-info\">üéØ Attainability: ${v.attainable_4}</span>`);
              if (v.workload_rating) badges.push(`<span class=\"badge badge-workload badge-${String(v.workload_rating).toLowerCase()}\">üìö Workload: ${v.workload_rating}</span>`);
              if (v.deadline_leniency) badges.push(`<span class=\"badge badge-deadline\">üìÖ Deadlines: ${v.deadline_leniency}</span>`);
              return `
              <div class="review-card" data-review-id="${v.id}">
                <div class="review-view-count">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
                  <span>${v.view_count || 0}</span>
                </div>
                <div class="review-header">
                  <img src="${avatarSrc}" alt="${displayName}" class="review-avatar" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'56\' height=\'56\'%3E%3Crect fill=\'%23f3f4f6\' width=\'56\' height=\'56\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%239ca3af\' font-size=\'24\'%3Eüë§%3C/text%3E%3C/svg%3E'">
                  <div class="review-user-info">
                    <div class="review-user-name">${displayName}</div>
                    ${metaInfo ? `<div class="review-meta">${metaInfo}</div>` : ''}
                    ${stars > 0 ? `<div class="review-rating"><span class="stars">${starDisplay}</span> <span>${stars}/5</span></div>` : ''}
                  </div>
                </div>
                <div class="review-content">
                  ${courseDisplay ? `<p><strong>Course:</strong> ${courseDisplay}</p>` : ''}
                  <p>${String(v.review_text||'')}</p>
                  ${tags.length ? `<div class="review-tags">${tags.map(t => `<span class=\"review-tag\">${t}</span>`).join('')}</div>` : ''}
                </div>
                <div class="review-footer">
                  <div class="footer-badges">${badges.join(' ')}</div>
                  <div class="footer-timestamp">${phDate}</div>
                </div>
              </div>`;
            }).join('') + `</div>`;
          container.innerHTML = html; container.style.opacity='1';
          container.scrollIntoView({ behavior:'smooth', block:'start' });

          container.querySelectorAll('.review-card').forEach(card => {
            card.addEventListener('click', async (e) => {
              e.stopPropagation();
              const isZoomed = card.classList.contains('zoomed');
              if (isZoomed) {
                card.classList.remove('zoomed');
                document.body.classList.remove('modal-open');
                const overlay = document.querySelector('.modal-overlay');
                if (overlay) overlay.remove();
              } else {
                document.querySelectorAll('.review-card.zoomed').forEach(c => c.classList.remove('zoomed'));
                const overlay = document.createElement('div');
                overlay.className = 'modal-overlay';
                overlay.addEventListener('click', () => {
                  card.classList.remove('zoomed');
                  document.body.classList.remove('modal-open');
                  overlay.remove();
                });
                document.body.appendChild(overlay);
                card.classList.add('zoomed');
                document.body.classList.add('modal-open');
                const reviewId = card.getAttribute('data-review-id');
                try {
                  await fetch(`/api/reviews/${reviewId}/view?school=${school}`, { method: 'POST' });
                  const viewCountEl = card.querySelector('.review-view-count span');
                  if (viewCountEl) {
                    const currentCount = parseInt(viewCountEl.textContent) || 0;
                    viewCountEl.textContent = currentCount + 1;
                  }
                } catch (e) {
                  console.error('Failed to increment view count:', e);
                }
              }
            });
          });
        }catch(e){ console.error('SPA reviews error', e); showError(); }
      }

      if(btnSubjects){ btnSubjects.addEventListener('click', ()=>{ setActive(btnSubjects); applySubjectVisibilityState(false); loadSubjects(); }); }
      if(btnNotes){ btnNotes.addEventListener('click', ()=>{ setActive(btnNotes); applySubjectVisibilityState(true); loadNotes(); }); }
      if(btnReviews){ btnReviews.addEventListener('click', ()=>{ setActive(btnReviews); applySubjectVisibilityState(true); loadReviews(); }); }
      if(btnSubjects) { setActive(btnSubjects); applySubjectVisibilityState(false); loadSubjects(); }
    })();
  </script>

  <script src="js/app.js"></script>

    <!-- remove the static app.js include above (if present) and use this block below -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // 1) Inject header
      const res = await fetch("/components/header.html");
      if (!res.ok) throw new Error('Failed to fetch header');
      document.getElementById("header-placeholder").innerHTML = await res.text();

      // 2) Wait for DOM parsing
      await new Promise(resolve => requestAnimationFrame(resolve));

      // 3) Load app.js dynamically
      await new Promise((resolve, reject) => {
        if (document.querySelector('script[src="/js/app.js"]')) return resolve();
        const s = document.createElement('script');
        s.src = '/js/app.js';
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load app.js'));
        document.head.appendChild(s);
      });

      // 4) Initialize everything in correct order
      if (typeof updateSchoolLogo === "function") updateSchoolLogo();
      if (typeof initializeHeader === "function") await initializeHeader();
      if (typeof updateAuthUI === "function") updateAuthUI();
      if (typeof initializeHeaderSearch === "function") initializeHeaderSearch();
      if (typeof enableAutocomplete === "function") {
        enableAutocomplete("subject-search", "index-suggestions");
        enableAutocomplete("prof-search", "header-suggestions");
      }
      // Reserve space for fixed controls and align below header
      const headerEl = document.querySelector(".site-header");
      const controls = document.getElementById("index-controls");
      const spacer = document.getElementById("index-controls-spacer");
      function updateHeights() {
        const hh = headerEl ? headerEl.offsetHeight : 64;
        document.documentElement.style.setProperty("--header-height", hh + "px");
        if (controls && spacer) {
          spacer.style.height = controls.offsetHeight + "px";
        }
      }
      updateHeights();
      window.addEventListener("resize", updateHeights);

      console.log("‚úÖ Header and app initialized (index)");
    } catch (err) {
      console.error("‚ùå Initialization failed:", err);
    }
  });
</script>

</body>
</html>
