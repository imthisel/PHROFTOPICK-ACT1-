<!DOCTYPE html>
<html lang="en">
<head>
  <script>
    try {
      const hasToken = !!localStorage.getItem('token');
      const isLogout = sessionStorage.getItem('justLoggedOut') === '1';
      const skipLanding = sessionStorage.getItem('skipLanding') === '1';

      if (isLogout || !hasToken) {
        sessionStorage.removeItem('justLoggedOut');
        window.location.replace('home.html');
      } else {
        localStorage.setItem('visitedApp', '1');
        const lastPage = localStorage.getItem('lastVisitedPage');
        if (!skipLanding && lastPage && !lastPage.includes('home.html') && !lastPage.includes('school.html')) {
          localStorage.removeItem('lastVisitedPage');
          window.location.replace(lastPage);
        }
        if (skipLanding) {
          sessionStorage.removeItem('skipLanding');
        }
      }
    } catch (e) {
      window.location.replace('home.html');
    }
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes" />
  <title>PHrofstopick — Home</title>

  <link rel="icon" type="image/png" href="images/favicon.png">

  <!-- Preload the correct logo before header loads -->
  <script>
    (function preloadLogo() {
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const logoMap = {
        dlsu: 'images/dlsu-logo.png',
        ateneo: 'images/ateneo-logo.png',
        benilde: 'images/benilde-logo.png',
        up: 'images/up-logo.png',
      };
      const selectedLogo = logoMap[school] || 'images/default-logo.png';
      const img = new Image();
      img.src = selectedLogo;
      window.__PRELOADED_LOGO = selectedLogo;
    })();
  </script>

  <!-- Base design -->
  <link rel="stylesheet" href="css/base.css">
  <!-- Theme loader -->
  <script src="js/theme-loader.js" defer></script>

  <link rel="stylesheet" href="css/mobile-override.css">
</head>

<body>
  <!-- ===== HEADER PLACEHOLDER ===== -->
  <div id="header-placeholder"></div>
  <div id="spa-nav" style="position:sticky; top:0; background:#fff; z-index:50; padding:14px; border-bottom:1px solid #e5e7eb; display:flex; gap:12px; flex-wrap:wrap; justify-content:center;">
    <button id="nav-subjects" class="auth-btn" aria-controls="spa-container" aria-label="Show subjects" style="font-weight:800; padding:12px 18px;">Subjects</button>
    <button id="nav-notes" class="auth-btn" aria-controls="spa-container" aria-label="Show notes" style="font-weight:800; padding:12px 18px;">Notes</button>
    <button id="nav-reviews" class="auth-btn" aria-controls="spa-container" aria-label="Show reviews" style="font-weight:800; padding:12px 18px;">Reviews</button>
  </div>

  <!-- ===== MODAL (single copy) ===== -->
  <div id="modal" class="modal hidden">
    <div class="modal-inner" id="modal-content"></div>
    <button id="modal-close">✕</button>
  </div>

  <!-- ===== CONTENT ===== -->
  <main class="container fade-in">
    <!-- Search -->
    <div class="search-panel" id="subjects-search-panel" style="position: relative; display:none;">
      <input
        id="subject-search"
        type="text"
        placeholder="Search subject..."
        autocomplete="off"
      />
      <div id="index-suggestions" class="suggestions"></div>
      <button id="btn-search">Search</button>
      <button id="btn-list-all">List All Subjects</button>

    </div>


    <div id="spa-container" style="padding:16px 0; min-height:240px; transition:opacity .25s ease;">
    </div>

    <!-- Cards appear here -->
    <div id="prof-list" style="display:none"></div>
    <div id="subjects-list" class="results" style="display:none"></div>
    <div id="review-prof-list" class="results" style="display:none"></div>

  </main>

  <footer style="text-align:center; margin:16px 0 24px; color:#6b7280; font-size:12px;">
    This website is a registered business with the BIR and holds a valid DTI permit
  </footer>

  <!-- ===== SCRIPTS ===== -->
  <script>
    function initChangeSchoolButton() {
      const changeBtn = document.getElementById("change-school-btn");
      if (changeBtn) {
        changeBtn.style.display = "inline-block";
        changeBtn.onclick = () => {
          localStorage.removeItem("selectedSchool");
          window.location.href = "school.html";
        };
        console.log("✅ Change School button initialized");
      } else {
        console.warn("⚠️ Change School button not found");
      }
    }
  </script>
  <script>
    (function(){
      const container = document.getElementById('spa-container');
      const btnSubjects = document.getElementById('nav-subjects');
      const btnNotes = document.getElementById('nav-notes');
      const btnReviews = document.getElementById('nav-reviews');
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const subjectsSearchPanel = document.getElementById('subjects-search-panel');
      const subjectsListEl = document.getElementById('subjects-list');

      function setActive(btn){
        [btnSubjects, btnNotes, btnReviews].forEach(b=>{ if(!b)return; b.classList.toggle('active', b===btn); });
      }
      function showLoading(){ container.style.opacity='0.5'; container.innerHTML='<div class="card">Loading...</div>'; }
      function showError(){ container.style.opacity='1'; container.innerHTML='<div class="card">Failed to load</div>'; }

      function hideAll(){
        subjectsSearchPanel.style.display = 'none';
        subjectsListEl.style.display = 'none';
        container.style.display = 'block';
        container.innerHTML = '';
      }

      async function loadSubjects(){
        btnSubjects && setActive(btnSubjects);
        subjectsSearchPanel.style.display = 'block';
        subjectsListEl.style.display = 'block';
        container.style.display = 'none';
        try{
          const r = await fetch(`/api/subjects?school=${school}`);
          const j = await r.json();
          let list = Array.isArray(j)? j : (j.subjects||[]);
          const seen = new Set();
          list = list.filter(s => { if (seen.has(s.id)) return false; seen.add(s.id); return true; });
          console.log('Subjects view', list.length);
          if (window.renderSubjects) window.renderSubjects(list);
          else subjectsListEl.innerHTML = '<div class="card">Failed to render subjects</div>';
        }catch(e){ console.error('Subjects load error', e); subjectsListEl.innerHTML = '<div class="card">Failed to load subjects</div>'; }
      }

      async function loadNotes(){
        hideAll();
        showLoading();
        try{
          const r = await fetch(`/api/resources?school=${school}&limit=50`);
          const j = await r.json();
          const list = j.resources||[];
          console.log('SPA notes', list.length);
          if(!list.length){ container.innerHTML='<div class="card">No notes available</div>'; container.style.opacity='1'; return; }
          const html = `<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:16px;">` +
            list.map(n=>`
              <div class="card" style="padding:14px;">
                <h3 style="margin:6px 0;">${n.title||n.file_name||'Note'}</h3>
                <p style="color:#374151; font-size:13px;">${n.description||''}</p>
                <div style="display:flex; gap:12px; color:#6b7280; font-size:12px;">
                  <span>${(n.created_at||'').toString().slice(0,16)}</span>
                  <span>${(n.file_name||'').split('.').pop().toUpperCase()}</span>
                </div>
                ${n.file_path ? `<a href="${n.file_path}" target="_blank" rel="noopener" class="auth-btn" data-resid="${n.id}">View/Download</a>` : ''}
              </div>
            `).join('') + `</div>`;
          container.innerHTML = html; container.style.opacity='1';
          container.querySelectorAll('a[data-resid]').forEach(a => {
            a.addEventListener('click', async () => {
              const id = a.getAttribute('data-resid');
              try { await fetch(`/api/resources/${id}/download?school=${school}`, { method: 'POST' }); } catch (_) {}
            });
          });
        }catch(e){ console.error('SPA notes error', e); showError(); }
      }

      async function loadReviews(){
        hideAll();
        showLoading();
        try{
          const r = await fetch(`/api/reviews/recent?school=${school}&limit=20`);
          const j = await r.json();
          const list = j.reviews||[];
          console.log('SPA reviews', list.length);
          if(!list.length){ container.innerHTML='<div class="card">No recent reviews</div>'; container.style.opacity='1'; return; }
          const html = `<div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:16px;">` +
            list.map(v=>{
              const stars = Math.max(0, Math.min(5, Math.round(Number(v.rating||0))));
              const starDisplay = '★'.repeat(stars) + '☆'.repeat(5-stars);
              return `
              <div class="card" style="padding:14px;">
                <h3 style="margin:6px 0;">${v.professor_name||'Professor'}</h3>
                <div style="color:#111827; font-size:13px; margin-bottom:6px;">${starDisplay}</div>
                <p style="color:#374151; font-size:13px; white-space:pre-wrap;">${String(v.review_text||'')}</p>
                <div style="display:flex; gap:12px; color:#6b7280; font-size:12px;">
                  <span>${(v.created_at||'').toString().slice(0,16)}</span>
                </div>
              </div>`;
            }).join('') + `</div>`;
          container.innerHTML = html; container.style.opacity='1';
        }catch(e){ console.error('SPA reviews error', e); showError(); }
      }

      if(btnSubjects){ btnSubjects.addEventListener('click', ()=>{ loadSubjects(); }); }
      if(btnNotes){ btnNotes.addEventListener('click', ()=>{ setActive(btnNotes); loadNotes(); }); }
      if(btnReviews){ btnReviews.addEventListener('click', ()=>{ setActive(btnReviews); loadReviews(); }); }
      if(btnSubjects) { setActive(btnSubjects); loadSubjects(); }
    })();
  </script>

  <script src="js/app.js"></script>

    <!-- remove the static app.js include above (if present) and use this block below -->
  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    try {
      // 1) Inject header
      const res = await fetch("/components/header.html");
      if (!res.ok) throw new Error('Failed to fetch header');
      document.getElementById("header-placeholder").innerHTML = await res.text();

      // 2) Wait for DOM parsing
      await new Promise(resolve => requestAnimationFrame(resolve));

      // 3) Load app.js dynamically
      await new Promise((resolve, reject) => {
        if (document.querySelector('script[src="/js/app.js"]')) return resolve();
        const s = document.createElement('script');
        s.src = '/js/app.js';
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load app.js'));
        document.head.appendChild(s);
      });

      // 4) Initialize everything in correct order
      if (typeof updateSchoolLogo === "function") updateSchoolLogo();
      if (typeof initializeHeader === "function") await initializeHeader();
      if (typeof updateAuthUI === "function") updateAuthUI();
      if (typeof initializeHeaderSearch === "function") initializeHeaderSearch();
      if (typeof enableAutocomplete === "function") {
        enableAutocomplete("subject-search", "index-suggestions");
        enableAutocomplete("prof-search", "header-suggestions");
      }

      console.log("✅ Header and app initialized (index)");
    } catch (err) {
      console.error("❌ Initialization failed:", err);
    }
  });
</script>

</body>
</html>
