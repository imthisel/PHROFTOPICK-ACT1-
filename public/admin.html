<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="description" content="Admin dashboard for managing users, subjects, and content.">
  <meta name="robots" content="noindex, nofollow">
  <link rel="canonical" href="/admin">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Admin - View Registered Emails</title>
  <link rel="stylesheet" href="css/base.css">
  <link rel="stylesheet" href="css/mobile-override.css">
  <style>
    /* Admin page layout refinements for visibility & responsiveness */
    .admin-container { max-width: 1280px; margin: 32px auto; padding: 16px; }
    .admin-header {
      background: linear-gradient(135deg, #0a6a42 0%, #06442a 100%);
      color: #ffffff;
      padding: 24px;
      border-radius: 16px;
      margin-bottom: 24px;
    }
    .admin-header h1 {
      margin: 0 0 6px 0;
      font-size: 32px;
    }
    .login-form { background: white; padding: 24px; border-radius: 16px; box-shadow: 0 6px 16px rgba(0,0,0,0.08); max-width: 480px; margin: 24px auto; }
    .login-form input {
      width: 100%; padding: 12px 14px; margin: 8px 0 12px; border: 2px solid #d1d5db; border-radius: 10px; font-size: 16px;
    }
    .login-form button { width: 100%; padding: 12px; background: #00693e; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 8px; }
    .login-form button:hover { background: #005634; }
    .error-message {
      color: #991b1b; margin-top: 10px; padding: 10px; background: #fee2e2; border-radius: 10px; display: none;
    }
    .users-table { background: white; border-radius: 16px; box-shadow: 0 6px 16px rgba(0,0,0,0.08); overflow: hidden; }
    .table-header {
      background: #f8fafc; padding: 16px 20px; border-bottom: 2px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;
    }
    .table-header h2 { margin: 0; font-size: 20px; color: #111827; }
    .stats { display: grid; grid-template-columns: repeat(auto-fill,minmax(180px,1fr)); gap: 16px; margin-bottom: 16px; }
    .stat-card {
      background: white; padding: 16px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); flex: 1;
    }
    .stat-card h3 {
      margin: 0 0 4px; color: #374151; font-size: 13px; font-weight: 700;
    }
    .stat-card .value {
      font-size: 28px; font-weight: 800; color: #0a6a42;
    }
    table { width: 100%; border-collapse: collapse; }
    thead {
      background: #f3f4f6;
    }
    th {
      padding: 14px; text-align: left; font-weight: 700; color: #111827; border-bottom: 2px solid #e5e7eb; vertical-align: top; word-break: break-word;
    }
    td {
      padding: 14px; border-bottom: 1px solid #e5e7eb; vertical-align: top; word-break: break-word;
    }
    tr:hover {
      background: #f9fafb;
    }
    #users-list { overflow-x: auto; }
    #users-list table { min-width: 900px; }
    .school-filter { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0 16px; }
    .school-filter button {
      padding: 8px 14px; border: 2px solid #0a6a42; background: white; color: #0a6a42; border-radius: 10px; cursor: pointer; font-weight: 700; transition: all 0.2s ease;
    }
    .school-filter button.active {
      background: #0a6a42; color: white;
    }
    .school-filter button:hover {
      background: #005634; color: white; border-color: #005634;
    }
    .export-btn {
      padding: 10px 16px; background: #0a6a42; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; margin-left: 10px;
    }
    .export-btn:hover {
      background: #005634;
    }
    .loading {
      text-align: center; padding: 32px; color: #374151;
    }
    .no-data {
      text-align: center; padding: 32px; color: #6b7280;
    }
    .action-btn:focus-visible, .export-btn:focus-visible, .input:focus-visible { outline: 3px solid rgba(0,105,62,0.4); outline-offset: 2px; }
    @media (max-width: 1024px) {
      .admin-container { padding: 12px; }
      .admin-header { padding: 20px; }
      .stats { grid-template-columns: repeat(2, 1fr); }
      .hscroll { grid-auto-columns: minmax(340px, 1fr); }
    }
    @media (max-width: 768px) {
      .admin-header h1 { font-size: 28px; }
      .stats { grid-template-columns: 1fr; }
      .hscroll { display: block; overflow-x: visible; }
      .panel { margin-bottom: 16px; }
      .inline-controls { flex-wrap: wrap; }
      #users-list table { min-width: 720px; }
    }
    .hscroll { display: grid; grid-auto-flow: column; grid-auto-columns: minmax(360px, 1fr); gap: 16px; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 12px; align-items: stretch; }
    .panel { position: relative; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); min-height: 300px; scroll-snap-align: start; display: flex; flex-direction: column; z-index: 1; }
    .panel-header { display:flex; justify-content: space-between; align-items:center; padding: 12px 16px; border-bottom: 2px solid #e5e7eb; gap: 8px; }
    .panel-body { padding: 12px 16px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 12px; }
    .scroll-indicator { position: relative; }
    .scroll-indicator::before { content: ""; position: absolute; left: 0; top: 0; bottom: 0; width: 18px; pointer-events: none; background: linear-gradient(to right, rgba(255,255,255,1), rgba(255,255,255,0)); opacity: 0; transition: opacity .2s; z-index: 2; }
    .scroll-indicator::after { content: ""; position: absolute; right: 0; top: 0; bottom: 0; width: 18px; pointer-events: none; background: linear-gradient(to left, rgba(255,255,255,1), rgba(255,255,255,0)); opacity: 0; transition: opacity .2s; z-index: 2; }
    .scroll-indicator.scroll-left::before { opacity: 1; }
    .scroll-indicator.scroll-right::after { opacity: 1; }
    .action-btn { padding:8px 12px; border:1px solid #00693e; border-radius:8px; background:white; color:#00693e; font-weight:600; }
    .action-btn.primary { background:#00693e; color:white; }
    .inline-controls { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
    .inline-controls .input, .inline-controls select, .inline-controls button { flex: 1 1 180px; min-width: 160px; }
    .input { padding:8px; border:1px solid #ddd; border-radius:8px; }
    .modal { position: fixed; inset: 0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.6); z-index: 10000; }
    .modal-content { background:white; border-radius:12px; max-width:900px; width:90%; max-height:85vh; overflow:auto; }

    /* CSS change log (admin.html):
       - Increased container max-width for desktop clarity
       - Expanded stats grid min column width
       - Enabled word-break in table cells to avoid overflow
       - Added horizontal scroll to users table for narrow screens
       - Increased panel auto column width; ensured stretch alignment
       - Introduced z-index to scroll indicators; panel positioned relative
       - Made inline controls wrap by default with min widths
       - Tuned media queries for better small-screen table handling */
  </style>
</head>
<body>
  <div class="admin-container">
    <div class="admin-header">
      <h1>üîê Admin Panel</h1>
      <p style="opacity:.9; margin-top:6px;">Monitor users, activity, and content across schools.</p>
    </div>

    <!-- Login Form (shown initially) -->
    <div id="login-section" class="login-form">
      <h2>Admin Login</h2>
      <input type="password" id="admin-password" placeholder="Enter admin password" autocomplete="off">
      <button onclick="handleLogin()">Login</button>
      <div id="login-error" class="error-message"></div>
    </div>

    <!-- Admin Content (shown after login) -->
    <div id="admin-content" style="display: none;">
      <div class="stats">
        <div class="stat-card">
          <h3>Total Users</h3>
          <div class="value" id="total-users">0</div>
        </div>
        <div class="stat-card">
          <h3>Subjects</h3>
          <div class="value" id="total-subjects">0</div>
        </div>
        <div class="stat-card">
          <h3>Professors</h3>
          <div class="value" id="total-professors">0</div>
        </div>
        <div class="stat-card">
          <h3>Reviews</h3>
          <div class="value" id="total-reviews">0</div>
        </div>
        <div class="stat-card">
          <h3>Resources</h3>
          <div class="value" id="total-resources">0</div>
        </div>
        <div class="stat-card">
          <h3>Users with Emails</h3>
          <div class="value" id="users-with-emails">0</div>
        </div>
        <div class="stat-card">
          <h3>OAuth Users</h3>
          <div class="value" id="oauth-users">0</div>
        </div>
      </div>

  <div class="school-filter">
    <button onclick="loadAdmin('dlsu')" class="active" data-school="dlsu">DLSU</button>
        <button onclick="loadAdmin('ateneo')" data-school="ateneo">Ateneo</button>
        <button onclick="loadAdmin('up')" data-school="up">UP</button>
        <button onclick="loadAdmin('benilde')" data-school="benilde">Benilde</button>
        <button onclick="loadAdmin('all')" data-school="all">All Schools</button>
    <button class="export-btn" onclick="exportEmails()">üì• Export CSV</button>
    <button class="export-btn" onclick="exportJSON()">üßæ Export JSON</button>
    <button class="export-btn" onclick="exportPDF()">üñ®Ô∏è Export PDF</button>
  </div>

      <div class="scroll-indicator">
        <div id="panels" class="hscroll">
          <div class="panel" id="panel-reviews">
            <div class="panel-header">
              <h2>Reviews</h2>
              <div class="inline-controls">
                <input id="filter-reviews" class="input" placeholder="Search reviews">
                <button class="action-btn" onclick="exportReviewsJSON()">Export JSON</button>
                <button class="action-btn" onclick="bulkDeleteSelectedReviews()">Bulk Delete</button>
              </div>
            </div>
            <div class="panel-body">
              <div id="reviews-grid" class="grid"></div>
            </div>
          </div>

          <div class="panel" id="panel-notes">
            <div class="panel-header">
              <h2>Notes</h2>
              <div class="inline-controls">
                <input id="filter-notes" class="input" placeholder="Search notes">
                <button class="action-btn" onclick="exportNotesJSON()">Export JSON</button>
              </div>
            </div>
            <div class="panel-body">
              <div id="notes-grid" class="grid"></div>
            </div>
          </div>

          <div class="panel" id="panel-users">
            <div class="panel-header">
              <h2>Users</h2>
              <div class="inline-controls">
                <input id="filter-text" class="input" placeholder="Search name/email">
                <select id="filter-type" class="input"><option value="all">All Types</option><option value="oauth">OAuth Users</option><option value="email">Email Users</option></select>
                <button class="action-btn" onclick="applyFilters()">Apply</button>
                <button class="action-btn" onclick="exportJSON()">Export JSON</button>
                <button class="action-btn" onclick="exportEmails()">Export Emails</button>
              </div>
            </div>
            <div class="panel-body">
              <div id="loading" class="loading">Loading users...</div>
              <div id="users-list"></div>
              <div style="margin-top:16px; display:grid; grid-template-columns: 1fr; gap:12px;">
                <div class="card">
                  <div style="font-weight:600; margin-bottom:8px;">Change User Password</div>
                  <div style="display:grid; grid-template-columns: repeat(auto-fill,minmax(200px,1fr)); gap:8px; align-items:end;">
                    <select id="pw-user" class="input"></select>
                    <input id="pw-current" class="input" type="password" placeholder="Current password">
                    <input id="pw-next" class="input" type="password" placeholder="New password">
                    <input id="pw-confirm" class="input" type="password" placeholder="Confirm new password">
                    <button class="action-btn" onclick="togglePwVisibility()">Toggle Visibility</button>
                    <button class="action-btn primary" onclick="submitChangePassword()">Change</button>
                    <button class="action-btn" onclick="submitResetPassword()">Admin Reset</button>
                  </div>
                  <div id="pw-msg" style="margin-top:8px; font-size:13px;"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="panel" id="panel-tools">
            <div class="panel-header"><h2>Tools</h2></div>
            <div class="panel-body">
              <div id="recent-reviews" style="margin-bottom:12px;"></div>
              <div id="recent-resources" style="margin-bottom:12px;"></div>
              <div id="live-feed" style="font-size:13px; color:#374151;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentSchool = 'dlsu';
    let allUsersData = [];
    let reviewsData = [];
    let notesData = [];
    let selectedReviewIds = new Set();

    async function handleLogin() {
      const password = document.getElementById('admin-password').value;
      const errorDiv = document.getElementById('login-error');
      
      if (!password) {
        errorDiv.textContent = 'Please enter a password.';
        errorDiv.style.display = 'block';
        return;
      }

      try {
        const resp = await fetch('/api/admin/login', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ password }) });
        const j = await resp.json();
        if (!resp.ok) { throw new Error(j.error || 'Login failed'); }
        localStorage.setItem('admin_token', j.token);
        localStorage.setItem('admin_role', j.role);
        document.getElementById('login-section').style.display = 'none';
        document.getElementById('admin-content').style.display = 'block';
        loadAdmin('dlsu');
        initLiveFeed();
      } catch (error) {
        errorDiv.textContent = error.message || 'Error connecting to server. Please try again.';
        errorDiv.style.display = 'block';
      }
    }

    // Allow Enter key to submit
    document.getElementById('admin-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        handleLogin();
      }
    });

    async function loadAdmin(school) {
      currentSchool = school;
      
      // Update active button
      document.querySelectorAll('.school-filter button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.school === school) {
          btn.classList.add('active');
        }
      });

      document.getElementById('loading').style.display = 'block';
      document.getElementById('users-list').innerHTML = '';

      try {
        const token = localStorage.getItem('admin_token');
        if (!token) {
          alert('Session expired. Please refresh and login again.');
          location.reload();
          return;
        }
        
        const sumRes = await fetch(`/api/admin/summary?school=${school}`, { headers:{ 'Authorization':'Bearer ' + token } });
        const summary = await sumRes.json();
        updateSummary(summary);

        const response = await fetch(`/api/admin/users-extended?school=${school}`, { headers:{ 'Authorization':'Bearer ' + token } });
        const data = await response.json();

        if (!response.ok) {
          if (response.status === 401) {
            alert('Session expired. Please refresh and login again.');
            localStorage.removeItem('admin_token');
            location.reload();
            return;
          }
          throw new Error(data.error || 'Failed to load users');
        }

        allUsersData = data.users || [];
        displayUsers(allUsersData);
        updateStats(allUsersData);
        populatePwUsers();

        await loadReviews();
        await loadNotes();

        const actRes = await fetch(`/api/admin/activity?school=${school}&limit=10`, { headers:{ 'Authorization':'Bearer ' + token } });
        const act = await actRes.json();
        updateActivity(act);
      } catch (error) {
        const errorMsg = error.message || 'Unknown error occurred';
        document.getElementById('users-list').innerHTML = `
          <div class="no-data" style="padding: 40px; text-align: center;">
            <h3 style="color: #dc2626; margin-bottom: 10px;">Error Loading Users</h3>
            <p style="color: #666;">${errorMsg}</p>
            <p style="color: #999; font-size: 14px; margin-top: 20px;">Check the server console for more details.</p>
          </div>
        `;
        console.error('Error loading users:', error);
      } finally {
        document.getElementById('loading').style.display = 'none';
      }
    }

    function displayUsers(users) {
      const container = document.getElementById('users-list');

      if (users.length === 0) {
        container.innerHTML = '<div class="no-data">No users found</div>';
        return;
      }

      const showSchool = currentSchool === 'all';
      
      let html = `
        <table>
          <thead>
            <tr>
              ${showSchool ? '<th>School</th>' : ''}
              <th>ID</th>
              <th>Email</th>
              <th>Display Name</th>
              <th>School/Email ID</th>
              <th>OAuth Provider</th>
              <th>College</th>
              <th>Course</th>
              <th>Batch</th>
              <th>Username</th>
              <th>Reviews</th>
              <th>Resources</th>
            </tr>
          </thead>
          <tbody>
      `;

      users.forEach(user => {
        html += `
          <tr>
            ${showSchool ? `<td>${user.school || 'N/A'}</td>` : ''}
            <td>${user.id}</td>
            <td>${user.email || '<span style="color:#999;">N/A</span>'}</td>
            <td>${user.display_name || '<span style="color:#999;">N/A</span>'}</td>
            <td>${user.school_id_or_email || '<span style="color:#999;">N/A</span>'}</td>
            <td>${user.oauth_provider || '<span style="color:#999;">N/A</span>'}</td>
            <td>${user.college || '<span style="color:#999;">N/A</span>'}</td>
            <td>${user.course || '<span style="color:#999;">N/A</span>'}</td>
            <td>${user.batch || '<span style="color:#999;">N/A</span>'}</td>
            <td>${user.username || '<span style="color:#999;">N/A</span>'}</td>
            <td>${Number(user.reviews_count || 0)}</td>
            <td>${Number(user.notes_count || 0)}</td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    function updateSummary(summary) {
      const totals = summary.totals ? summary.totals : summary;
      document.getElementById('total-users').textContent = totals.users || 0;
      document.getElementById('total-subjects').textContent = totals.subjects || 0;
      document.getElementById('total-professors').textContent = totals.professors || 0;
      document.getElementById('total-reviews').textContent = totals.reviews || 0;
      document.getElementById('total-resources').textContent = totals.resources || 0;
    }

    function updateActivity(act) {
      const reviews = act.activity ? act.activity.flatMap(a => a.reviews.map(x => ({...x, school:a.school}))) : (act.reviews || []);
      const resources = act.activity ? act.activity.flatMap(a => a.resources.map(x => ({...x, school:a.school}))) : (act.resources || []);
      const rEl = document.getElementById('recent-reviews');
      const nEl = document.getElementById('recent-resources');
      rEl.innerHTML = `<h3 style="margin-bottom:8px;">Recent Reviews</h3>` + (reviews.slice(0,10).map(v => `<div style="font-size:13px; color:#374151; padding:6px 0; border-bottom:1px solid #eee;">${v.display_name || 'User'} reviewed prof ${v.prof_id} ‚Ä¢ ${v.school ? v.school.toUpperCase() : ''} <span style="color:#6b7280;">${v.created_at || ''}</span></div>`).join(''));
      nEl.innerHTML = `<h3 style="margin-bottom:8px;">Recent Resources</h3>` + (resources.slice(0,10).map(n => `<div style="font-size:13px; color:#374151; padding:6px 0; border-bottom:1px solid #eee;">${n.display_name || 'User'} uploaded ${n.file_name} to subject ${n.subject_id} ‚Ä¢ ${n.school ? n.school.toUpperCase() : ''} <span style="color:#6b7280;">${n.created_at || ''}</span></div>`).join(''));
    }

    function updateStats(users) {
      const withEmails = users.filter(u => u.email).length;
      const oauthUsers = users.filter(u => u.oauth_provider).length;
      document.getElementById('users-with-emails').textContent = withEmails;
      document.getElementById('oauth-users').textContent = oauthUsers;
    }

    function applyFilters() {
      const txt = (document.getElementById('filter-text').value || '').toLowerCase();
      const type = document.getElementById('filter-type').value;
      let filtered = allUsersData.slice();
      if (txt) filtered = filtered.filter(u => String(u.display_name||'').toLowerCase().includes(txt) || String(u.email||'').toLowerCase().includes(txt));
      if (type==='oauth') filtered = filtered.filter(u => !!u.oauth_provider);
      if (type==='email') filtered = filtered.filter(u => !!u.email);
      displayUsers(filtered);
    }

    function updateScrollIndicators() {
      const el = document.getElementById('panels');
      const wrap = el.parentElement;
      const left = el.scrollLeft > 0;
      const right = el.scrollLeft + el.clientWidth < el.scrollWidth;
      wrap.classList.toggle('scroll-left', left);
      wrap.classList.toggle('scroll-right', right);
    }

    function initLiveFeed() {
      const token = localStorage.getItem('admin_token');
      const ev = new EventSource(`/api/admin/activity/stream?school=${currentSchool}&token=${encodeURIComponent(token)}`);
      const feed = document.getElementById('live-feed');
      ev.onmessage = (e) => {
        try {
          const j = JSON.parse(e.data);
          const items = [];
          j.reviews.forEach(r => items.push(`Review by ${r.display_name||'User'} on prof ${r.prof_id}`));
          j.resources.forEach(n => items.push(`Resource by ${n.display_name||'User'}: ${n.file_name||''}`));
          feed.innerHTML = items.slice(0,10).map(s => `<div style="padding:4px 0; border-bottom:1px solid #eee;">${s}</div>`).join('');
        } catch(_) {}
      };
      const el = document.getElementById('panels');
      el.addEventListener('scroll', updateScrollIndicators);
      updateScrollIndicators();
    }

    async function loadReviews() {
      const token = localStorage.getItem('admin_token');
      const res = await fetch(`/api/admin/reviews?school=${currentSchool}&limit=200`, { headers:{ 'Authorization':'Bearer ' + token } });
      const j = await res.json();
      reviewsData = j.reviews || [];
      renderReviews(reviewsData);
    }

    function renderReviews(list) {
      const map = new Map((allUsersData||[]).map(u => [u.id, u]));
      const q = (document.getElementById('filter-reviews').value||'').toLowerCase();
      const filtered = q ? list.filter(r => String(r.review_text||'').toLowerCase().includes(q) || String(r.course_code||'').toLowerCase().includes(q)) : list;
      const grid = document.getElementById('reviews-grid');
      grid.innerHTML = filtered.map(r => {
        const u = map.get(r.user_id);
        const dn = u?.display_name || r.display_name || 'User';
        const meta = `${dn} ‚Ä¢ User#${r.user_id} ‚Ä¢ ${r.college||u?.college||''} ${r.batch_id||u?.batch||''}`;
        const stars = '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'.slice(0, Math.max(0, Math.min(5, Number(r.rating||0))))
        return `<div class="card"><div style="display:flex; justify-content:space-between; align-items:center;">
          <div style="font-weight:600;">${stars} <span style="color:#6b7280; font-weight:400;">${r.rating||0}/5</span></div>
          <div><input type="checkbox" data-id="${r.id}" onchange="toggleSelectReview(${r.id}, this.checked)"></div></div>
          <div style="color:#374151; margin:8px 0;">${(r.review_text||'').replace(/</g,'&lt;')}</div>
          <div style="font-size:12px; color:#6b7280;">${meta}</div>
          <div style="font-size:12px; color:#6b7280;">Course ${r.course_code||''} ‚Ä¢ Prof ${r.prof_id} ‚Ä¢ ${r.created_at||''}</div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <button class="action-btn" onclick="editReview(${r.id})">Edit</button>
            <button class="action-btn" onclick="deleteReview(${r.id})">Delete</button>
          </div>
        </div>`;
      }).join('');
      document.getElementById('filter-reviews').oninput = () => renderReviews(reviewsData);
    }

    function toggleSelectReview(id, on) { if (on) selectedReviewIds.add(id); else selectedReviewIds.delete(id); }
    async function bulkDeleteSelectedReviews() {
      if (!selectedReviewIds.size) return;
      if (!confirm('Delete selected reviews?')) return;
      const token = localStorage.getItem('admin_token');
      const ids = Array.from(selectedReviewIds);
      for (const id of ids) {
        await fetch(`/api/admin/reviews/${id}?school=${currentSchool}`, { method:'DELETE', headers:{ 'Authorization':'Bearer ' + token } });
      }
      selectedReviewIds.clear();
      await loadReviews();
    }
    async function editReview(id) {
      const r = reviewsData.find(x => x.id===id);
      if (!r) return;
      const text = prompt('Edit review text', r.review_text||'');
      if (text==null) return;
      const token = localStorage.getItem('admin_token');
      const res = await fetch(`/api/admin/reviews/${id}/edit?school=${currentSchool}`, { method:'POST', headers:{ 'Authorization':'Bearer ' + token, 'Content-Type':'application/json' }, body: JSON.stringify({ review_text: text }) });
      if (res.ok) loadReviews();
    }
    async function deleteReview(id) {
      if (!confirm('Delete this review?')) return;
      const token = localStorage.getItem('admin_token');
      const res = await fetch(`/api/admin/reviews/${id}?school=${currentSchool}`, { method:'DELETE', headers:{ 'Authorization':'Bearer ' + token } });
      if (res.ok) loadReviews();
    }

    async function loadNotes() {
      const token = localStorage.getItem('admin_token');
      const res = await fetch(`/api/resources?school=${currentSchool}&limit=200`, { headers:{ 'Authorization':'Bearer ' + token } });
      const j = await res.json();
      notesData = j.resources || [];
      renderNotes(notesData);
    }
    function renderNotes(list) {
      const map = new Map((allUsersData||[]).map(u => [u.id, u]));
      const q = (document.getElementById('filter-notes').value||'').toLowerCase();
      const filtered = q ? list.filter(n => String(n.title||'').toLowerCase().includes(q) || String(n.description||'').toLowerCase().includes(q) || String(n.file_name||'').toLowerCase().includes(q)) : list;
      const grid = document.getElementById('notes-grid');
      grid.innerHTML = filtered.map(n => {
        const u = map.get(n.user_id);
        const dn = u?.display_name || n.display_name || 'User';
        const meta = `${dn} ‚Ä¢ User#${n.user_id} ‚Ä¢ ${n.college||u?.college||''} ${n.batch||u?.batch||''}`;
        const kb = n.file_size ? (Math.round(Number(n.file_size)/1024*10)/10)+' KB' : '';
        return `<div class="card">
          <div style="font-weight:600;">${n.title||n.file_name||''}</div>
          <div style="color:#374151; margin:8px 0;">${(n.description||'').replace(/</g,'&lt;')}</div>
          <div style="font-size:12px; color:#6b7280;">${meta}</div>
          <div style="font-size:12px; color:#6b7280;">${n.created_at||''} ‚Ä¢ ${kb}</div>
          <div style="margin-top:8px; display:flex; gap:8px;">
            <a class="action-btn" href="${n.file_path}" target="_blank">Download</a>
            <button class="action-btn" onclick="previewFile('${n.file_path}')">Preview</button>
          </div>
        </div>`;
      }).join('');
      document.getElementById('filter-notes').oninput = () => renderNotes(notesData);
    }

    function exportReviewsJSON() { const blob = new Blob([JSON.stringify(reviewsData)], { type:'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `reviews_${currentSchool}.json`; a.click(); }
    function exportNotesJSON() { const blob = new Blob([JSON.stringify(notesData)], { type:'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `notes_${currentSchool}.json`; a.click(); }

    function previewFile(url) {
      const m = document.getElementById('modal');
      const c = document.getElementById('modal-content');
      const ext = (url.split('.').pop()||'').toLowerCase();
      let inner = '';
      if (['png','jpg','jpeg','gif','webp'].includes(ext)) inner = `<img src="${url}" style="max-width:100%; height:auto; display:block;">`;
      else if (['pdf'].includes(ext)) inner = `<embed src="${url}" type="application/pdf" style="width:100%; height:80vh;">`;
      else inner = `<iframe src="${url}" style="width:100%; height:80vh;"></iframe>`;
      c.innerHTML = inner;
      m.style.display = 'flex';
    }
    function closeModal() { const m = document.getElementById('modal'); m.style.display = 'none'; }

    function populatePwUsers() {
      const sel = document.getElementById('pw-user');
      sel.innerHTML = (allUsersData||[]).map(u => `<option value="${u.id}">${u.id} ‚Ä¢ ${u.display_name||u.email||''}</option>`).join('');
    }
    function togglePwVisibility() {
      ['pw-current','pw-next','pw-confirm'].forEach(id => { const el = document.getElementById(id); el.type = el.type==='password' ? 'text' : 'password'; });
      setTimeout(() => { ['pw-current','pw-next','pw-confirm'].forEach(id => { const el = document.getElementById(id); el.type = 'password'; }); }, 3000);
    }
    function validateStrength(v) { return /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^\w\s]).{8,}$/.test(v); }
    async function submitChangePassword() {
      const uid = document.getElementById('pw-user').value;
      const current = document.getElementById('pw-current').value;
      const next = document.getElementById('pw-next').value;
      const confirm = document.getElementById('pw-confirm').value;
      const msg = document.getElementById('pw-msg');
      msg.textContent = '';
      if (!validateStrength(next)) { msg.textContent = 'Weak password'; return; }
      if (next !== confirm) { msg.textContent = 'Password confirmation mismatch'; return; }
      const token = localStorage.getItem('admin_token');
      const res = await fetch(`/api/admin/users/${uid}/change-password?school=${currentSchool}`, { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ current, next, confirm }) });
      const j = await res.json().catch(()=>({}));
      msg.textContent = res.ok ? 'Password changed' : (j.error||'Error');
    }
    async function submitResetPassword() {
      const uid = document.getElementById('pw-user').value;
      const next = document.getElementById('pw-next').value;
      const confirm = document.getElementById('pw-confirm').value;
      const msg = document.getElementById('pw-msg');
      msg.textContent = '';
      if (!validateStrength(next)) { msg.textContent = 'Weak password'; return; }
      if (next !== confirm) { msg.textContent = 'Password confirmation mismatch'; return; }
      const token = localStorage.getItem('admin_token');
      const res = await fetch(`/api/admin/users/${uid}/change-password?school=${currentSchool}`, { method:'POST', headers:{ 'Authorization':'Bearer '+token, 'Content-Type':'application/json' }, body: JSON.stringify({ next, confirm }) });
      const j = await res.json().catch(()=>({}));
      msg.textContent = res.ok ? 'Password reset' : (j.error||'Error');
    }

    function exportJSON() {
      const blob = new Blob([JSON.stringify(allUsersData)], { type:'application/json' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `users_${currentSchool}.json`;
      link.click();
    }
    function exportPDF() {
      const w = window.open('', '_blank');
      const showSchool = currentSchool === 'all';
      const rows = allUsersData.map(u => `<tr>${showSchool?`<td>${u.school||''}</td>`:''}<td>${u.id}</td><td>${u.email||''}</td><td>${u.display_name||''}</td><td>${u.school_id_or_email||''}</td><td>${u.oauth_provider||''}</td><td>${u.college||''}</td><td>${u.course||''}</td><td>${u.batch||''}</td><td>${u.username||''}</td></tr>`).join('');
      w.document.write(`<html><head><title>Users PDF</title></head><body><h2>Users - ${currentSchool.toUpperCase()}</h2><table border="1" cellspacing="0" cellpadding="6"><thead><tr>${showSchool?'<th>School</th>':''}<th>ID</th><th>Email</th><th>Display Name</th><th>School/Email ID</th><th>OAuth</th><th>College</th><th>Course</th><th>Batch</th><th>Username</th></tr></thead><tbody>${rows}</tbody></table></body></html>`);
      w.document.close();
      w.focus();
      w.print();
    }

    function exportEmails() {
      if (allUsersData.length === 0) {
        alert('No data to export');
        return;
      }

      // Filter users with emails
      const usersWithEmails = allUsersData.filter(u => u.email);
      
      if (usersWithEmails.length === 0) {
        alert('No users with email addresses to export');
        return;
      }

      // Create CSV content
      const showSchool = currentSchool === 'all';
      let csv = showSchool ? 'School,' : '';
      csv += 'ID,Email,Display Name,School/Email ID,OAuth Provider,College,Course,Batch,Username\n';
      usersWithEmails.forEach(user => {
        const row = [
          ...(showSchool ? [user.school || ''] : []),
          user.id,
          user.email || '',
          user.display_name || '',
          user.school_id_or_email || '',
          user.oauth_provider || '',
          user.college || '',
          user.course || '',
          user.batch || '',
          user.username || ''
        ].map(field => `"${String(field).replace(/"/g, '""')}"`).join(',');
        csv += row + '\n';
      });

      // Download CSV
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `registered_emails_${currentSchool}_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
  </script>
  <div id="modal" class="modal" onclick="closeModal()"><div id="modal-content" class="modal-content"></div></div>
</body>
</html>
