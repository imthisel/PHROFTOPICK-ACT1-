<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes" />
  <title>Add Professor</title>
  <meta name="description" content="Submit a new professor and assign the courses they teach.">
  <meta name="robots" content="index, follow">
  <link rel="canonical" href="/add-professor">
  <meta property="og:title" content="Add Professor — Phroftopick">
  <meta property="og:description" content="Contribute professor information to help students choose wisely.">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://phroftopick.com/add-professor">
  <meta property="og:image" content="/images/default-logo.png">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="Add Professor — Phroftopick">
  <meta name="twitter:description" content="Contribute professor information to help students choose wisely.">
  <meta name="twitter:image" content="/images/default-logo.png">
  <link rel="icon" type="image/png" href="images/favicon.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=Inter:wght@600;700;800&display=swap" rel="stylesheet">
  <script>
    (function preloadLogo() {
      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      const logoMap = {
        dlsu: 'images/dlsu-logo.png',
        ateneo: 'images/ateneo-logo.png',
        benilde: 'images/benilde-logo.png',
        up: 'images/up-logo.png',
      };
      const selectedLogo = logoMap[school] || 'images/default-logo.png';
      const img = new Image();
      img.src = selectedLogo;
      window.__PRELOADED_LOGO = selectedLogo;
    })();
  </script>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/theme-loader.js" defer></script>
  <link rel="stylesheet" href="css/mobile-override.css">
</head>
<body>
  <div id="header-placeholder"></div>

  <style>
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:800px){ .grid-2{ grid-template-columns:1fr; } }
    .field-row { display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .dropdown { position:relative; }
    .dropdown-list { position:absolute; z-index:1000; top:100%; left:0; right:0; max-height:220px; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 24px rgba(0,0,0,0.08); padding:6px; display:none; }
    .dropdown-item { padding:8px 10px; border-radius:8px; cursor:pointer; }
    .dropdown-item:hover, .dropdown-item:focus { background:#f3f4f6; outline:none; }
    .chip-list { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip { background:#f3f4f6; color:#111827; padding:6px 10px; border-radius:9999px; font-size:12px; font-weight:600; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; }
    .modal-card { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; width:min(560px,90vw); border-radius:16px; box-shadow:0 16px 48px rgba(0,0,0,0.15); padding:20px; display:none; }
    .modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
    .auth-btn.secondary { background:#f3f4f6; color:#111827; }
    .auth-btn.secondary:hover { color:#fff; }
    .auth-btn:focus { outline:2px solid var(--primary); outline-offset:2px; }
    /* Local override: float labels only when label follows the input */
    .review-field input { padding: 16px 12px; }
    .review-field input + label { top: -10px; transform: none; font-size: 12px; background: #fff; }
    /* Static field label variant (does not overlap inputs) */
    .review-field .field-label { position: static; display:block; margin-bottom:6px; font-size:14px; font-weight:600; color:#374151; }
    /* Ensure button doesn't get visually overlapped by dropdown container */
    .field-row > .auth-btn { flex: 0 0 auto; align-self: center; }
  </style>

  <main class="container" style="max-width:1200px; margin-top:24px; min-height:calc(100vh - 160px); display:flex; justify-content:center; align-items:flex-start;">
    <h1 style="margin-bottom:10px;">Add Professor</h1>
    <p style="color:#6b7280;">Provide the professor’s name and the course codes they teach.</p>

    <section class="card" style="padding:28px; width:100%; max-width:900px; margin:0 auto;">
      <form id="prof-form" aria-label="Add Professor Form">
        <div class="review-field">
          <input id="prof-name" placeholder="e.g., Dela Cruz, Juan" required aria-describedby="name-error" style="width:100%;" />
          <label>Professor Name</label>
        </div>
        <div id="name-error" style="color:#dc2626; font-weight:600; display:none;">Use: Last name, First name (e.g., Dela Cruz, Juan)</div>

        <div class="review-field" style="margin-top:14px;">
          <div class="field-row">
            <div class="dropdown" style="flex:1; min-width:240px; width:100%;">
              <input id="course-code-input" placeholder="Type to search course code" aria-autocomplete="list" aria-controls="course-suggestions" autocomplete="off" aria-describedby="course-error" style="width:100%;" />
              <label for="course-code-input">Course Codes</label>
              <div id="course-suggestions" class="dropdown-list" role="listbox"></div>
            </div>
            <button id="course-not-found" type="button" class="auth-btn secondary" aria-haspopup="dialog">Course Not Found</button>
          </div>
          <div class="chip-list" id="selected-courses"></div>
          <input id="prof-courses" type="hidden" required aria-label="Selected course codes (comma-separated)" />
        </div>
        <div id="course-error" style="color:#dc2626; font-weight:600; display:none;">Each code must be exactly 7 uppercase characters.</div>

        <button class="auth-btn" type="submit" style="margin-top:12px;">Submit</button>
        <p id="prof-result" style="margin-top:10px; font-weight:600;" aria-live="polite"></p>
      </form>
    </section>
  </main>

  <div id="modal-overlay" class="modal-overlay" aria-hidden="true"></div>
  <div id="course-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="course-modal-title">
    <h2 id="course-modal-title" style="margin:0 0 8px;">Course Not Found</h2>
    <p style="color:#374151;">Please add the missing course first before assigning it to a professor.</p>
    <div class="modal-actions">
      <a href="/add-course" class="auth-btn">Go to Add Course</a>
      <button id="modal-close" class="auth-btn secondary" type="button">Close</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const headerContainer = document.getElementById('header-placeholder');
        const res = await fetch('/components/header.html');
        headerContainer.innerHTML = await res.text();
        await new Promise(requestAnimationFrame);
        if (!document.querySelector('script[src="/js/app.js"]')) {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = '/js/app.js';
            s.onload = resolve;
            s.onerror = () => reject(new Error('app.js load failed'));
            document.head.appendChild(s);
          });
        }
        if (window.updateSchoolLogo) window.updateSchoolLogo();
        if (window.initializeHeader) await window.initializeHeader();
        if (window.updateAuthUI) window.updateAuthUI();
      } catch (e) { console.warn('Header init failed', e); }
      try {
        const school = localStorage.getItem('selectedSchool') || 'dlsu';
        const titleEl = document.getElementById('site-title');
        const logoEl = document.querySelector('.school-logo');
        if (titleEl) titleEl.textContent = `${String(school||'').toUpperCase()} — PHROFS TO PICK`;
        if (logoEl) {
          const map = { dlsu:'images/dlsu-logo.png', ateneo:'images/ateneo-logo.png', benilde:'images/benilde-logo.png', up:'images/up-logo.png' };
          const src = map[String(school).toLowerCase()] || 'images/default-logo.png';
          logoEl.src = window.__PRELOADED_LOGO || src;
        }
      } catch (_) {}

      const form = document.getElementById('prof-form');
      const nameInput = document.getElementById('prof-name');
      const coursesInput = document.getElementById('prof-courses');
      const codeInput = document.getElementById('course-code-input');
      const suggBox = document.getElementById('course-suggestions');
      const chips = document.getElementById('selected-courses');
      const notFoundBtn = document.getElementById('course-not-found');
      const modal = document.getElementById('course-modal');
      const overlay = document.getElementById('modal-overlay');
      const modalClose = document.getElementById('modal-close');
      const nameErr = document.getElementById('name-error');
      const courseErr = document.getElementById('course-error');
      const resultEl = document.getElementById('prof-result');

      const nameRe = /^[A-Za-z'\-\s]+,\s[A-Za-z'\-\s]+$/;
      const codeRe = /^[A-Z]{7}$/;
      // Validation: exactly 7 uppercase letters, no digits/specials
      function validateCode(raw){
        const code = String(raw||'').trim();
        if (!code) return { ok:false, reason:'empty' };
        if (code.length !== 7) return { ok:false, reason:'length' };
        if (/[^A-Za-z]/.test(code)) return { ok:false, reason:'lettersOnly' };
        if (code !== code.toUpperCase()) return { ok:false, reason:'uppercase' };
        return { ok:true, reason:null };
      }

      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      let allCourses = [];
      function renderSuggestions(list){
        if (!list.length) { suggBox.style.display='none'; suggBox.innerHTML=''; return; }
        suggBox.innerHTML = list.map(s => `<div class="dropdown-item" role="option" data-code="${s.code}">${s.code} — ${s.name||''}</div>`).join('');
        suggBox.style.display='block';
        suggBox.querySelectorAll('.dropdown-item').forEach(item=>{
          item.addEventListener('click', ()=>{
            const code = item.getAttribute('data-code');
            const ok = addCode(code);
            codeInput.value = code || '';
            suggBox.style.display='none';
            if (!ok) { courseErr.style.display='block'; codeInput.setAttribute('aria-invalid','true'); }
            else { codeInput.removeAttribute('aria-invalid'); courseErr.style.display='none'; }
            codeInput.focus();
          });
        });
      }
      function addCode(code){
        const v = validateCode(code);
        if (!v.ok) return false;
        const parts = (coursesInput.value||'').split(',').map(c=>c.trim()).filter(Boolean);
        const up = String(code).toUpperCase();
        if (!parts.includes(up)) {
          parts.push(up);
          coursesInput.value = parts.join(',');
          const chip = document.createElement('span');
          chip.className='chip'; chip.textContent=up;
          chips.appendChild(chip);
        }
        return true;
      }
      async function loadCourses(){
        try{
          const r = await fetch(`/api/subjects?school=${school}`);
          const j = await r.json();
          allCourses = (Array.isArray(j)? j : (j.subjects||[])).slice().sort((a,b)=>String(a.code).localeCompare(String(b.code)));
        }catch(_){ allCourses=[]; }
      }
      async function filterCourses(q){
        const term = String(q||'').trim().toUpperCase();
        let remote = [];
        try{
          const r = await fetch(`/api/subjects?school=${school}` + (term ? `&q=${encodeURIComponent(term)}` : ''));
          const j = await r.json();
          remote = (Array.isArray(j)? j : (j.subjects||[]));
        }catch(_){ remote = []; }
        const map = new Map();
        [...allCourses, ...remote].forEach(s => {
          const code = String(s.code||'').toUpperCase();
          if (!code) return;
          if (!map.has(code)) map.set(code, s);
        });
        const merged = Array.from(map.values()).filter(s => String(s.code||'').toUpperCase().includes(term));
        renderSuggestions(merged.slice(0,50));
      }
      await loadCourses();
      codeInput.addEventListener('focus', ()=>{ filterCourses(codeInput.value); });
      codeInput.addEventListener('input', ()=>{ filterCourses(codeInput.value); });
      document.addEventListener('click', (e)=>{ if (!suggBox.contains(e.target) && e.target!==codeInput) suggBox.style.display='none'; });
      notFoundBtn.addEventListener('click', ()=>{ overlay.style.display='block'; modal.style.display='block'; modal.setAttribute('aria-hidden','false'); const f = modal.querySelector('a,button,input,select,textarea'); if (f) f.focus(); });
      modalClose.addEventListener('click', ()=>{ overlay.style.display='none'; modal.style.display='none'; modal.setAttribute('aria-hidden','true'); notFoundBtn.focus(); });

      function clearValidation(){
        nameInput.removeAttribute('aria-invalid');
        codeInput.removeAttribute('aria-invalid');
        nameErr.style.display = 'none';
        courseErr.style.display = 'none';
      }

      nameInput.addEventListener('input', clearValidation);
      codeInput.addEventListener('input', clearValidation);

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearValidation();
        resultEl.textContent = '';

        const name = (nameInput.value || '').trim();
        if (!nameRe.test(name)) {
          nameErr.style.display = 'block';
          nameInput.setAttribute('aria-invalid','true');
          return;
        }

        const codes = (coursesInput.value || '').split(',').map(c => String(c||'').trim()).filter(Boolean);
        if (!codes.length || !codes.every(c => codeRe.test(String(c).toUpperCase()))) {
          courseErr.style.display = 'block';
          codeInput.setAttribute('aria-invalid','true');
          return;
        }

        try {
          const r = await fetch(`/api/professors?school=${school}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, courses: codes })
          });
          const j = await r.json().catch(() => ({}));
          if (!r.ok) {
            resultEl.style.color = '#dc2626';
            resultEl.textContent = j.error || 'Submission failed';
            return;
          }
          resultEl.style.color = '#065f46';
          resultEl.textContent = 'Professor created successfully';
        } catch (err) {
          resultEl.style.color = '#dc2626';
          resultEl.textContent = 'Network error. Please try again.';
        }
      });
      try {
        const addCourseLink = document.getElementById('link-add-course') || document.querySelector('a[href="/add-course"]');
        if (addCourseLink) {
          addCourseLink.addEventListener('click', (e) => {
            e.preventDefault();
            try {
              const name = nameInput?.value || '';
              const selected = Array.from(document.querySelectorAll('#selected-courses .chip')).map(el => String(el.textContent||'').trim().toUpperCase());
              const prev = JSON.parse(sessionStorage.getItem('refData') || '{}');
              prev.addProfessor = { name, courses: selected };
              sessionStorage.setItem('refData', JSON.stringify(prev));
              sessionStorage.setItem('referrer', 'add-professor');
            } catch (_) {}
            window.location.href = '/add-course';
          });
        }
        const ref = sessionStorage.getItem('referrer');
        const raw = sessionStorage.getItem('refData');
        const rr = sessionStorage.getItem('refReturn');
        const data = raw ? JSON.parse(raw).addProfessor || {} : {};
        if (ref === 'add-professor' && data) {
          if (nameInput && data.name) nameInput.value = data.name;
          if (Array.isArray(data.courses)) {
            data.courses.forEach(c => {
              const chip = document.createElement('span');
              chip.className='chip'; chip.textContent=String(c||'').toUpperCase();
              chips.appendChild(chip);
            });
          }
        }
        if (rr) {
          const back = JSON.parse(rr);
          if (back && back.from === 'add-course' && back.createdCode) {
            const chip = document.createElement('span');
            chip.className='chip'; chip.textContent=String(back.createdCode).toUpperCase();
            chips.appendChild(chip);
            sessionStorage.removeItem('refReturn');
          }
        }
      } catch (_) {}
    });
  </script>
  <!-- Ensure app.js is available globally across pages -->
  <script src="/js/app.js"></script>
</body>
</html>
