<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=1100, initial-scale=0.3, user-scalable=yes" />
  <title>Add Professor</title>
  <link rel="stylesheet" href="css/base.css">
  <script src="js/theme-loader.js" defer></script>
  <link rel="stylesheet" href="css/mobile-override.css">
</head>
<body>
  <div id="header-placeholder"></div>

  <style>
    .grid-2 { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    @media (max-width:800px){ .grid-2{ grid-template-columns:1fr; } }
    .field-row { display:flex; gap:10px; align-items:flex-start; flex-wrap:wrap; }
    .dropdown { position:relative; }
    .dropdown-list { position:absolute; z-index:1000; top:100%; left:0; right:0; max-height:220px; overflow:auto; background:#fff; border:1px solid #e5e7eb; border-radius:10px; box-shadow:0 12px 24px rgba(0,0,0,0.08); padding:6px; display:none; }
    .dropdown-item { padding:8px 10px; border-radius:8px; cursor:pointer; }
    .dropdown-item:hover, .dropdown-item:focus { background:#f3f4f6; outline:none; }
    .chip-list { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .chip { background:#f3f4f6; color:#111827; padding:6px 10px; border-radius:9999px; font-size:12px; font-weight:600; }
    .modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; }
    .modal-card { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:#fff; width:min(560px,90vw); border-radius:16px; box-shadow:0 16px 48px rgba(0,0,0,0.15); padding:20px; display:none; }
    .modal-actions { display:flex; justify-content:flex-end; gap:10px; margin-top:12px; }
    .auth-btn.secondary { background:#f3f4f6; color:#111827; }
    .auth-btn:focus { outline:2px solid var(--primary); outline-offset:2px; }
  </style>

  <main class="container" style="max-width:1000px; margin-top:24px;">
    <h1 style="margin-bottom:10px;">Add Professor</h1>
    <p style="color:#6b7280;">Provide the professor’s name and the course codes they teach.</p>

    <section class="card" style="padding:24px;">
      <form id="prof-form" aria-label="Add Professor Form">
        <div class="review-field">
          <input id="prof-name" placeholder="e.g., Dela Cruz, Juan" required />
          <label>Professor Name</label>
        </div>
        <div id="name-error" style="color:#dc2626; font-weight:600; display:none;">Use: Last name, First name (e.g., Dela Cruz, Juan)</div>

        <div class="review-field" style="margin-top:14px;">
          <label>Course Codes</label>
          <div class="field-row">
            <div class="dropdown" style="flex:1; min-width:240px;">
              <input id="course-code-input" placeholder="Type to search course code" aria-autocomplete="list" aria-controls="course-suggestions" autocomplete="off" />
              <div id="course-suggestions" class="dropdown-list" role="listbox"></div>
            </div>
            <button id="course-not-found" type="button" class="auth-btn secondary" aria-haspopup="dialog">Course Not Found</button>
          </div>
          <div class="chip-list" id="selected-courses"></div>
          <input id="prof-courses" placeholder="e.g., GEMATMW,GESOCSC" required style="margin-top:10px;" aria-label="Selected course codes (comma-separated)" />
        </div>
        <div id="course-error" style="color:#dc2626; font-weight:600; display:none;">Each code must be exactly 7 uppercase characters.</div>

        <button class="auth-btn" type="submit" style="margin-top:12px;">Submit</button>
        <p id="prof-result" style="margin-top:10px; font-weight:600;"></p>
      </form>
    </section>
  </main>

  <div id="modal-overlay" class="modal-overlay" aria-hidden="true"></div>
  <div id="course-modal" class="modal-card" role="dialog" aria-modal="true" aria-labelledby="course-modal-title">
    <h2 id="course-modal-title" style="margin:0 0 8px;">Course Not Found</h2>
    <p style="color:#374151;">Please add the missing course first before assigning it to a professor.</p>
    <div class="modal-actions">
      <a href="/add-course.html" class="auth-btn">Go to Add Course</a>
      <button id="modal-close" class="auth-btn secondary" type="button">Close</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const headerContainer = document.getElementById('header-placeholder');
        const res = await fetch('/components/header.html');
        headerContainer.innerHTML = await res.text();
        await new Promise(requestAnimationFrame);
        if (!document.querySelector('script[src="/js/app.js"]')) {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = '/js/app.js';
            s.onload = resolve;
            s.onerror = () => reject(new Error('app.js load failed'));
            document.head.appendChild(s);
          });
        }
        if (window.updateSchoolLogo) window.updateSchoolLogo();
        if (window.initializeHeader) await window.initializeHeader();
        if (window.updateAuthUI) window.updateAuthUI();
      } catch (e) { console.warn('Header init failed', e); }

      const form = document.getElementById('prof-form');
      const nameInput = document.getElementById('prof-name');
      const coursesInput = document.getElementById('prof-courses');
      const codeInput = document.getElementById('course-code-input');
      const suggBox = document.getElementById('course-suggestions');
      const chips = document.getElementById('selected-courses');
      const notFoundBtn = document.getElementById('course-not-found');
      const modal = document.getElementById('course-modal');
      const overlay = document.getElementById('modal-overlay');
      const modalClose = document.getElementById('modal-close');
      const nameErr = document.getElementById('name-error');
      const courseErr = document.getElementById('course-error');
      const resultEl = document.getElementById('prof-result');

      const nameRe = /^[A-Za-z'\-\s]+,\s[A-Za-z'\-\s]+$/;
      const codeRe = /^[A-Z]{7}$/;

      const school = localStorage.getItem('selectedSchool') || 'dlsu';
      let allCourses = [];
      function renderSuggestions(list){
        if (!list.length) { suggBox.style.display='none'; suggBox.innerHTML=''; return; }
        suggBox.innerHTML = list.map(s => `<div class="dropdown-item" role="option" data-code="${s.code}">${s.code} — ${s.name||''}</div>`).join('');
        suggBox.style.display='block';
        suggBox.querySelectorAll('.dropdown-item').forEach(item=>{
          item.addEventListener('click', ()=>{
            const code = item.getAttribute('data-code');
            addCode(code);
            suggBox.style.display='none';
            codeInput.value='';
            codeInput.focus();
          });
        });
      }
      function addCode(code){
        if (!codeRe.test(code)) return;
        const parts = (coursesInput.value||'').split(',').map(c=>c.trim()).filter(Boolean);
        if (!parts.includes(code)) {
          parts.push(code);
          coursesInput.value = parts.join(',');
          const chip = document.createElement('span');
          chip.className='chip'; chip.textContent=code;
          chips.appendChild(chip);
        }
      }
      async function loadCourses(){
        try{
          const r = await fetch(`/api/subjects?school=${school}`);
          const j = await r.json();
          allCourses = (Array.isArray(j)? j : (j.subjects||[])).slice().sort((a,b)=>String(a.code).localeCompare(String(b.code)));
        }catch(_){ allCourses=[]; }
      }
      function filterCourses(q){
        q = (q||'').toUpperCase();
        const list = allCourses.filter(s => String(s.code||'').toUpperCase().includes(q));
        renderSuggestions(list.slice(0,50));
      }
      await loadCourses();
      codeInput.addEventListener('focus', ()=>{ filterCourses(codeInput.value); });
      codeInput.addEventListener('input', ()=>{ filterCourses(codeInput.value); });
      document.addEventListener('click', (e)=>{ if (!suggBox.contains(e.target) && e.target!==codeInput) suggBox.style.display='none'; });
      notFoundBtn.addEventListener('click', ()=>{ overlay.style.display='block'; modal.style.display='block'; modal.setAttribute('aria-hidden','false'); });
      modalClose.addEventListener('click', ()=>{ overlay.style.display='none'; modal.style.display='none'; modal.setAttribute('aria-hidden','true'); });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        nameErr.style.display = 'none';
        courseErr.style.display = 'none';
        resultEl.textContent = '';

        const name = (nameInput.value || '').trim();
        if (!nameRe.test(name)) {
          nameErr.style.display = 'block';
          return;
        }

        const codes = (coursesInput.value || '').split(',').map(c => c.trim()).filter(Boolean);
        if (!codes.length || !codes.every(c => codeRe.test(c))) {
          courseErr.style.display = 'block';
          return;
        }

        try {
          const r = await fetch(`/api/professors?school=${school}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name, courses: codes })
          });
          const j = await r.json().catch(() => ({}));
          if (!r.ok) {
            resultEl.style.color = '#dc2626';
            resultEl.textContent = j.error || 'Submission failed';
            return;
          }
          resultEl.style.color = '#065f46';
          resultEl.textContent = 'Professor created successfully';
        } catch (err) {
          resultEl.style.color = '#dc2626';
          resultEl.textContent = 'Network error. Please try again.';
        }
      });
    });
  </script>
</body>
</html>
