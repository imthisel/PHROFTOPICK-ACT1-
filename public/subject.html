<!DOCTYPE html>
<html lang="en">
<head>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Details</title>

  <!-- âœ… Load base styles first -->
  <link rel="stylesheet" href="css/base.css">

  <!-- âœ… Load school theme dynamically AFTER base -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let school = localStorage.getItem("selectedSchool") || "dlsu";
      const themeLink = document.createElement("link");
      themeLink.rel = "stylesheet";
      themeLink.href = `css/style-${school}.css`;
      document.head.appendChild(themeLink);
      console.log("ðŸŽ¨ Loaded theme:", themeLink.href);
    });
  </script>
</head>

</head>
<body>
  <div id="header-placeholder"></div>




  <main class="subject-page container fade-in">
    <!-- ðŸ“˜ Subject info -->
    <section id="subject-details" class="subject-card card">
      <!-- Content filled dynamically -->
    </section>

    <div class="subject-content">
      <!-- âœï¸ Upload Section -->
      <section class="panel upload-panel">
        <h2>Upload Notes</h2>
        <form id="upload-subject-form" class="upload-form">
          <input type="file" id="note-file" required>
          <input type="text" id="note-desc" placeholder="Short description (optional)">
          <button type="submit">Upload</button>
        </form>
        <div id="upload-result"></div>
      </section>

      <!-- ðŸ“‚ Notes Section -->
      <section class="panel notes-panel">
        <h2>All Notes</h2>
        <div id="notes" class="notes-list"></div>
      </section>
    </div>
  </main>


  <script>
    const subjectId = new URLSearchParams(window.location.search).get('id');
    const token = localStorage.getItem('token');
    const school = localStorage.getItem('selectedSchool') || 'dlsu';

    // âœ… Update header + logo based on school
    document.addEventListener("DOMContentLoaded", () => {
      const header = document.querySelector(".site-header h1");
      const logoArea = document.querySelector(".logo-area");
      if (header) header.textContent = `${school.toUpperCase()} â€” PROFS TO RATE PH`;
      if (logoArea) {
  const img = document.createElement('img');
  img.className = 'school-logo';
  img.alt = `${school} logo`;
  img.src = `images/${school}-logo.png`;
  img.onerror = () => { img.src = `images/${school}-logo.jpeg`; };

  const link = document.createElement('a');
  link.href = window.location.origin + '/index.html'; // ðŸ‘ˆ this works from subject.html or any page
  link.appendChild(img);

  logoArea.innerHTML = '';
  logoArea.appendChild(link);
}

    });

    // âœ… Always include ?school= parameter in every API call
    async function loadSubject() {
      const res = await fetch(`/api/subjects/${subjectId}?school=${school}`);
      const data = await res.json();

      const subject = data.subject;
      document.getElementById('subject-details').innerHTML = `
        <h2>${subject.code} â€” ${subject.name}</h2>
        <p><strong>Average Difficulty:</strong> ${subject.difficulty_avg?.toFixed(2) || 'N/A'}</p>
      `;

      const notesDiv = document.getElementById('notes');
      if (!data.notes.length) {
        notesDiv.innerHTML = '<p>No notes uploaded yet.</p>';
      } else {
        notesDiv.innerHTML = data.notes.map(n => `
          <div class="note-item">
            <a href="${n.path}" target="_blank">${n.original_name}</a>
            <p>${n.description || ''}</p>
            <small>Uploaded by ${n.display_name || 'Anonymous'} on ${new Date(n.created_at).toLocaleString()}</small>
          </div>
        `).join('');
      }
    }

    // âœ… Include school in upload requests too
    document.getElementById('upload-subject-form').addEventListener('submit', async e => {
      e.preventDefault();
      if (!token) return alert('You must be logged in to upload notes.');

      const file = document.getElementById('note-file').files[0];
      if (!file) return alert('Select a file first.');

      const desc = document.getElementById('note-desc').value;
      const fd = new FormData();
      fd.append('note', file);
      fd.append('subject_id', subjectId);
      fd.append('description', desc);

      const res = await fetch(`/api/upload?school=${school}`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: fd
      });

      const data = await res.json();
      if (data.error) {
        document.getElementById('upload-result').textContent = 'Upload failed: ' + data.error;
      } else {
        document.getElementById('upload-result').innerHTML = `Uploaded! <a href="${data.path}" target="_blank">View note</a>`;
        loadSubject();
      }
    });

    loadSubject();
  </script>

  <script src="js/app.js"></script>
<script>
  function changeSchool() {
    localStorage.removeItem('selectedSchool');
    window.location.href = 'school.html';
  }
</script>
<div id="header-placeholder"></div>

<script>
  // Load shared header dynamically
  document.addEventListener("DOMContentLoaded", async () => {
    const headerContainer = document.getElementById("header-placeholder");
    const res = await fetch("components/header.html");
    const html = await res.text();
    headerContainer.innerHTML = html;

    // Once header is loaded, initialize its JS
    initializeHeader();
  });

  function initializeHeader() {
    const school = localStorage.getItem("selectedSchool") || "dlsu";
    const header = document.querySelector(".site-header h1");
    const logoArea = document.querySelector(".logo-area");

    if (header) {
      header.innerHTML = `${school.toUpperCase()} â€” PHROFSTOPICK<br><span class="business-name"></span>`;
    }

    if (logoArea) {
      const img = logoArea.querySelector(".school-logo");
      img.src = `images/${school}-logo.png`;
      img.onerror = () => { img.src = `images/${school}-logo.jpeg`; };
      img.alt = `${school} logo`;
    }

    // Auth UI setup
    const btnShowLogin = document.getElementById("btn-show-login");
    const btnShowSignup = document.getElementById("btn-show-signup");
    const btnLogout = document.getElementById("btn-logout");
    const userNameSpan = document.getElementById("user-name");

    function updateAuthUI() {
      const token = localStorage.getItem("token");
      if (token) {
        btnShowLogin.style.display = "none";
        btnShowSignup.style.display = "none";
        btnLogout.style.display = "inline-block";
        userNameSpan.style.display = "inline-block";
        userNameSpan.textContent = localStorage.getItem("user_display") || "You";
      } else {
        btnShowLogin.style.display = "inline-block";
        btnShowSignup.style.display = "inline-block";
        btnLogout.style.display = "none";
        userNameSpan.style.display = "none";
      }
    }
    updateAuthUI();

    btnLogout.onclick = () => {
      localStorage.removeItem("token");
      localStorage.removeItem("user_display");
      updateAuthUI();
      alert("Logged out");
    };
  }

  function changeSchool() {
    localStorage.removeItem("selectedSchool");
    window.location.href = "school.html";
  }
</script>

</body>
</html>
