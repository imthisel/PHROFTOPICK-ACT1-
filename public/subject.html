<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Details</title>

  <!-- ✅ Base styles -->
  <link rel="stylesheet" href="css/base.css">

  <!-- ✅ Load school theme dynamically AFTER base -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let school = localStorage.getItem("selectedSchool") || "dlsu";
      const themeLink = document.createElement("link");
      themeLink.rel = "stylesheet";
      themeLink.href = `css/style-${school}.css`;
      document.head.appendChild(themeLink);
    });
  </script>
</head>

<body>
  <!-- ===== HEADER ===== -->
  <div id="header-placeholder"></div>
  <script>
    // ✅ Load the shared header component dynamically
    fetch('components/header.html')
      .then(response => response.text())
      .then(data => {
        document.getElementById('header-placeholder').innerHTML = data;
        initializeHeader(); // uses the global function from app.js
      });
  </script>

  <!-- ===== CONTENT ===== -->
  <main class="subject-page container fade-in">
    <!-- 📘 Subject info -->
    <section id="subject-details" class="subject-card card"></section>

    <div class="subject-content">
      <!-- ✍️ Upload Section -->
      <section class="panel upload-panel">
        <h2>Upload Notes</h2>
        <form id="upload-subject-form" class="upload-form">
          <input type="file" id="note-file" required>
          <input type="text" id="note-desc" placeholder="Short description (optional)">
          <button type="submit">Upload</button>
        </form>
        <div id="upload-result"></div>
      </section>

      <!-- 📂 Notes Section -->
      <section class="panel notes-panel">
        <h2>All Notes</h2>
        <div id="notes" class="notes-list"></div>
      </section>
    </div>
  </main>

  <!-- ===== JS ===== -->
  <script>
    const subjectId = new URLSearchParams(window.location.search).get('id');
    const token = localStorage.getItem('token');
    const school = localStorage.getItem('selectedSchool') || 'dlsu';

    // ✅ Load subject details and notes
    async function loadSubject() {
      const res = await fetch(`/api/subjects/${subjectId}?school=${school}`);
      const data = await res.json();

      const subject = data.subject;
      document.getElementById('subject-details').innerHTML = `
        <h2>${subject.code} — ${subject.name}</h2>
        <p><strong>Average Difficulty:</strong> ${subject.difficulty_avg?.toFixed(2) || 'N/A'}</p>
      `;

      const notesDiv = document.getElementById('notes');
      if (!data.notes.length) {
        notesDiv.innerHTML = '<p>No notes uploaded yet.</p>';
      } else {
        notesDiv.innerHTML = data.notes.map(n => `
          <div class="note-item">
            <a href="${n.path}" target="_blank">${n.original_name}</a>
            <p>${n.description || ''}</p>
            <small>Uploaded by ${n.display_name || 'Anonymous'} on ${new Date(n.created_at).toLocaleString()}</small>
          </div>
        `).join('');
      }
    }

    // ✅ Handle file upload
    document.getElementById('upload-subject-form').addEventListener('submit', async e => {
      e.preventDefault();
      if (!token) return alert('You must be logged in to upload notes.');

      const file = document.getElementById('note-file').files[0];
      if (!file) return alert('Select a file first.');

      const desc = document.getElementById('note-desc').value;
      const fd = new FormData();
      fd.append('note', file);
      fd.append('subject_id', subjectId);
      fd.append('description', desc);

      const res = await fetch(`/api/upload?school=${school}`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: fd
      });

      const data = await res.json();
      if (data.error) {
        document.getElementById('upload-result').textContent = 'Upload failed: ' + data.error;
      } else {
        document.getElementById('upload-result').innerHTML = `Uploaded! <a href="${data.path}" target="_blank">View note</a>`;
        loadSubject();
      }
    });

    loadSubject();
  </script>

  <!-- ✅ Load global app logic -->
  <script src="js/app.js"></script>

  <script>
    function changeSchool() {
      localStorage.removeItem('selectedSchool');
      window.location.href = 'school.html';
    }
  </script>
</body>
</html>
