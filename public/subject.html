<!DOCTYPE html>
<html lang="en">
<head>
  <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subject Details</title>

  <!-- ‚úÖ Load base styles first -->
  <link rel="stylesheet" href="css/base.css">

  <!-- ‚úÖ Load school theme dynamically AFTER base -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let school = localStorage.getItem("selectedSchool") || "dlsu";
      const themeLink = document.createElement("link");
      themeLink.rel = "stylesheet";
      themeLink.href = `css/style-${school}.css`;
      document.head.appendChild(themeLink);
      console.log("üé® Loaded theme:", themeLink.href);
    });
  </script>
</head>

</head>
<body>
  <header class="site-header">
    <div class="logo-area"></div>
    <h1></h1>
    <!-- üëá Replaced Home link with a clean Back to Home button -->
    <a href="index.html" class="back-home-btn">‚Üê Back to Home</a>
  </header>

  <main class="subject-page container fade-in">
    <!-- üìò Subject info -->
    <section id="subject-details" class="subject-card card">
      <!-- Content filled dynamically -->
    </section>

    <div class="subject-content">
      <!-- ‚úçÔ∏è Upload Section -->
      <section class="panel upload-panel">
        <h2>Upload Notes</h2>
        <form id="upload-subject-form" class="upload-form">
          <input type="file" id="note-file" required>
          <input type="text" id="note-desc" placeholder="Short description (optional)">
          <button type="submit">Upload</button>
        </form>
        <div id="upload-result"></div>
      </section>

      <!-- üìÇ Notes Section -->
      <section class="panel notes-panel">
        <h2>All Notes</h2>
        <div id="notes" class="notes-list"></div>
      </section>
    </div>
  </main>


  <script>
    const subjectId = new URLSearchParams(window.location.search).get('id');
    const token = localStorage.getItem('token');
    const school = localStorage.getItem('selectedSchool') || 'dlsu';

    // ‚úÖ Update header + logo based on school
    document.addEventListener("DOMContentLoaded", () => {
      const header = document.querySelector(".site-header h1");
      const logoArea = document.querySelector(".logo-area");
      if (header) header.textContent = `${school.toUpperCase()} ‚Äî PROFS TO RATE PH`;
      if (logoArea) {
  const img = document.createElement('img');
  img.className = 'school-logo';
  img.alt = `${school} logo`;
  img.src = `images/${school}-logo.png`;
  img.onerror = () => { img.src = `images/${school}-logo.jpeg`; };

  const link = document.createElement('a');
  link.href = window.location.origin + '/index.html'; // üëà this works from subject.html or any page
  link.appendChild(img);

  logoArea.innerHTML = '';
  logoArea.appendChild(link);
}

    });

    // ‚úÖ Always include ?school= parameter in every API call
    async function loadSubject() {
      const res = await fetch(`/api/subjects/${subjectId}?school=${school}`);
      const data = await res.json();

      const subject = data.subject;
      document.getElementById('subject-details').innerHTML = `
        <h2>${subject.code} ‚Äî ${subject.name}</h2>
        <p><strong>Average Difficulty:</strong> ${subject.difficulty_avg?.toFixed(2) || 'N/A'}</p>
      `;

      const notesDiv = document.getElementById('notes');
      if (!data.notes.length) {
        notesDiv.innerHTML = '<p>No notes uploaded yet.</p>';
      } else {
        notesDiv.innerHTML = data.notes.map(n => `
          <div class="note-item">
            <a href="${n.path}" target="_blank">${n.original_name}</a>
            <p>${n.description || ''}</p>
            <small>Uploaded by ${n.display_name || 'Anonymous'} on ${new Date(n.created_at).toLocaleString()}</small>
          </div>
        `).join('');
      }
    }

    // ‚úÖ Include school in upload requests too
    document.getElementById('upload-subject-form').addEventListener('submit', async e => {
      e.preventDefault();
      if (!token) return alert('You must be logged in to upload notes.');

      const file = document.getElementById('note-file').files[0];
      if (!file) return alert('Select a file first.');

      const desc = document.getElementById('note-desc').value;
      const fd = new FormData();
      fd.append('note', file);
      fd.append('subject_id', subjectId);
      fd.append('description', desc);

      const res = await fetch(`/api/upload?school=${school}`, {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token },
        body: fd
      });

      const data = await res.json();
      if (data.error) {
        document.getElementById('upload-result').textContent = 'Upload failed: ' + data.error;
      } else {
        document.getElementById('upload-result').innerHTML = `Uploaded! <a href="${data.path}" target="_blank">View note</a>`;
        loadSubject();
      }
    });

    loadSubject();
  </script>
</body>
</html>
